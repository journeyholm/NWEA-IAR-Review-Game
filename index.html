<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic ELA Assessment-Prep Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<style>
        /* --- ANIMATED BACKGROUND --- */
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            /* FIX: Prevents double-tap zoom and improves mobile feel */
            touch-action: manipulation; 
        }
        .dark body {
            background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #533483);
            background-size: 400% 400%;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- GLASSMORPHISM UI --- */
        .game-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        /* FIX: Ensure question area is visible on small screens */
        #game-questions-area {
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: none;
            /* Prevents blue highlight on mobile tap */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fixed Headers for Readability */
        #shop-screen h2, #missions-screen h2, #progress-screen h2, #review-screen h2,
        #calibration-screen h2, #game-play-screen h2, #boss-round-screen h2 {
            padding-left: 1rem;
            color: #111827 !important;
        }
        
        .dark #shop-screen h2, .dark #missions-screen h2, .dark #progress-screen h2, 
        .dark #review-screen h2, .dark #calibration-screen h2, .dark #game-play-screen h2, 
        .dark #boss-round-screen h2 {
            color: #ffffff !important;
        }

        .hot-text-word { display: inline-block; margin: 0 2px; padding: 2px 4px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; }
        .hot-text-word.selected { background-color: #3b82f6; color: white; }
    </style>
</head>

<div id="welcome-screen" class="screen flex flex-col items-center justify-start text-center px-4 md:px-8 pb-8 pt-8 min-h-[60vh] relative">

    <div class="w-full max-w-5xl mx-auto flex flex-col md:flex-row justify-center items-center gap-12 bg-white/60 dark:bg-gray-800/60 backdrop-blur-lg border border-white/40 p-4 rounded-3xl shadow-lg mb-12">
        
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="relative group">
                <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg border-2 border-white dark:border-gray-700 transform transition group-hover:scale-110">
                    <span id="main-level-display">1</span>
                </div>
                <div class="absolute -bottom-2 -right-2 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-2 py-0.5 rounded-full border border-white shadow-sm">LVL</div>
            </div>

            <div class="flex flex-col items-start flex-grow">
                <div class="flex justify-between w-full text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wider">
                    <span>Experience</span>
                    <span id="main-xp-current-display"><span id="main-xp-current">0</span> / 100 XP</span>
                </div>
                <div class="w-48 h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner border border-black/5">
                    <div id="main-xp-bar" class="bg-gradient-to-r from-blue-400 to-indigo-500 h-full rounded-full transition-all duration-500 relative" style="width: 0%">
                        <div class="absolute top-0 left-0 w-full h-full bg-white/20 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 bg-yellow-100 dark:bg-yellow-900/40 px-4 py-2 rounded-xl border border-yellow-200 dark:border-yellow-700/50 shadow-sm">
                <span class="text-xl">ü™ô</span> 
                <div class="flex flex-col items-start leading-none">
                    <span id="main-token-display" class="font-bold text-yellow-800 dark:text-yellow-100 text-lg">0</span>
                    <span class="text-[10px] font-bold text-yellow-600 dark:text-yellow-400 uppercase">Tokens</span>
                </div>
            </div>

            <button id="theme-toggle-header" onclick="document.getElementById('theme-toggle').click()" class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </div>

    <h1 class="text-5xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-400 dark:via-purple-400 dark:to-pink-400 mb-2 drop-shadow-sm tracking-tight">ELA LEGENDS</h1>
        
        <div class="bg-white/60 dark:bg-black/40 backdrop-blur-md py-3 px-8 rounded-full shadow-sm mb-10 border border-white/20">
            <p class="text-xl md:text-2xl text-slate-900 dark:text-white font-bold">Master reading, writing, and logic to defeat the Glitch.</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl mb-8">
            <button id="start-calibration-button" class="button bg-gradient-to-br from-blue-500 to-blue-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-blue-400/20">
                <span class="text-3xl block mb-2">üßô‚Äç‚ôÇÔ∏è</span>Calibration Quest
            </button>
            <button onclick="startSurvival()" class="button bg-gradient-to-br from-red-600 to-orange-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-red-400/20 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-1 bg-black/20 rounded-bl-lg text-xs font-mono">HARDCORE</div>
                <span class="text-3xl block mb-2">üíÄ</span>The Gauntlet
            </button>
            <button id="missions-button" class="button bg-gradient-to-br from-emerald-500 to-emerald-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-emerald-400/20">
                <span class="text-3xl block mb-2">üìú</span>Daily Missions
            </button>
            <button id="shop-button" class="button bg-gradient-to-br from-amber-400 to-orange-600 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-amber-400/20">
                <span class="text-3xl block mb-2">üõçÔ∏è</span>The Shop
            </button>
            <button id="progress-button" class="button bg-gradient-to-br from-violet-500 to-purple-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-violet-400/20">
                <span class="text-3xl block mb-2">üìí</span>My Sticker Book
            </button>
            <button onclick="generateReport()" class="button bg-gradient-to-br from-slate-600 to-slate-800 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-slate-500/20">
                <span class="text-3xl block mb-2">üñ®Ô∏è</span>Teacher Report
            </button>
            <button id="archive-button" onclick="openArchive()" class="col-span-1 md:col-span-2 button bg-gradient-to-r from-red-600 to-rose-600 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-red-400/20 flex flex-col md:flex-row items-center justify-center gap-4 relative overflow-hidden group">
                 <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                 <span class="text-4xl animate-pulse">‚ö†Ô∏è</span> 
                 <span>Glitch Archive (Fix Mistakes & Study)</span>
            </button>
        </div>
        
<button id="reset-button" onclick="if(confirm('Are you sure? This deletes all progress!')) resetGame()" class="mt-8 text-gray-500 hover:text-red-500 text-sm font-semibold transition-colors bg-white/50 px-4 py-2 rounded-lg">Reset Save Data</button>    </div>

<div id="calibration-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-white shadow-md hover:bg-gray-100 transition-colors z-50">
                <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>

            <h2 class="text-3xl md:text-4xl font-bold mb-4 relative z-10">Calibration Quest</h2>

            <div class="inline-block bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm border border-white/40 rounded-lg px-4 py-2 mb-6 shadow-sm">
                <p class="text-slate-900 dark:text-gray-100 font-semibold text-lg">
                    Answer these questions to determine your starting level.
                </p>
            </div>

            <div id="calibration-content" class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-inner">
                <div id="question-area"></div>
                <div id="message-box" class="mt-4 p-4 rounded-lg hidden"></div>
                <div class="flex justify-end mt-6">
                    <button id="submit-answer-button" class="button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Submit Answer</button>
                </div>
            </div>
            <div id="calibration-results" class="hidden text-center mt-8">
                <h3 class="text-3xl font-bold text-green-600 dark:text-green-400 mb-4">Quest Complete!</h3>
                <p class="text-xl text-gray-700 dark:text-gray-300 mb-4">Your calibrated ELA level is: <span id="ela-level-display" class="font-extrabold text-blue-600 dark:text-blue-400"></span></p>
                <button id="start-missions-button" class="button bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Start Daily Missions üöÄ</button>
            </div>
        </div>



        <div id="missions-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Daily Missions Hub</h2>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Your current ELA proficiency level: <span id="proficiency-display" class="font-bold text-indigo-500"></span></p>
            <div id="missions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
        
<div id="game-play-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute z-10 p-3 rounded-full transition-transform hover:rotate-90">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 pl-12">
                <h2 id="game-title" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white drop-shadow-sm">Mission Title</h2>
                <div class="mt-4 md:mt-0 bg-white dark:bg-gray-800 px-6 py-2 rounded-full shadow-lg border border-gray-100 dark:border-gray-700">
<div class="flex items-center gap-6">
    <div class="flex items-center gap-2 text-amber-600 dark:text-amber-400 font-mono text-xl font-bold bg-amber-100 dark:bg-amber-900/50 px-3 py-1 rounded-lg border border-amber-200 dark:border-amber-700">
        <span>‚è±Ô∏è</span>
        <span id="game-timer">00:00</span>
    </div>

    <p class="text-lg font-bold text-indigo-600 dark:text-indigo-400">
        Score: <span id="mission-score-display" class="text-2xl">0</span>
        <span class="text-gray-400 mx-2">/</span>
        <span id="mission-total-questions">0</span>
    </p>
</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="game-passage" class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-md rounded-2xl p-8 shadow-xl border border-white/20 text-lg leading-relaxed font-serif text-gray-800 dark:text-gray-200 h-fit">
                    </div>

                <div class="flex flex-col">
                    <div id="game-questions-area" class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-2xl border-t-8 border-indigo-500 flex-grow">
                        </div>
                    
                    <div class="mt-6 flex justify-end gap-4">
                        </div>
                </div>
            </div>
            <div id="game-feedback-area" class="mt-6"></div>
        </div>

        <div id="shop-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">The Shop</h2>
            <div class="flex justify-between items-center mb-6 p-4 rounded-lg bg-yellow-100 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-700">
                <p class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">Your Tokens: <span id="token-display" class="font-extrabold text-yellow-900 dark:text-yellow-100">0</span> üí∞</p>
            </div>
            <div id="shop-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="progress-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">My Progress</h2>

<div class="mt-8">
                <h3 class="text-2xl font-bold mb-4">Mission History</h3>
                <table id="mission-history-table" class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-700">
                            <th class="p-4 rounded-tl-lg">Mission</th>
                            <th class="p-4">Score</th>
                            <th class="p-4">Date</th>
                            <th class="p-4">Tokens</th>
                            <th class="p-4 rounded-tr-lg">XP</th>
                        </tr>
                    </thead>
                    <tbody id="mission-history-body"></tbody>
                </table>
            </div>
        </div>

        <div id="review-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Mission Review</h2>
            <div id="review-content" class="space-y-8"></div>
        </div>

        <div id="boss-round-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10">
                <svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>
            <div class="flex flex-col items-center mb-6">
                <h2 class="text-4xl font-extrabold text-red-600 dark:text-red-500 mb-2">BOSS BATTLE: The Glitch</h2>
                <p class="text-gray-600 dark:text-gray-300">Fix the errors to defeat the Boss!</p>
                
                <div class="w-full max-w-3xl grid grid-cols-2 gap-8 mt-4">
                    <div class="text-center">
                        <p class="font-bold text-blue-600 dark:text-blue-400">YOU (Editor)</p>
                        <div class="w-full bg-gray-300 h-6 rounded-full overflow-hidden border-2 border-gray-400">
                            <div id="player-hp-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="font-bold text-red-600 dark:text-red-400">THE GLITCH</p>
                        <div class="w-full bg-gray-300 h-6 rounded-full overflow-hidden border-2 border-gray-400">
                            <div id="boss-hp-bar" class="bg-red-500 h-full transition-all duration-500" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="boss-battle-area" class="bg-white dark:bg-gray-800 rounded-xl p-8 shadow-2xl border-4 border-red-500 relative max-w-4xl mx-auto">
                <div id="boss-text-display" class="text-lg md:text-xl leading-relaxed font-serif">
                    </div>
            </div>

            <div id="editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform scale-100 transition-transform">
                    <h3 class="text-xl font-bold mb-4">How should this be written?</h3>
                    <div id="editor-options" class="space-y-3">
                        </div>
                    <button id="close-editor-modal" class="mt-4 text-gray-500 hover:text-gray-700 underline text-sm w-full text-center">Cancel</button>
                </div>
            </div>
        </div>
        
    </div>

<div id="archive-screen" class="screen hidden p-4 md:p-8 relative">
        <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-white shadow-md hover:bg-gray-100 transition-colors z-50">
            <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
        </button>
        <h2 class="text-3xl md:text-4xl font-bold mb-2 relative z-10 text-red-600 dark:text-red-400">‚ö†Ô∏è Glitch Archive</h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6 bg-white/50 dark:bg-gray-800/50 p-2 rounded inline-block">Study the skills and fix the corrupted files to earn XP!</p>
        
        <div id="archive-list" class="grid grid-cols-1 gap-6 max-w-3xl mx-auto"></div>
        
        <div id="archive-empty-msg" class="hidden text-center mt-12 bg-white/40 dark:bg-black/20 p-8 rounded-2xl border border-white/50">
            <div class="text-6xl mb-4">‚ú®</div>
            <h3 class="text-2xl font-bold text-gray-700 dark:text-gray-300">System Clean!</h3>
            <p class="text-gray-500">No glitches detected. You've mastered everything!</p>
            <button onclick="navigate('welcome-screen')" class="mt-4 bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-indigo-600">Return to Base</button>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-box" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center relative transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modal-title" class="text-2xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-4"></p>
            <button id="modal-ok-btn" class="button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

   <script>
// --- AUDIO SYSTEM (DISABLED) ---
        function playSound(type) { /* Sound removed by user request */ }

// --- Game State ---
        let gameState = {
            currentScreen: 'welcome',
            currentMission: null,
            currentQuestionIndex: 0,
            missionScore: 0,
            missionHistoryData: [], 
            streak: 0,
            // --- NEW: AI Classmates to compete against ---
            rivals: [
                { name: "Hermione G.", xp: 450, avatar: "üìö" },
                { name: "Percy J.", xp: 320, avatar: "üåä" },
                { name: "Katniss E.", xp: 600, avatar: "üèπ" },
                { name: "Miles M.", xp: 150, avatar: "üï∑Ô∏è" }
            ],
            user: {
                xp: 0,
                level: 1,
                elaLevel: 0,
                tokens: 0,
                badges: [],
                history: [],
                purchasedItems: [],
                stickers: []
            }
        };
// --- NEW: TIMER LOGIC ---
let missionTimerInterval;
let missionSeconds = 0;

function startTimer() {
    missionSeconds = 0;
    const display = document.getElementById('game-timer');
    clearInterval(missionTimerInterval);

    missionTimerInterval = setInterval(() => {
        missionSeconds++;
        const mins = Math.floor(missionSeconds / 60).toString().padStart(2, '0');
        const secs = (missionSeconds % 60).toString().padStart(2, '0');
        if(display) display.textContent = `${mins}:${secs}`;
    }, 1000);
}

function stopTimer() {
    clearInterval(missionTimerInterval);
    return missionSeconds;
}
        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalBox = document.getElementById('modal-box');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        // Calibration
        const calibrationContent = document.getElementById('calibration-content');
        const questionArea = document.getElementById('question-area');
        const messageBox = document.getElementById('message-box');
        const submitButton = document.getElementById('submit-answer-button');
        const calibrationResults = document.getElementById('calibration-results');
        const elaLevelDisplay = document.getElementById('ela-level-display');
        
        // Missions
        const missionsList = document.getElementById('missions-list');
        const gamePlayScreen = document.getElementById('game-play-screen');
        const gameTitle = document.getElementById('game-title');
        const gamePassage = document.getElementById('game-passage');
        const gameQuestionsArea = document.getElementById('game-questions-area');
        const nextQuestionButton = document.getElementById('next-question-button');
        const finishMissionButton = document.getElementById('finish-mission-button');
        const gameFeedbackArea = document.getElementById('game-feedback-area');
        const missionScoreDisplay = document.getElementById('mission-score-display');
        const missionTotalQuestions = document.getElementById('mission-total-questions');
        const proficiencyDisplay = document.getElementById('proficiency-display');
        
        // Progress & Shop
        const levelDisplay = document.getElementById('level-display');
        const xpDisplay = document.getElementById('xp-display');
        const xpBar = document.getElementById('xp-bar');
        const badgesDisplay = document.getElementById('badges-display');
        const missionHistoryBody = document.getElementById('mission-history-body');
        const tokenDisplay = document.getElementById('token-display');
        const shopItemsList = document.getElementById('shop-items-list');
        const reviewContent = document.getElementById('review-content');


// --- Game Data (Item Bank) ---
// --- STICKER COLLECTIONS DATA ---

const stickerCollections = {
    mythic: {
        name: "Mythic Set",
        items: ['üêâ','üßô‚Äç‚ôÇÔ∏è','üè∞','ü¶Ñ','‚öîÔ∏è','üõ°Ô∏è','üîÆ','üëë']
    },
    space: {
        name: "Cosmic Set",
        items: ['üöÄ','üëΩ','ü™ê','‚òÑÔ∏è','üë®‚ÄçüöÄ','üî≠','üõ∏','‚≠ê']
    },
    literature: {
        name: "Lit Legends",
        items: ['üìñ','üñãÔ∏è','üìú','üïØÔ∏è','üëì','üé≠','üßõ','üïµÔ∏è‚Äç‚ôÇÔ∏è']
    },
    animals: {
        name: "Wild Kingdom",
        items: ['ü¶Å','üêò','üê∏','ü¶ã','ü¶à','üêº','ü¶â','ü¶ä']
    },
    // --- NEW COLLECTIONS ---
    foodie: {
        name: "Snack Attack",
        items: ['üçï','üçî','üçü','üç£','üç©','üç¶','ü•ë','üåÆ']
    },
    sports: {
        name: "MVP Sports",
        items: ['‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','ü•ä','üèÜ']
    },
    music: {
        name: "Rock Star",
        items: ['üé∏','üéπ','ü•Å','üé∑','üé∫','üé§','üéß','üéº']
    },
    travel: {
        name: "World Traveler",
        items: ['‚úàÔ∏è','üóΩ','üóº','üèùÔ∏è','‚õ∞Ô∏è','‚õ∫','üó∫Ô∏è','üóø']
    }
};

// --- UPDATED: RETEACH MINI-LESSONS (The Tutor) ---
const skillLessons = {
    // --- VOCABULARY ---
    'L.8.4.b': "<b>Greek & Latin Roots:</b> 'Bene' means Good (benefit). 'Mal' means Bad (malfunction). 'Spect' means Look (inspect). Memorize these to decode unknown words.",
    'L.8.5.b': "<b>Analogies:</b> Look for the relationship! Is it Part-to-Whole (Chapter : Book)? Tool-to-User (Microscope : Biologist)? Synonym/Antonym? Match that exact relationship.",
    
    // --- GRAMMAR ---
    'L.8.1.c': "<b>Verb Moods:</b> <br>‚Ä¢ <i>Indicative:</i> A fact (The sky is blue).<br>‚Ä¢ <i>Imperative:</i> A command (Go away).<br>‚Ä¢ <i>Subjunctive:</i> A wish or 'what if' (If I were you...).<br>‚Ä¢ <i>Interrogative:</i> A question.",
    'L.8.3.a': "<b>Active vs. Passive Voice:</b> <br>‚Ä¢ <i>Active:</i> The subject DOES the action (The boy kicked the ball).<br>‚Ä¢ <i>Passive:</i> The action happens TO the subject (The ball was kicked by the boy). Active is usually stronger!",
    'SAT.Convention.1': "<b>Sentence Boundaries:</b> Watch out for Run-Ons! You cannot connect two complete sentences with just a comma. Use a period, a semicolon (;), or a comma + conjunction (FANBOYS).",

'L.8.2.a': "<b>Punctuation (Ellipses & Dashes):</b> <br>‚Ä¢ Use an <b>Ellipsis (...)</b> to show a pause or omitted words.<br>‚Ä¢ Use a <b>Dash (‚Äî)</b> to show a sudden break, interruption, or to emphasize extra info.",
    'L.8.2.c': "<b>Confused Words:</b> <br>‚Ä¢ <i>Effect</i> is usually a Noun (The result).<br>‚Ä¢ <i>Affect</i> is usually a Verb (To change).<br>‚Ä¢ <i>Principal</i> is your pal (Person). <i>Principle</i> is a rule.",
    'RI.8.6': "<b>Point of View:</b> Does the author agree or disagree with the topic? Look for 'charged' words (e.g., 'disastrous' vs. 'innovative') to find their true opinion.",
    // --- READING LITERATURE ---
    'RL.8.6': "<b>Irony & Suspense:</b> <br>‚Ä¢ <i>Situational Irony:</i> The opposite of what you expect happens (e.g., a fire station burns down).<br>‚Ä¢ <i>Suspense:</i> Authors use short sentences, silence, and sensory details (heartbeat, creaking) to build tension.",
    'RL.9.3': "<b>Character Motivation:</b> Why did they do that? Look for the internal desire (revenge, love, fear) that drives the external action.",
    'RL.8.4': "<b>Metaphor & Simile:</b> A Simile uses 'like' or 'as' (Fast as a cheetah). A Metaphor says one thing IS another (Life is a highway).",

    // --- READING INFORMATIONAL ---
    'RI.8.8': "<b>Evaluating Arguments:</b> Does the author have PROOF? Look for statistics, studies, and expert quotes. Beware of 'Anecdotal Evidence' (just one person's story).",
    'RI.8.2': "<b>Central Idea:</b> What is the 'Big Picture'? Read the first and last sentence of the passage. The title is also a huge clue!",
    'RI.8.5': "<b>Text Structure:</b> How is it built?<br>‚Ä¢ <i>Compare/Contrast:</i> similarities/differences.<br>‚Ä¢ <i>Problem/Solution:</i> Explains an issue and how to fix it.<br>‚Ä¢ <i>Chronological:</i> Time order.",
    'W.8.8': "<b>Research Credibility:</b> Trust experts (.edu, .gov, organizations), not random blogs. Check the date: is the info current?",

    'RL.8.4.sound': "<b>Sound Devices:</b> <br>‚Ä¢ <i>Alliteration:</i> Repeated beginning sounds (Peter Piper picked).<br>‚Ä¢ <i>Assonance:</i> Repeated VOWEL sounds inside words (The r<b>ai</b>n in Sp<b>ai</b>n).",
    'RI.8.8.eval': "<b>Evidence Strength:</b> <br>‚Ä¢ <i>Relevant:</i> Directly supports the claim.<br>‚Ä¢ <i>Irrelevant:</i> Off-topic.<br>‚Ä¢ <i>Sufficient:</i> Is there ENOUGH proof, or just one example?",

    'W.8.2.c': "<b>Sentence Placement:</b> Good writing flows logically. <br>‚Ä¢ Look for <i>transition words</i> (However, Therefore).<br>‚Ä¢ Look for <i>pronouns</i> (It, He, They) referring to a previous noun.<br>‚Ä¢ Keep 'Time' and 'Action' in order.",
    'RL.8.9': "<b>Modern vs. Traditional:</b> Authors often retell old myths in modern settings.<br>‚Ä¢ Look for matching <i>character traits</i> (e.g., a strong warrior becomes a quarterback).<br>‚Ä¢ Look for similar <i>conflicts</i> or <i>themes</i>.",
    'L.8.4.a': "<b>Context Clues (Academic):</b> When you see a tough 'Science' or 'History' word, look at the sentences <i>around</i> it. Is there a definition, an example, or a contrast word (unlike, but) nearby?",
};

// ======================================================
// üöÄ MASTER CONTENT DATABASE (NWEA + SAT + STORY)
// ======================================================

// ======================================================
// üöÄ THE MEGA MASTER ITEM BANK: 800% CONTENT BOOST
// ======================================================

const itemBank = [
    // --- SECTION 1: CALIBRATION QUEST (DIAGNOSTICS) ---
    {
        type: 'calibration', id: 'cal-intro',
        passage: "The Industrial Revolution was a period of scientific and commercial innovation that changed the world. However, it also led to overcrowded cities and poor working conditions for many.",
        items: [{
            id: 'cal-1', type: 'MC', standard: 'RI.8.1', difficulty: 3,
            stem: 'Which statement is best supported by the passage?',
            options: ['The Industrial Revolution only had positive effects.', 'Innovation came at a social cost.', 'Scientific progress stopped during this era.', 'Cities became less populated.'],
            correct_answer: 'Innovation came at a social cost.',
            rationale: 'The passage mentions "poor working conditions," indicating a social cost.'
        }]
    },
    {
        type: 'calibration', id: 'cal-mid',
        passage: "Maya felt a sense of <b>melancholy</b> as she watched the last leaves of autumn fall. The vibrant greens of summer were now just a memory, replaced by a grey, biting wind.",
        items: [{
            id: 'cal-2', type: 'MC', standard: 'L.8.4.a', difficulty: 5,
            stem: 'What is the most likely meaning of "melancholy" as used in the text?',
            options: ['Extreme excitement', 'A quiet sadness', 'Physical exhaustion', 'Sudden anger'],
            correct_answer: 'A quiet sadness',
            rationale: 'Contextual clues like "grey winds" and fading memories suggest sadness.'
        }]
    },
    {
        type: 'calibration', id: 'cal-high',
        passage: "Proponents of renewable energy argue that infrastructure costs are offset by environmental health. Conversely, critics maintain that the grid is not yet equipped to handle variable wind and solar power.",
        items: [{
            id: 'cal-3', type: 'MC', standard: 'RI.8.8', difficulty: 8,
            stem: 'How does the author structure the argument in this passage?',
            options: ['By providing a solution to a technical problem.', 'By comparing two conflicting viewpoints.', 'By using a chronological history.', 'By dismissing the concerns of critics.'],
            correct_answer: 'By comparing two conflicting viewpoints.',
            rationale: 'The use of "Proponents argue" vs "Conversely, critics maintain" shows comparison.'
        }]
    },

    // --- SECTION 2: TIER 1 - ROOKIE (DIFFICULTY 1-3) ---
    {
        type: 'mission', genre: 'info_history',
        passage: "The Pony Express delivered mail between the Atlantic and Pacific coasts in about 10 days using horse-mounted riders.",
        items: [{
            id: 'rok-hist-1', type: 'MC', standard: 'RI.8.1', difficulty: 2,
            stem: 'What was the primary achievement of the Pony Express?',
            options: ['Cheapest mail service.', 'Reduced travel time for mail.', 'Riders owned their horses.', 'Delivered only to the Pacific.'],
            correct_answer: 'Reduced travel time for mail.',
            rationale: 'It cut delivery time to 10 days.'
        }]
    },
    {
        type: 'mission', genre: 'grammar_basics',
        passage: "She <b>walked</b> to the store, <b>buys</b> a loaf of bread, and <b>returned</b> home.",
        items: [{
            id: 'rok-gram-1', type: 'MC', standard: 'L.8.1', difficulty: 3,
            stem: 'Which word breaks the consistent verb tense?',
            options: ['walked', 'buys', 'returned', 'store'],
            correct_answer: 'buys',
            rationale: 'Buys is present tense; others are past tense.'
        }]
    },
    {
        type: 'mission', genre: 'lit_poetry',
        passage: "The fog comes / on little cat feet. / It sits looking / over harbor and city.",
        items: [{
            id: 'rok-poet-1', type: 'MC', standard: 'RL.8.4', difficulty: 2,
            stem: 'What is the fog being compared to?',
            options: ['A silent haunch', 'A harbor', 'A cat', 'A storm'],
            correct_answer: 'A cat',
            rationale: 'The metaphor "cat feet" draws a direct comparison.'
        }]
    },
    {
        type: 'mission', genre: 'info_science',
        passage: "Pollination is the act of transferring pollen grains to create offspring for the next generation.",
        items: [{
            id: 'rok-sci-2', type: 'MC', standard: 'RI.8.2', difficulty: 3,
            stem: 'What is the central idea?',
            options: ['Bees are necessary.', 'Pollination is key for plant reproduction.', 'Plants avoid offspring.', 'Anthers are large.'],
            correct_answer: 'Pollination is key for plant reproduction.',
            rationale: 'The text links pollination directly to creating the next generation.'
        }]
    },
    {
        type: 'mission', genre: 'lit_fable',
        passage: "The tortoise moved slowly but surely, never stopping to rest, while the hare took a nap mid-race.",
        items: [{
            id: 'rok-lit-3', type: 'MC', standard: 'RL.8.2', difficulty: 2,
            stem: 'What is the most likely theme of this story?',
            options: ['Speed is everything.', 'Persistence leads to success.', 'Sleeping is healthy.', 'Racing is dangerous.'],
            correct_answer: 'Persistence leads to success.',
            rationale: 'The tortoise wins because he is steady and persistent.'
        }]
    },
    {
        type: 'mission', genre: 'info_nature',
        passage: "Deserts receive very little rainfall, yet many animals like the fennec fox have adapted to survive in extreme heat.",
        items: [{
            id: 'rok-sci-3', type: 'MC', standard: 'RI.8.1', difficulty: 3,
            stem: 'What does the text imply about fennec foxes?',
            options: ['They hate rain.', 'They have traits that help them in hot weather.', 'They are the only desert animals.', 'They prefer cold climates.'],
            correct_answer: 'They have traits that help them in hot weather.',
            rationale: 'The text states they "adapted to survive in extreme heat."'
        }]
    },
    {
        type: 'mission', genre: 'grammar_punctuation',
        passage: "The student's books were scattered across the floor.",
        items: [{
            id: 'rok-gram-2', type: 'MC', standard: 'L.8.2', difficulty: 2,
            stem: 'Why is an apostrophe used in the word "student\'s"?',
            options: ['To show plural.', 'To show possession.', 'To show a contraction.', 'To show an exclamation.'],
            correct_answer: 'To show possession.',
            rationale: 'The apostrophe indicates the books belong to the student.'
        }]
    },
    {
        type: 'mission', genre: 'info_health',
        passage: "Washing your hands is the most effective way to prevent the spread of germs and stay healthy.",
        items: [{
            id: 'rok-info-2', type: 'MC', standard: 'RI.8.1', difficulty: 1,
            stem: 'What is the main benefit of hand washing according to the text?',
            options: ['It makes hands smell good.', 'It prevents germs from spreading.', 'It uses a lot of water.', 'It takes a long time.'],
            correct_answer: 'It prevents germs from spreading.',
            rationale: 'The text states it is the most effective way to prevent the spread of germs.'
        }]
    },

    // --- SECTION 3: TIER 2 - SCHOLAR (DIFFICULTY 4-7) ---
    {
        type: 'mission', genre: 'info_social',
        passage: "Urbanization leads to the 'Heat Island Effect.' Buildings and roads absorb more heat than natural landscapes.",
        items: [{
            id: 'sch-soc-1', type: 'MC', standard: 'RI.8.3', difficulty: 5,
            stem: 'Identify the cause-and-effect relationship.',
            options: ['Cities melt roads.', 'Rural areas cool buildings.', 'Infrastructure absorption causes higher heat.', 'Heat increases population.'],
            correct_answer: 'Infrastructure absorption causes higher heat.',
            rationale: 'Heat absorption by roads/buildings causes the temperature spike.'
        }]
    },
    {
        type: 'mission', genre: 'lit_prose',
        passage: "Behind him lay the safety of the village; before him lay the <b>formidable</b> peaks of the Unseen Mountains.",
        items: [{
            id: 'sch-lit-1', type: 'MC', standard: 'L.8.4', difficulty: 6,
            stem: 'What does "formidable" suggest about the mountains?',
            options: ['Easy to climb.', 'Small.', 'Beautiful.', 'Intimidating and challenging.'],
            correct_answer: 'Intimidating and challenging.',
            rationale: 'Contextual danger (howling winds/abyss) supports "intimidating."'
        }]
    },
    {
        type: 'mission', genre: 'grammar_logic',
        passage: "The judge's decision was <b>arbitrary</b>; he seemed to choose the winner based on his mood rather than the rules.",
        items: [{
            id: 'sch-gram-1', type: 'MC', standard: 'L.8.4', difficulty: 6,
            stem: 'What does "arbitrary" mean in this context?',
            options: ['Carefully planned.', 'Based on random choice.', 'Legally binding.', 'Highly respected.'],
            correct_answer: 'Based on random choice.',
            rationale: 'The text states he used "mood" rather than "rules."'
        }]
    },
    {
        type: 'mission', genre: 'info_tech',
        passage: "If data contains human bias, AI will <b>perpetuate</b> those prejudices in its results.",
        items: [{
            id: 'sch-tech-1', type: 'MC', standard: 'RI.8.1', difficulty: 7,
            stem: 'Summarize the warning about AI.',
            options: ['AI is smarter than humans.', 'AI can continue human biases.', 'Datasets eliminate human input.', 'Prejudices are intentional.'],
            correct_answer: 'AI can continue human biases.',
            rationale: 'The word "perpetuate" means to continue the existing bias.'
        }]
    },
    {
        type: 'mission', genre: 'lit_mystery',
        passage: "Detective Vance examined the <b>scant</b> evidence: a single muddy footprint and a broken latch.",
        items: [{
            id: 'sch-lit-2', type: 'MC', standard: 'L.8.4', difficulty: 5,
            stem: 'What does the word "scant" imply about the evidence?',
            options: ['There was a large amount.', 'It was very confusing.', 'There was very little of it.', 'It was clearly planted.'],
            correct_answer: 'There was very little of it.',
            rationale: 'The mention of only a footprint and a latch indicates a small amount.'
        }]
    },
    {
        type: 'mission', genre: 'info_ecology',
        passage: "Wetlands act as natural filters, trapping pollutants before they reach larger bodies of water.",
        items: [{
            id: 'sch-sci-1', type: 'MC', standard: 'RI.8.2', difficulty: 5,
            stem: 'What is the primary function of wetlands described here?',
            options: ['To provide a home for fish.', 'To clean water by filtering pollutants.', 'To cause flooding in rural areas.', 'To create bodies of water.'],
            correct_answer: 'To clean water by filtering pollutants.',
            rationale: 'The text explicitly states they "trap pollutants."'
        }]
    },
    {
        type: 'mission', genre: 'lit_analysis_mid',
        passage: "The protagonist's journey mirrors the changing seasons, beginning in the hopeful spring and ending in the cold, reflective winter.",
        items: [{
            id: 'sch-lit-3', type: 'MC', standard: 'RL.8.3', difficulty: 6,
            stem: 'How does the setting contribute to the character development?',
            options: ['It shows the character likes cold weather.', 'It symbolizes the character\'s growth and aging.', 'It has no effect on the character.', 'It makes the character want to travel.'],
            correct_answer: 'It symbolizes the character\'s growth and aging.',
            rationale: 'The mirroring of seasons typically symbolizes the stages of life or character development.'
        }]
    },
    {
        type: 'mission', genre: 'info_civics',
        passage: "The three branches of government ensure a system of checks and balances, preventing any one branch from becoming too powerful.",
        items: [{
            id: 'sch-civ-1', type: 'MC', standard: 'RI.8.3', difficulty: 4,
            stem: 'What is the purpose of "checks and balances"?',
            options: ['To speed up lawmaking.', 'To distribute power evenly.', 'To eliminate the need for a President.', 'To increase taxes.'],
            correct_answer: 'To distribute power evenly.',
            rationale: 'The text states it prevents any one branch from becoming too powerful.'
        }]
    },

    // --- SECTION 4: TIER 3 - LEGEND (DIFFICULTY 8-10) ---
    {
        type: 'mission', genre: 'info_philosophy',
        passage: "The Socratic Method involves cooperative dialogue to draw out underlying <b>presuppositions</b>.",
        items: [{
            id: 'leg-phil-1', type: 'MC', standard: 'L.8.4', difficulty: 9,
            stem: 'Define "presuppositions" in this context.',
            options: ['Final conclusions.', 'Assumptions held before dialogue.', 'Argument techniques.', 'Unanswerable questions.'],
            correct_answer: 'Assumptions held before dialogue.',
            rationale: 'The prefix "pre-" indicates these are held beforehand.'
        }]
    },
    {
        type: 'mission', genre: 'lit_classic',
        passage: "It was the best of times, it was the worst of times; wisdom and foolishness.",
        items: [{
            id: 'leg-lit-1', type: 'MC', standard: 'RL.8.2', difficulty: 10,
            stem: 'How does paradox establish the setting?',
            options: ['Wisdom and foolishness are same.', 'Suggests extreme contradictions.', 'Best of times was flawless.', 'Ignores history.'],
            correct_answer: 'Suggests extreme contradictions.',
            rationale: 'Repeated opposites highlight a contradictory era.'
        }]
    },
    {
        type: 'mission', genre: 'info_argument',
        passage: "Critics argue costs rise for parents, but supporters point to district savings.",
        items: [{
            id: 'leg-arg-1', type: 'MC', standard: 'RI.8.8', difficulty: 9,
            stem: 'How does the author evaluate the claims?',
            options: ['Firmly sides against parents.', 'Prioritizes district savings.', 'Presents perspectives without resolution.', 'Utility costs are irrelevant.'],
            correct_answer: 'Presents perspectives without resolution.',
            rationale: 'The author balances both sides without choosing.'
        }]
    },
    {
        type: 'mission', genre: 'lit_tragedy',
        passage: "The crown sat heavy, a circle of gold that felt more like a shackle of lead.",
        items: [{
            id: 'leg-lit-2', type: 'MC', standard: 'RL.8.4', difficulty: 8,
            stem: 'How does the "shackle" metaphor impact tone?',
            options: ['Triumph and wealth.', 'Regret and burden.', 'Physical weakness.', 'Fake materials.'],
            correct_answer: 'Regret and burden.',
            rationale: 'Linking power to a "shackle" emphasizes the burden of rule.'
        }]
    },
    {
        type: 'mission', genre: 'info_science_advanced',
        passage: "Quantum entanglement defies classical intuition, as particles remain <b>intrinsically</b> linked across vast distances.",
        items: [{
            id: 'leg-sci-1', type: 'MC', standard: 'L.8.4', difficulty: 9,
            stem: 'What does "intrinsically" mean in this context?',
            options: ['By accident.', 'At a fundamental level.', 'Occasionally.', 'With extreme effort.'],
            correct_answer: 'At a fundamental level.',
            rationale: 'The context of particle physics suggests an essential, built-in link.'
        }]
    },
    {
        type: 'mission', genre: 'lit_satire',
        passage: "The politician promised to save the environment by building a parking lot on every forest, claiming it would hide the dirt.",
        items: [{
            id: 'leg-lit-3', type: 'MC', standard: 'RL.8.6', difficulty: 9,
            stem: 'What is the most likely purpose of this satirical statement?',
            options: ['To support construction projects.', 'To mock nonsensical environmental policies.', 'To teach about soil types.', 'To encourage forestation.'],
            correct_answer: 'To mock nonsensical environmental policies.',
            rationale: 'Satire uses irony to point out flaws‚Äîhere, the absurdity of "saving" nature by paving it.'
        }]
    },
    {
        type: 'mission', genre: 'info_rhetoric',
        passage: "The orator's use of <b>anaphora</b>‚Äîrepeating 'We shall' at the start of every sentence‚Äîgalvanized the audience into a unified front.",
        items: [{
            id: 'leg-info-3', type: 'MC', standard: 'RI.8.6', difficulty: 8,
            stem: 'What is the rhetorical effect of the repetition described?',
            options: ['It makes the speech boring.', 'It creates a sense of urgency and unity.', 'It confuses the listeners.', 'It suggests the speaker has run out of ideas.'],
            correct_answer: 'It creates a sense of urgency and unity.',
            rationale: 'Repetition at the beginning of phrases (anaphora) is a classic tool to build emotional momentum and unity.'
        }]
    },
    {
        type: 'mission', genre: 'lit_theme_advanced',
        passage: "In the end, the protagonist realized that the monster he had been hunting was merely a reflection of his own unresolved guilt.",
        items: [{
            id: 'leg-lit-4', type: 'MC', standard: 'RL.8.2', difficulty: 9,
            stem: 'What does the "monster" symbolize in this passage?',
            options: ['A literal beast.', 'The character\'s internal struggle.', 'A dangerous animal.', 'A misunderstood friend.'],
            correct_answer: 'The character\'s internal struggle.',
            rationale: 'The direct link between the monster and "unresolved guilt" makes it an internal symbol.'
        }]
    }
];

// --- SYNCED MISSION DATA ---
const allMissions = [
    { id: 'm-history', title: 'The Root Cellar', description: 'Mastering RI.8.1: Citing Evidence', difficulty: 2, passageId: 'rok-hist-1', minLevel: 1 },
    { id: 'm-grammar', title: 'Verb Vault', description: 'Mastering L.8.1: Verb Tense consistency', difficulty: 3, passageId: 'rok-gram-1', minLevel: 1 },
    { id: 'm-social', title: 'Heat Island Effect', description: 'Mastering RI.8.3: Connections', difficulty: 5, passageId: 'sch-soc-1', minLevel: 1 },
    { id: 'm-tech', title: 'AI Awareness', description: 'Mastering RI.8.1: Implicit Bias', difficulty: 7, passageId: 'sch-tech-1', minLevel: 2 },
    { id: 'm-classic', title: 'Classic Paradox', description: 'Mastering RL.8.2: Theme Analysis', difficulty: 10, passageId: 'leg-lit-1', minLevel: 2 }
];

// --- MISSIONS HUB: ADAPTIVE TIERING ---
function renderMissions() {
    missionsList.innerHTML = '';
    const rankTitle = gameState.user.elaLevel >= 3 ? 'Legend' : (gameState.user.elaLevel === 2 ? 'Scholar' : 'Rookie');
    proficiencyDisplay.textContent = rankTitle;
    
    // FILTER: Adaptive complexity based on Calibration Result
    const availableMissions = allMissions.filter(m => {
        const missionTier = m.difficulty <= 3 ? 1 : (m.difficulty <= 7 ? 2 : 3);
        return Math.abs(missionTier - gameState.user.elaLevel) <= 1;
    });

    availableMissions.forEach(mission => {
        const isLocked = gameState.user.level < mission.minLevel;
        const diffColor = mission.difficulty > 7 ? 'text-red-500' : (mission.difficulty > 4 ? 'text-orange-500' : 'text-green-500');
        const missionCard = document.createElement('div');
        
        if (isLocked) {
            missionCard.className = `bg-gray-100 dark:bg-gray-800 rounded-2xl p-6 shadow border-2 border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center text-center opacity-60`;
            missionCard.innerHTML = `<h3 class="text-lg font-bold text-gray-400">Level ${mission.minLevel} Required</h3><p class="text-sm text-gray-400 mb-4">${mission.title}</p>`;
        } else {
            missionCard.className = `bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl border border-indigo-100 dark:border-indigo-900 flex flex-col hover:border-indigo-500 transition-all transform hover:-translate-y-1 cursor-pointer`;
            missionCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-tighter">LVL ${mission.minLevel}+</span>
                    <span class="${diffColor} text-xs font-bold">Difficulty: ${mission.difficulty}/10</span>
                </div>
                <h3 class="text-xl font-bold mb-1 text-gray-800 dark:text-gray-100">${mission.title}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-6 leading-relaxed">${mission.description}</p>
                <button class="start-mission-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-colors" data-mission-id="${mission.id}">BEGIN QUEST ‚öîÔ∏è</button>`;
        }
        missionsList.appendChild(missionCard);
    });

    // Check if the boss card function exists before calling to prevent errors
    if (typeof appendBossCardToMissions === "function") {
        appendBossCardToMissions();
    }
    
    navigate('missions-screen');
}

// --- NEW BOSS BATTLE DATA ---
        const bossBattles = [
{
                id: 'boss-1',
                title: 'The Run-On Robot',
                bossMaxHP: 3, 
                passageParts: [
                    { text: "The concept of artificial intelligence has existed for centuries, " },
                    { 
                        type: 'error', id: 'err1',
                        original: "however, modern computers made it a reality.",
                        // FIX: clearer options to teach semicolon vs FANBOYS
                        options: ["NO CHANGE", "however; modern computers made it a reality.", "but modern computers made it a reality.", "modern computers, made it a reality."],
                        correctIndex: 2,
                        rationale: "Comma Splice Fix: You cannot join two sentences with just a comma and 'however'. Use a conjunction like 'but', or use a semicolon."
                    },
                    { text: " Early computers were massive machines " },
                    { 
                        type: 'error', id: 'err2',
                        original: "that took up entire rooms.",
                        options: ["NO CHANGE", "who took up entire rooms.", "they took up entire rooms.", "it took up entire rooms."],
                        correctIndex: 0,
                        rationale: "Relative Pronouns: Use 'that' for objects (machines). Use 'who' for people."
                    },
                    { text: " Today, we carry more processing power in our pockets " },
                    { 
                        type: 'error', id: 'err3',
                        original: "then NASA had during the moon landing.",
                        options: ["NO CHANGE", "than NASA had during the moon landing.", "then NASA has during the moon landing.", "than NASA has during the moon landing."],
                        correctIndex: 1,
                        rationale: "Word Choice: 'Than' is for comparisons (more than). 'Then' is for time."
                    }
                ]
            },

            {
                id: 'boss-2',
                title: 'Captain Comma',
                bossMaxHP: 3,
                passageParts: [
                    { text: "Cooking is my favorite hobby, " },
                    {
                        type: 'error', id: 'cc1',
                        original: "I make dinner every night.",
                        options: ["NO CHANGE", "I make dinner, every night.", "so I make dinner every night.", "I make dinner every night"],
                        correctIndex: 2,
                        rationale: "Comma Splice! You cannot join two sentences with just a comma. You need a conjunction like 'so'."
                    },
                    { text: " My specialties include lasagna, tacos " },
                    {
                        type: 'error', id: 'cc2',
                        original: "and, spicy curry.",
                        options: ["NO CHANGE", "and spicy curry.", "and spicy, curry.", "and: spicy curry."],
                        correctIndex: 1,
                        rationale: "No comma is needed after 'and' in a simple list unless it's an Oxford comma situation, but the comma here breaks the flow."
                    },
                    { text: " My friends say I should open a restaurant " },
                    {
                        type: 'error', id: 'cc3',
                        original: "because, my food is delicious.",
                        options: ["NO CHANGE", "because my food is delicious.", "because; my food is delicious.", "because my food, is delicious."],
                        correctIndex: 1,
                        rationale: "Do not put a comma before 'because' when it follows the main clause."
                    }
                ]
            },

            {
                id: 'boss-3',
                title: 'The Modifier Monster',
                bossMaxHP: 3,
                passageParts: [
                    { text: "Walking down the street, " },
                    {
                        type: 'error', id: 'mm1',
                        original: "the trees looked beautiful.",
                        options: ["NO CHANGE", "I saw the beautiful trees.", "the trees were looking beautiful.", "beauty was seen in the trees."],
                        correctIndex: 1,
                        rationale: "Dangling Modifier: The 'trees' were not walking down the street! YOU were. The subject (I) must immediately follow the introductory phrase."
                    },
                    { text: " hungry after the long walk, " },
                    {
                        type: 'error', id: 'mm2',
                        original: "the pizza shop smelled amazing.",
                        options: ["NO CHANGE", "the smell of pizza was amazing.", "I thought the pizza shop smelled amazing.", "amazing smells came from the pizza shop."],
                        correctIndex: 2,
                        rationale: "Misplaced Modifier: The 'shop' wasn't hungry. You were! The subject 'I' must perform the action of being hungry."
                    },
                    { text: " I ordered a slice with pepperoni, " },
                    {
                        type: 'error', id: 'mm3',
                        original: "which was greasy.",
                        options: ["NO CHANGE", "that was greasy.", "being greasy.", "it was greasy."],
                        correctIndex: 0,
                        rationale: "Correct Usage: 'Which' correctly refers back to the pepperoni slice. The comma + which sets off a non-essential clause."
                    }
                ]
            },
            {
                id: 'boss-4',
                title: 'The Parallel Phantom',
                bossMaxHP: 3,
                passageParts: [
                    { text: "To succeed in this class, you must be attentive, hardworking, and " },
                    {
                        type: 'error', id: 'pp1',
                        original: "do your homework.",
                        options: ["NO CHANGE", "doing your homework.", "complete your homework.", "studious."],
                        correctIndex: 3,
                        rationale: "Parallelism: 'Attentive' and 'hardworking' are adjectives. The list must end with another adjective ('studious'), not a verb phrase."
                    },
                    { text: " The teacher expects us to listen carefully, to take notes, and " },
                    {
                        type: 'error', id: 'pp2',
                        original: "asking questions.",
                        options: ["NO CHANGE", "to ask questions.", "ask questions.", "questioning."],
                        correctIndex: 1,
                        rationale: "Parallelism: The pattern is 'to listen', 'to take'. It must match with 'to ask'."
                    },
                    { text: " She says that wisdom comes not from memorizing facts, but " },
                    {
                        type: 'error', id: 'pp3',
                        original: "from understanding concepts.",
                        options: ["NO CHANGE", "understanding concepts.", "to understand concepts.", "concepts are understood."],
                        correctIndex: 0,
                        rationale: "Parallelism: 'Not from X, but from Y'. The phrase 'from understanding' matches 'from memorizing'."
                    }
                ]
            }
        ];

        const allBadges = {
            'first_mission': { name: 'First Quest', icon: 'üåü' },
            'perfect_score': { name: 'Flawless Victory', icon: 'üéØ' },
            'hot_text_master': { name: 'Text Alchemist', icon: 'üìù' },
            'boss_slayer': { name: 'Glitch Hunter', icon: 'üëæ' }
        };

const shopItems = [
    { 
        id: 'mystery-box', 
        name: 'üé∞ High Roller Box', 
        description: 'High Risk (100 Tokens). Win Stickers, XP, or JACKPOT.', 
        cost: 100, 
        type: 'consumable',
        color: 'bg-gradient-to-r from-fuchsia-600 to-purple-600 border-2 border-yellow-400',
        action: async () => {
            // ALL possible stickers (Old + New)
            const possibleStickers = [
                'üêâ','üßô‚Äç‚ôÇÔ∏è','üè∞','ü¶Ñ','‚öîÔ∏è','üõ°Ô∏è','üîÆ','üëë', // Mythic
                'üöÄ','üëΩ','ü™ê','‚òÑÔ∏è','üë®‚ÄçüöÄ','üî≠','üõ∏','‚≠ê', // Space
                'ü¶Å','üêò','üê∏','ü¶ã','ü¶à','üêº','ü¶â','ü¶ä', // Animals
                'üìñ','üñãÔ∏è','üìú','üïØÔ∏è','üëì','üé≠','üßõ','üïµÔ∏è‚Äç‚ôÇÔ∏è', // Lit
                'üçï','üçî','üçü','üç£','üç©','üç¶','ü•ë','üåÆ', // Food
                '‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','ü•ä','üèÜ', // Sports
                'üé∏','üéπ','ü•Å','üé∑','üé∫','üé§','üéß','üéº', // Music
                '‚úàÔ∏è','üóΩ','üóº','üèùÔ∏è','‚õ∞Ô∏è','‚õ∫','üó∫Ô∏è','üóø'  // Travel
            ];
            const roll = Math.random();
            let msg = ""; 
            let type = "info";
            if (roll < 0.25) { 
                msg = "üí® Dust and cobwebs... The box was empty.";
                type = "error"; 
                playSound('incorrect'); 
            } 
            else if (roll < 0.50) { 
                const xp = 200;
                addXp(xp); 
                msg = `‚ú® Not bad! You found <b>${xp} XP</b>!`; 
                type = "success"; 
                playSound('correct');
            } 
            else if (roll < 0.80) { 
                const newSticker = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                if(!gameState.user.stickers.includes(newSticker)) {
                    gameState.user.stickers.push(newSticker);
                    msg = `üéâ You found a Sticker!<br><span class="text-6xl block mt-4">${newSticker}</span>`;
                    type = "success";
                    triggerConfetti();
                } else {
                    gameState.user.tokens += 25;
                    msg = `You found a Sticker (${newSticker}), but you owned it. Refunded 25 Tokens.`;
                }
                playSound('win');
            }
            else if (roll < 0.95) {
                const tk = 150;
                gameState.user.tokens += tk;
                msg = `üí∞ Money Bags! You found <b>${tk} Tokens</b>!`;
                type = "success";
                playSound('buy');
            }
            else { 
                // JACKPOT
                const s1 = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                const s2 = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                if(!gameState.user.stickers.includes(s1)) gameState.user.stickers.push(s1);
                if(!gameState.user.stickers.includes(s2)) gameState.user.stickers.push(s2);
                addXp(500);
                msg = `üö® <b>MEGA JACKPOT!!</b> üö®<br>You found 500 XP and TWO Stickers!<br><div class="flex justify-center gap-4 mt-4 text-6xl"><span>${s1}</span><span>${s2}</span></div>`;
                type = "success";
                playSound('win'); 
                triggerConfetti();
            }
            saveProgress(); updateUI();
            await showModal('Mystery Box Result', msg, type);
        }
    },
    // --- EXISTING PACKS ---
    { 
        id: 'sticker-pack-myth', name: 'üêâ Mythic Pack', description: 'Fantasy Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-emerald-500 to-teal-600',
        action: () => buyStickerPack(stickerCollections.mythic.items, 'Mythic')
    },
    { 
        id: 'sticker-pack-space', name: 'üöÄ Cosmic Pack', description: 'Space Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-blue-600 to-indigo-800',
        action: () => buyStickerPack(stickerCollections.space.items, 'Cosmic')
    },
    { 
        id: 'sticker-pack-lit', name: 'üìñ Lit Pack', description: 'Book Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-amber-600 to-orange-700',
        action: () => buyStickerPack(stickerCollections.literature.items, 'Literature')
    },
    { 
        id: 'sticker-pack-zoo', name: 'ü¶Å Animal Pack', description: 'Wild Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-green-600 to-lime-700',
        action: () => buyStickerPack(stickerCollections.animals.items, 'Animal')
    },
    // --- NEW PACKS ---
    { 
        id: 'sticker-pack-food', name: 'üçï Snack Pack', description: 'Yummy Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-yellow-400 to-orange-500',
        action: () => buyStickerPack(stickerCollections.foodie.items, 'Snack')
    },
    { 
        id: 'sticker-pack-sport', name: 'üèÜ Sports Pack', description: 'Athletic Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-blue-500 to-cyan-500',
        action: () => buyStickerPack(stickerCollections.sports.items, 'Sports')
    },
    { 
        id: 'sticker-pack-music', name: 'üé∏ Rock Pack', description: 'Music Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-purple-500 to-pink-500',
        action: () => buyStickerPack(stickerCollections.music.items, 'Music')
    },
    { 
        id: 'sticker-pack-travel', name: '‚úàÔ∏è Travel Pack', description: 'World Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-indigo-400 to-blue-600',
        action: () => buyStickerPack(stickerCollections.travel.items, 'Travel')
    },
    // --- POWER UPS ---
    { 
        id: 'skip-ticket', name: '‚è© Skip Ticket', description: 'Auto-Corrects a hard question.', cost: 75, type: 'consumable', color: 'bg-gradient-to-br from-cyan-400 to-blue-500',
        action: () => { gameState.user.purchasedItems.push({ id: 'skip-ticket' }); playSound('buy'); }
    },
    { 
        id: 'lifeline-5050', name: 'üí£ 50/50 Bomb', description: 'Removes 2 wrong answers.', cost: 30, type: 'consumable', color: 'bg-gradient-to-br from-red-500 to-orange-500',
        action: () => { gameState.user.purchasedItems.push({ id: 'lifeline-5050' }); playSound('buy'); }
    }
];

// Helper for buying packs (Keep code clean)
async function buyStickerPack(pool, packName) {
    const newSticker = pool[Math.floor(Math.random() * pool.length)];
    if(!gameState.user.stickers.includes(newSticker)) {
        gameState.user.stickers.push(newSticker);
        playSound('win'); triggerConfetti();
        await showModal(`${packName} Pack!`, `You got: <span class="text-6xl block mt-2">${newSticker}</span>`, 'success');
    } else {
        gameState.user.tokens += 15; // Increased refund slightly
        playSound('buy');
        await showModal('Duplicate!', `You already have ${newSticker}. Refunded 15 Tokens.`, 'info');
    }
    saveProgress();
}

        // --- CORE FUNCTIONS ---
function showModal(title, message, type = 'info') {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // <--- UPDATED: Allows bold/italic text in explanations
            
            modalBox.className = `bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center relative transform transition-all duration-300`;
            if(type === 'success') { modalBox.classList.add('border-t-4', 'border-green-500'); modalTitle.className='text-2xl font-bold mb-2 text-green-600'; }
            else if(type === 'error') { modalBox.classList.add('border-t-4', 'border-red-500'); modalTitle.className='text-2xl font-bold mb-2 text-red-600'; }
            else { modalBox.classList.add('border-t-4', 'border-blue-500'); modalTitle.className='text-2xl font-bold mb-2 text-blue-600'; }
            
            modalBackdrop.classList.remove('hidden');
            setTimeout(() => { modalBox.classList.remove('scale-95', 'opacity-0'); }, 10);
            return new Promise(resolve => {
                modalOkBtn.onclick = () => {
                    modalBox.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => { modalBackdrop.classList.add('hidden'); resolve(); }, 300);
                };
            });
        }

        function navigate(screenId) {
            screens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            gameState.currentScreen = screenId;
        }

        // --- Calibration Logic ---
        let calibrationProgress = { questions: [], currentQuestion: 0, elaLevel: 0 };
function startCalibrationQuest() {
    // This now correctly pulls the calibration items we added above
    calibrationProgress.questions = itemBank.filter(item => item.type === 'calibration');
    calibrationProgress.currentQuestion = 0;
    calibrationProgress.elaLevel = 0;
    
    if(calibrationProgress.questions.length === 0) {
        showModal("Error", "No calibration questions found in database!", "error");
        return;
    }

    navigate('calibration-screen');
    renderCalibrationQuestion();
}

function renderCalibrationQuestion() {
    const currentItem = calibrationProgress.questions[calibrationProgress.currentQuestion];
    if (!currentItem) { endCalibrationQuest(); return; }

    questionArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-lg mb-2 text-blue-600 uppercase">Diagnostic Question ${calibrationProgress.currentQuestion + 1}</p>
            <div class="p-6 bg-white dark:bg-gray-700 rounded-xl shadow-inner border-l-4 border-blue-500 mb-4">
                <p class="italic text-gray-800 dark:text-gray-100 font-serif leading-relaxed">${currentItem.passage}</p>
            </div>
        </div>
        <div>
            <p class="font-bold mb-4 text-xl">${currentItem.items[0].stem}</p>
            <div id="options-container" class="grid grid-cols-1 gap-3">
                ${currentItem.items[0].options.map(option => `
                    <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all">
                        <input type="radio" name="calibration-q" value="${option}" class="mr-3 w-5 h-5">
                        <span class="text-lg font-medium">${option}</span>
                    </label>`).join('')}
            </div>
        </div>`;
    submitButton.onclick = submitCalibrationAnswer;
}

        async function submitCalibrationAnswer() {
            const selectedOption = document.querySelector('input[name="calibration-q"]:checked');
            if (!selectedOption) { await showModal('Oops!', 'Please select an answer.', 'error'); return; }

            const currentItem = calibrationProgress.questions[calibrationProgress.currentQuestion];
            const isCorrect = selectedOption.value === currentItem.items[0].correct_answer;

            if (isCorrect) {
                calibrationProgress.elaLevel += currentItem.items[0].difficulty;
                playSound('correct');
                await showModal('Correct!', 'Nice job! ' + currentItem.items[0].rationale, 'success');
            } else {
                playSound('incorrect');
                await showModal('Incorrect.', 'The correct answer was ' + currentItem.items[0].correct_answer, 'error');
            }
            
            calibrationProgress.currentQuestion++;
            renderCalibrationQuestion();
        }

function endCalibrationQuest() {
    const score = calibrationProgress.elaLevel;
    
    // Tiering Logic
    if (score >= 13) {
        gameState.user.elaLevel = 3; 
        elaLevelDisplay.textContent = 'Mythic Legend';
    } else if (score >= 7) {
        gameState.user.elaLevel = 2;
        elaLevelDisplay.textContent = 'Expert Scholar';
    } else {
        gameState.user.elaLevel = 1;
        elaLevelDisplay.textContent = 'Rookie Adventurer';
    }

    calibrationContent.classList.add('hidden');
    calibrationResults.classList.remove('hidden');
    
    // FIX: Tie the button to the Missions Hub
    document.getElementById('start-missions-button').onclick = () => {
        calibrationResults.classList.add('hidden');
        renderMissions();
    };
    
    saveProgress();
    updateUI();
}

// --- Missions Logic ---
// --- Missions Hub: Adaptive Tiering ---
function renderMissions() {
    missionsList.innerHTML = '';
    // Map numerical level to a readable title
    const rankTitle = gameState.user.elaLevel >= 3 ? 'Legend' : (gameState.user.elaLevel === 2 ? 'Scholar' : 'Rookie');
    proficiencyDisplay.textContent = rankTitle;
    
    // FILTER: Only show missions that match the user's tier +/- 1
    const availableMissions = allMissions.filter(m => {
        const missionTier = m.difficulty <= 3 ? 1 : (m.difficulty <= 7 ? 2 : 3);
        return Math.abs(missionTier - gameState.user.elaLevel) <= 1;
    });

    availableMissions.forEach(mission => {
        const isLocked = gameState.user.level < mission.minLevel;
        const diffColor = mission.difficulty > 7 ? 'text-red-500' : (mission.difficulty > 4 ? 'text-orange-500' : 'text-green-500');
        const missionCard = document.createElement('div');
        
        if (isLocked) {
            missionCard.className = `bg-gray-100 dark:bg-gray-800 rounded-2xl p-6 shadow border-2 border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center text-center opacity-60`;
            missionCard.innerHTML = `<h3 class="text-lg font-bold text-gray-400">Level ${mission.minLevel} Required</h3><p class="text-sm text-gray-400 mb-4">${mission.title}</p>`;
        } else {
            missionCard.className = `bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl border border-indigo-100 dark:border-indigo-900 flex flex-col hover:border-indigo-500 transition-all transform hover:-translate-y-1 cursor-pointer`;
            missionCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-tighter">LVL ${mission.minLevel}+</span>
                    <span class="${diffColor} text-xs font-bold">Difficulty: ${mission.difficulty}/10</span>
                </div>
                <h3 class="text-xl font-bold mb-1 text-gray-800 dark:text-gray-100">${mission.title}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-6 leading-relaxed">${mission.description}</p>
                <button class="start-mission-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-colors" data-mission-id="${mission.id}">BEGIN QUEST ‚öîÔ∏è</button>`;
        }
        missionsList.appendChild(missionCard);
    });

    appendBossCardToMissions();
    document.querySelectorAll('.start-mission-btn').forEach(btn => {
        btn.onclick = (e) => startMission(e.target.dataset.missionId);
    });
    navigate('missions-screen');
}

function startMission(missionId) {
    gameState.currentMission = allMissions.find(m => m.id === missionId);
    gameState.currentQuestionIndex = 0;
    gameState.missionScore = 0;
    gameState.streak = 0;
    gameState.missionHistoryData = [];
    navigate('game-play-screen');
    startTimer(); 
    renderMissionQuestion();
}

function renderMissionQuestion() {
    const missionItem = itemBank.find(zone => 
        zone.id === gameState.currentMission.passageId || 
        zone.genre === gameState.currentMission.id ||
        zone.items.some(i => i.id.startsWith(gameState.currentMission.passageId))
    );
    
    if (!missionItem) {
        showModal("Error", "Mission content not found! Check passageId alignment.", "error");
        navigate('missions-screen');
        return;
    }

    const currentItem = missionItem.items[gameState.currentQuestionIndex];
    if (!currentItem) { endMission(missionItem.items.length); return; }
    
    gameTitle.textContent = gameState.currentMission.title;
    missionScoreDisplay.innerHTML = `${gameState.missionScore}`;
    missionTotalQuestions.textContent = missionItem.items.length;

    gamePassage.innerHTML = `<p class="font-bold mb-2 text-lg text-indigo-600 dark:text-indigo-400">Passage</p><div class="prose dark:prose-invert max-w-none">${missionItem.passage}</div>`;

    gameQuestionsArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-lg mb-2 text-indigo-500">Question ${gameState.currentQuestionIndex + 1}</p>
            <p class="mb-4 text-lg font-medium">${currentItem.stem}</p>
            <div id="options-container" class="space-y-3">
                ${currentItem.options.map((option, index) => `
                    <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 cursor-pointer hover:bg-indigo-50 transition-all">
                        <input type="radio" name="mission-q" value="${option}" class="mt-1 mr-3 w-5 h-5">
                        <span class="flex-1 text-base text-gray-800 dark:text-gray-200">${option}</span>
                    </label>`).join('')}
            </div>
        </div>`;

    renderSubmitButton(currentItem, missionItem.items.length);
}

function renderSubmitButton(currentItem, total) {
    const container = document.querySelector('#game-play-screen .flex.justify-end');
    container.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg';
    btn.textContent = 'Submit Answer';
    btn.onclick = () => checkMissionAnswer(currentItem, total, btn);
    container.appendChild(btn);
}

async function checkMissionAnswer(currentItem, total, btn) {
    const selected = document.querySelector('input[name="mission-q"]:checked');
    if(!selected) { await showModal('Oops', 'Select an answer', 'error'); return; }
    
    const isCorrect = selected.value === currentItem.correct_answer;
    btn.disabled = true;

    // --- RIGOR FIX: Save data for the Review Screen ---
    gameState.missionHistoryData.push({
        question: currentItem.stem,
        userAnswer: selected.value,
        correctAnswer: currentItem.correct_answer,
        isCorrect: isCorrect,
        rationale: currentItem.rationale,
        standard: currentItem.standard || "General"
    });

    // Track Stats for Teacher Report
    const std = currentItem.standard || "General";
    if (!gameState.user.standardsReport) gameState.user.standardsReport = {};
    if (!gameState.user.standardsReport[std]) {
        gameState.user.standardsReport[std] = { correct: 0, total: 0, desc: getStandardDesc(std) };
    }
    gameState.user.standardsReport[std].total++;

    if (isCorrect) {
        gameState.missionScore++;
        gameState.streak++;
        gameState.user.standardsReport[std].correct++;
        await showModal('Correct!', currentItem.rationale, 'success');
    } else {
        gameState.streak = 0;
        if(!gameState.user.missedQuestions) gameState.user.missedQuestions = [];
        // Add unique ID for Archive purging
        gameState.user.missedQuestions.push({...currentItem, id: 'glitch-' + Date.now()});
        await showModal('Incorrect', currentItem.rationale, 'error');
    }

    gameState.currentQuestionIndex++;
    renderMissionQuestion();
}

function endMission(total) {
    const timeTaken = stopTimer(); 
    const accuracy = gameState.missionScore / total;
    const xpEarned = Math.round(accuracy * 100);
    
    // Calculate Speed Bonus
    const avgTimePerQ = timeTaken / total;
    let speedBonus = 0;
    if(avgTimePerQ < 20) speedBonus = 20; 
    else if(avgTimePerQ < 40) speedBonus = 10;

    let tokensEarned = (gameState.missionScore * 15) + speedBonus;

    gameState.user.tokens += tokensEarned;
    addXp(xpEarned);

    gameState.user.history.push({
        missionTitle: gameState.currentMission.title,
        score: `${gameState.missionScore}/${total}`,
        date: new Date().toLocaleDateString(),
        tokensEarned: tokensEarned,
        xpEarned: xpEarned
    });

    saveProgress();
    updateUI();
    
    // Call the review function with all the data
    renderReview(total, xpEarned, tokensEarned, speedBonus, timeTaken);
}

function renderReview(total, xp, tokens, speedBonus, timeTaken) {
    const reviewContent = document.getElementById('review-content');
    reviewContent.innerHTML = ''; 

    const mins = Math.floor(timeTaken / 60);
    const secs = (timeTaken % 60).toString().padStart(2, '0');

    // 1. Create Summary Header
    const summaryCard = document.createElement('div');
    summaryCard.className = "bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-xl border-t-8 border-indigo-500 text-center mb-8";
    summaryCard.innerHTML = `
        <h2 class="text-3xl font-black mb-4 text-indigo-600 dark:text-indigo-400">MISSION COMPLETE</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                <p class="text-xs font-bold text-blue-600 uppercase">Score</p>
                <p class="text-2xl font-black">${gameState.missionScore}/${total}</p>
            </div>
            <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl">
                <p class="text-xs font-bold text-amber-600 uppercase">Time</p>
                <p class="text-2xl font-black">${mins}:${secs}</p>
            </div>
            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl">
                <p class="text-xs font-bold text-green-600 uppercase">XP</p>
                <p class="text-2xl font-black">+${xp}</p>
            </div>
            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl">
                <p class="text-xs font-bold text-yellow-600 uppercase">Tokens</p>
                <p class="text-2xl font-black">+${tokens}</p>
            </div>
        </div>
        ${speedBonus > 0 ? `<div class="mt-4 text-sm font-bold text-emerald-500 animate-bounce">‚ö° Speed Bonus Applied: +${speedBonus} Tokens!</div>` : ''}
    `;
    reviewContent.appendChild(summaryCard);

    // 2. Create Question Breakdown
    gameState.missionHistoryData.forEach((data, index) => {
        const card = document.createElement('div');
        const isCorrect = data.isCorrect;
        card.className = `p-6 rounded-xl shadow-md border-l-8 mb-4 ${isCorrect ? 'bg-green-50 border-green-500 dark:bg-gray-800' : 'bg-red-50 border-red-500 dark:bg-gray-800'}`;
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="font-bold text-gray-400 text-xs uppercase tracking-widest">Question ${index + 1} ‚Ä¢ ${data.standard}</span>
                <span class="${isCorrect ? 'text-green-600' : 'text-red-600'} font-black italic">${isCorrect ? 'SUCCESS' : 'GLITCHED'}</span>
            </div>
            <p class="font-bold text-lg mb-3 text-gray-800 dark:text-gray-100">${data.question}</p>
            <div class="bg-white/50 dark:bg-black/20 p-3 rounded-lg border border-black/5 mb-3">
                <p class="text-sm"><b>Your Answer:</b> <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${data.userAnswer}</span></p>
            </div>
            <div class="text-xs leading-relaxed text-gray-600 dark:text-gray-400 p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded border border-indigo-100 dark:border-indigo-900/50">
                <b>Explanation:</b> ${data.rationale}
            </div>
        `;
        reviewContent.appendChild(card);
    });

    // 3. Return Home Button
    const btnContainer = document.createElement('div');
    btnContainer.className = "text-center py-8";
    btnContainer.innerHTML = `<button onclick="navigate('welcome-screen')" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 px-16 rounded-2xl text-xl shadow-2xl transition-transform hover:scale-105">RETURN TO BASE ‚û°</button>`;
    reviewContent.appendChild(btnContainer);

    navigate('review-screen');
}

// --- SURVIVAL: THE GAUNTLET ---
function startSurvival() {
    const allItems = itemBank.flatMap(zone => 
        zone.items.map(item => ({ ...item, passage: zone.passage }))
    ).sort((a, b) => a.difficulty - b.difficulty);
    
    gameState.survivalQueue = allItems;
    gameState.mode = 'survival';
    gameState.missionScore = 0;
    gameState.currentQuestionIndex = 0;
    
    navigate('game-play-screen');
    startTimer();
    renderSurvivalQuestion();
}

function renderSurvivalQuestion() {
    const currentItem = gameState.survivalQueue[gameState.currentQuestionIndex];
    if (!currentItem) { navigate('welcome-screen'); return; }

    gameTitle.innerHTML = `<span class="text-red-600 uppercase italic font-black">üíÄ The Gauntlet</span>`;
    gamePassage.innerHTML = `<div class="prose dark:prose-invert">${currentItem.passage}</div>`;
    gameQuestionsArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-red-500 mb-2 italic tracking-widest uppercase">Survival Level: ${currentItem.difficulty}</p>
            <p class="mb-4 text-lg font-medium">${currentItem.stem}</p>
            <div id="options-container" class="space-y-3">
                ${currentItem.options.map(opt => `
                    <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 cursor-pointer hover:bg-red-50 transition-all">
                        <input type="radio" name="survival-q" value="${opt}" class="mr-3">
                        <span>${opt}</span>
                    </label>`).join('')}
            </div>
            <button onclick="checkSurvivalAnswer()" class="w-full mt-6 bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg">Submit Answer</button>
        </div>`;
}

async function checkSurvivalAnswer() {
    const currentItem = gameState.survivalQueue[gameState.currentQuestionIndex];
    const selected = document.querySelector('input[name="survival-q"]:checked');
    if(!selected) return;

    if (selected.value === currentItem.correct_answer) {
        gameState.missionScore++;
        gameState.currentQuestionIndex++;
        await showModal('SURVIVED!', `Streak: ${gameState.missionScore}`, 'success');
        renderSurvivalQuestion();
    } else {
        stopTimer();
        await showModal('üíÄ GAME OVER', `Correct: ${currentItem.correct_answer}<br><br>${currentItem.rationale}`, 'error');
        saveProgress();
        navigate('welcome-screen');
    }
}

// --- SYSTEM HELPERS ---
function addXp(amount) {
    gameState.user.xp += amount;
    while (gameState.user.xp >= 100) { 
        gameState.user.xp -= 100; 
        gameState.user.level++; 
        triggerConfetti();
    }
    updateUI();
}

function updateUI() {
    const profDisplay = document.getElementById('proficiency-display');
if(profDisplay) {
    const rank = gameState.user.elaLevel >= 3 ? 'LEGEND' : (gameState.user.elaLevel === 2 ? 'SCHOLAR' : 'ROOKIE');
    profDisplay.className = `font-black px-3 py-1 rounded-full text-xs ${rank === 'LEGEND' ? 'bg-purple-600 text-white animate-pulse' : (rank === 'SCHOLAR' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700')}`;
    profDisplay.textContent = rank;
};
    const mainLevel = document.getElementById('main-level-display');
    const mainXpCur = document.getElementById('main-xp-current');
    const mainXpBar = document.getElementById('main-xp-bar');
    const mainTokens = document.getElementById('main-token-display');

    if(mainLevel) mainLevel.textContent = gameState.user.level;
    if(mainXpCur) mainXpCur.textContent = gameState.user.xp;
    if(mainXpBar) mainXpBar.style.width = `${gameState.user.xp}%`; 
    if(mainTokens) mainTokens.textContent = gameState.user.tokens;
    if(tokenDisplay) tokenDisplay.textContent = gameState.user.tokens;
}

function saveProgress() { localStorage.setItem('elaGameProgress', JSON.stringify(gameState.user)); }
function loadProgress() { 
    const saved = localStorage.getItem('elaGameProgress'); 
    if(saved) gameState.user = { ...gameState.user, ...JSON.parse(saved) }; 
}

function resetGame() {
    localStorage.removeItem('elaGameProgress');
    location.reload();
}

function triggerConfetti() { if(typeof confetti !== 'undefined') confetti({ particleCount: 150, spread: 90 }); }

// --- TEACHER REPORT HELPER: STANDARD DEFINITIONS ---
function getStandardDesc(std) {
    const map = {
        'RI.8.1': 'Citing Evidence',
        'RI.8.2': 'Central Idea & Summary',
        'RI.8.3': 'Connections & Distinctions',
        'RI.8.4': 'Vocabulary in Context',
        'RI.8.5': 'Text Structure',
        'RI.8.6': 'Author Point of View',
        'RI.8.8': 'Evaluating Arguments',
        'RL.8.1': 'Inference & Evidence',
        'RL.8.2': 'Theme & Plot',
        'RL.8.3': 'Character Development',
        'RL.8.4': 'Figurative Language',
        'RL.8.6': 'Irony & Suspense',
        'L.8.1': 'Grammar & Usage',
        'L.8.2': 'Punctuation & Spelling',
        'L.8.4': 'Vocabulary Acquisition',
        'L.8.5': 'Figures of Speech'
    };
    return map[std] || 'General ELA Mastery';
}

// --- GLITCH ARCHIVE: RETEACH & REPAIR SYSTEM ---
function openArchive() {
    const list = document.getElementById('archive-list');
    const emptyMsg = document.getElementById('archive-empty-msg');
    list.innerHTML = '';
    
    // Check if user has any missed questions saved
    if (!gameState.user.missedQuestions || gameState.user.missedQuestions.length === 0) {
        emptyMsg.classList.remove('hidden');
    } else {
        emptyMsg.classList.add('hidden');
        gameState.user.missedQuestions.forEach((item) => {
            const card = document.createElement('div');
            const standardKey = item.standard || 'General';
            
            // Pull the specific mini-lesson you wrote in skillLessons
            const lessonText = skillLessons[standardKey] || "Review the text for direct evidence. ELA mastery requires citing specific lines to support your claims.";

            card.className = "bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border-l-8 border-red-500 mb-6 relative overflow-hidden";
            card.innerHTML = `
                <div class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">CORRUPTED</div>
                <div class="mb-4 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-900/50">
                    <p class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase mb-1 tracking-widest">Targeted Study: ${getStandardDesc(standardKey)}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">${lessonText}</p>
                </div>
                <p class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">${item.stem}</p>
                <div class="space-y-2">
                    ${item.options.map(opt => `
                        <button class="w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors font-medium" 
                        onclick="checkArchiveAnswer('${item.id}', '${opt.replace(/'/g, "\\'")}', this)">
                            ${opt}
                        </button>`).join('')}
                </div>
                <p class="mt-4 text-[10px] text-gray-400 font-mono italic">Successful purge grants +10 XP and +5 Tokens</p>
            `;
            list.appendChild(card);
        });
    }
    navigate('archive-screen');
}

async function checkArchiveAnswer(itemId, answer, btnElement) {
    const itemIndex = gameState.user.missedQuestions.findIndex(q => q.id === itemId);
    if (itemIndex === -1) return;
    const item = gameState.user.missedQuestions[itemIndex];
    
    if (answer === item.correct_answer) {
        // Correct Fix
        await showModal('Glitch Purged! üõ°Ô∏è', `Excellent! You applied the skill correctly.<br><br><b>Explanation:</b> ${item.rationale}`, 'success');
        
        gameState.user.missedQuestions.splice(itemIndex, 1);
        gameState.user.tokens += 5; 
        addXp(10);
        saveProgress();
        triggerConfetti();
        openArchive(); // Refresh the list
    } else {
        // Failed Fix
        btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
        btnElement.disabled = true;
        btnElement.innerHTML += " ‚ùå";
    }
}

// --- DEPLOYMENT & CONTENT VALIDATION SYSTEM ---
/**
 * Scans the mission list to ensure every button has a 
 * matching academic passage in the item bank.
 */
function validateMissionContent() {
    console.log("üöÄ Starting Content Deployment Scan...");
    let missingContent = [];

    allMissions.forEach(mission => {
        // Search logic must match renderMissionQuestion exactly
        const hasContent = itemBank.find(zone => 
            zone.id === mission.passageId || 
            zone.genre === mission.id ||
            (zone.items && zone.items.some(i => i.id.startsWith(mission.passageId)))
        );

        if (!hasContent) {
            missingContent.push(`[${mission.id}] ${mission.title}`);
        }
    });

    if (missingContent.length > 0) {
        console.error("‚ùå DEPLOYMENT ERROR: The following missions are missing academic content in itemBank:", missingContent);
        // Optional: Alert the developer during testing
        // alert("Developer Alert: Missing content for " + missingContent.join(", "));
    } else {
        console.log("‚úÖ All Missions Validated: Ready for student deployment.");
    }
}

/**
 * Enhanced Start Mission with Safety Catch
 */
function safeStartMission(missionId) {
    const mission = allMissions.find(m => m.id === missionId);
    const content = itemBank.find(zone => 
        zone.id === mission.passageId || 
        zone.genre === mission.id ||
        (zone.items && zone.items.some(i => i.id.startsWith(mission.passageId)))
    );

    if (!content) {
        showModal("System Error", "This mission file is corrupted or missing content. Please choose another quest.", "error");
        return;
    }
    
    startMission(missionId);
}

function appendBossCardToMissions() {
    // Only show boss if student has reached a high enough level
    if (gameState.user.level < 3) return;

    const bossCard = document.createElement('div');
    bossCard.className = "col-span-1 md:col-span-2 lg:col-span-3 bg-gradient-to-r from-red-900 to-black rounded-2xl p-8 shadow-2xl border-4 border-red-600 flex flex-col md:flex-row items-center justify-between gap-6 transform hover:scale-[1.02] transition-transform";
    bossCard.innerHTML = `
        <div class="flex-1 text-center md:text-left">
            <h3 class="text-3xl font-black text-white mb-2">üö® GLITCH DETECTED</h3>
            <p class="text-red-200 text-lg">The system core is corrupted. Face the Glitch to restore order.</p>
        </div>
        <button onclick="startBossBattle('boss-1')" class="bg-red-600 hover:bg-red-500 text-white font-black py-4 px-10 rounded-xl shadow-lg animate-pulse">ELIMINATE THREAT</button>
    `;
    missionsList.appendChild(bossCard);
}

function generateReport() {
    const stats = gameState.user.standardsReport || {};
    let rows = "";
    let totalCorrect = 0;
    let totalQ = 0;

    for (const [std, data] of Object.entries(stats)) {
        const percent = Math.round((data.correct / data.total) * 100);
        totalCorrect += data.correct;
        totalQ += data.total;
        rows += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px;"><b>${std}</b><br><small>${data.desc}</small></td>
                <td style="padding: 10px; text-align: center;">${data.correct}/${data.total}</td>
                <td style="padding: 10px; text-align: center; color: ${percent >= 80 ? 'green' : 'red'};"><b>${percent}%</b></td>
            </tr>`;
    }

    const overall = totalQ > 0 ? Math.round((totalCorrect / totalQ) * 100) : 0;

    const reportHTML = `
        <div style="font-family: sans-serif; padding: 20px; color: #333;">
            <h1 style="color: #4f46e5;">ELA Legends: Proficiency Report</h1>
            <p><b>Student Rank:</b> ${proficiencyDisplay.textContent} | <b>Level:</b> ${gameState.user.level}</p>
            <p><b>Overall Accuracy:</b> ${overall}%</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <tr style="background: #f3f4f6;">
                    <th style="padding: 10px; text-align: left;">Standard</th>
                    <th style="padding: 10px;">Score</th>
                    <th style="padding: 10px;">Mastery</th>
                </tr>
                ${rows || "<tr><td colspan='3' style='text-align:center; padding: 20px;'>No mission data recorded yet.</td></tr>"}
            </table>
            <p style="margin-top: 30px; font-size: 12px; color: #666;">Generated on: ${new Date().toLocaleString()}</p>
            <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 5px; cursor: pointer;">Print Report</button>
        </div>
    `;

    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
}

// --- BOSS BATTLE SYSTEM CORE ---
let currentBossHP = 0;
let currentPlayerHP = 3;
let currentBossData = null;

function startBossBattle(bossId) {
    currentBossData = bossBattles.find(b => b.id === bossId);
    currentBossHP = currentBossData.bossMaxHP;
    currentPlayerHP = 3;
    
    updateBossUI();
    renderBossText();
    navigate('boss-round-screen');
}

function updateBossUI() {
    const playerBar = document.getElementById('player-hp-bar');
    const bossBar = document.getElementById('boss-hp-bar');
    
    if(playerBar) playerBar.style.width = (currentPlayerHP / 3 * 100) + '%';
    if(bossBar) bossBar.style.width = (currentBossHP / currentBossData.bossMaxHP * 100) + '%';
}

function renderBossText() {
    const display = document.getElementById('boss-text-display');
    display.innerHTML = '';

    currentBossData.passageParts.forEach(part => {
        if (part.type === 'error') {
            const span = document.createElement('span');
            span.className = "bg-red-100 border-b-2 border-red-500 cursor-pointer hover:bg-red-200 px-1 mx-1 rounded transition-colors font-bold text-red-700";
            span.textContent = part.original;
            span.onclick = () => openEditorModal(part);
            display.appendChild(span);
        } else {
            const textNode = document.createTextNode(part.text);
            display.appendChild(textNode);
        }
    });
}

function openEditorModal(part) {
    const modal = document.getElementById('editor-modal');
    const optionsContainer = document.getElementById('editor-options');
    optionsContainer.innerHTML = '';

    part.options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all font-medium";
        btn.textContent = opt;
        btn.onclick = () => checkBossAnswer(part, index);
        optionsContainer.appendChild(btn);
    });

    modal.classList.remove('hidden');
    document.getElementById('close-editor-modal').onclick = () => modal.classList.add('hidden');
}

async function checkBossAnswer(part, selectedIndex) {
    document.getElementById('editor-modal').classList.add('hidden');
    
    if (selectedIndex === part.correctIndex) {
        currentBossHP--;
        await showModal("DIRECT HIT! üéØ", `<b>Correction applied!</b><br><br>${part.rationale}`, "success");
    } else {
        currentPlayerHP--;
        await showModal("SYSTEM CRASH! ‚ö°", `The Glitch attacked your core!<br><br><b>Explanation:</b> ${part.rationale}`, "error");
    }

    updateBossUI();

    if (currentBossHP <= 0) {
        addXp(500);
        gameState.user.tokens += 200;
        triggerConfetti();
        await showModal("VICTORY! üèÜ", "The Glitch has been purged from this sector! +500 XP / +200 Tokens", "success");
        navigate('welcome-screen');
    } else if (currentPlayerHP <= 0) {
        await showModal("DEFEATED üíÄ", "The Glitch was too strong. Study your standards and try again!", "error");
        navigate('welcome-screen');
    }
}// --- STICKER BOOK: COLLECTION DISPLAY ---
function renderStickerBook() {
    const progressScreen = document.getElementById('progress-screen');
    // We will reuse the progress screen but add a sticker grid
    const stickerAreaId = 'sticker-collection-grid';
    let stickerGrid = document.getElementById(stickerAreaId);
    
    if (!stickerGrid) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
            <h3 class="text-2xl font-bold mt-8 mb-4">My Stickers</h3>
            <div id="${stickerAreaId}" class="grid grid-cols-4 md:grid-cols-8 gap-4 p-6 bg-white/50 dark:bg-black/20 rounded-2xl border border-white/20"></div>
        `;
        progressScreen.appendChild(wrapper);
        stickerGrid = document.getElementById(stickerAreaId);
    }

    stickerGrid.innerHTML = '';
    if (gameState.user.stickers.length === 0) {
        stickerGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 italic py-4">No stickers collected yet. Visit the Shop!</p>';
    } else {
        gameState.user.stickers.forEach(emoji => {
            const div = document.createElement('div');
            div.className = "text-4xl p-2 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 flex items-center justify-center transform hover:scale-110 transition-transform";
            div.textContent = emoji;
            stickerGrid.appendChild(div);
        });
    }
    
    // Update history table too
    renderMissionHistory();
    navigate('progress-screen');
}

function renderMissionHistory() {
    missionHistoryBody.innerHTML = gameState.user.history.map(entry => `
        <tr class="border-b border-gray-100 dark:border-gray-700">
            <td class="p-4 font-bold text-indigo-600">${entry.missionTitle}</td>
            <td class="p-4">${entry.score}</td>
            <td class="p-4 text-xs">${entry.date}</td>
            <td class="p-4 text-yellow-600 font-bold">+${entry.tokensEarned}</td>
            <td class="p-4 text-green-600 font-bold">+${entry.xpEarned}</td>
        </tr>
    `).join('');
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    loadProgress();
    updateUI();

    // Run Deployment Scan
    validateMissionContent();

    document.getElementById('start-calibration-button').onclick = startCalibrationQuest;
    document.getElementById('missions-button').onclick = renderMissions;
    document.getElementById('shop-button').onclick = () => { navigate('shop-screen'); };
    document.getElementById('progress-button').onclick = renderStickerBook;
    
    // Update Mission Hub to use the Safe Start logic
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('start-mission-btn')) {
            safeStartMission(e.target.dataset.missionId);
        }
    });

    document.querySelectorAll('.home-button').forEach(btn => {
        btn.onclick = () => { 
            stopTimer(); 
            navigate('welcome-screen'); 
        };
    });
});

    </script>
</body>
</html>