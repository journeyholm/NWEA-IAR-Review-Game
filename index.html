<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic ELA Assessment-Prep Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<style>
        /* --- ANIMATED BACKGROUND --- */
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            /* FIX: Prevents double-tap zoom and improves mobile feel */
            touch-action: manipulation; 
        }
        .dark body {
            background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #533483);
            background-size: 400% 400%;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- GLASSMORPHISM UI --- */
        .game-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        /* FIX: Ensure question area is visible on small screens */
        #game-questions-area {
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: none;
            /* Prevents blue highlight on mobile tap */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fixed Headers for Readability */
        #shop-screen h2, #missions-screen h2, #progress-screen h2, #review-screen h2,
        #calibration-screen h2, #game-play-screen h2, #boss-round-screen h2 {
            padding-left: 1rem;
            color: #111827 !important;
        }
        
        .dark #shop-screen h2, .dark #missions-screen h2, .dark #progress-screen h2, 
        .dark #review-screen h2, .dark #calibration-screen h2, .dark #game-play-screen h2, 
        .dark #boss-round-screen h2 {
            color: #ffffff !important;
        }

        .hot-text-word { display: inline-block; margin: 0 2px; padding: 2px 4px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; }
        .hot-text-word.selected { background-color: #3b82f6; color: white; }
    </style>
</head>

<div id="welcome-screen" class="screen flex flex-col items-center justify-start text-center px-4 md:px-8 pb-8 pt-8 min-h-[60vh] relative">

    <div class="w-full max-w-5xl mx-auto flex flex-col md:flex-row justify-center items-center gap-12 bg-white/60 dark:bg-gray-800/60 backdrop-blur-lg border border-white/40 p-4 rounded-3xl shadow-lg mb-12">
        
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="relative group">
                <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg border-2 border-white dark:border-gray-700 transform transition group-hover:scale-110">
                    <span id="main-level-display">1</span>
                </div>
                <div class="absolute -bottom-2 -right-2 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-2 py-0.5 rounded-full border border-white shadow-sm">LVL</div>
            </div>

            <div class="flex flex-col items-start flex-grow">
                <div class="flex justify-between w-full text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wider">
                    <span>Experience</span>
                    <span id="main-xp-current-display"><span id="main-xp-current">0</span> / 100 XP</span>
                </div>
                <div class="w-48 h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner border border-black/5">
                    <div id="main-xp-bar" class="bg-gradient-to-r from-blue-400 to-indigo-500 h-full rounded-full transition-all duration-500 relative" style="width: 0%">
                        <div class="absolute top-0 left-0 w-full h-full bg-white/20 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 bg-yellow-100 dark:bg-yellow-900/40 px-4 py-2 rounded-xl border border-yellow-200 dark:border-yellow-700/50 shadow-sm">
                <span class="text-xl">ü™ô</span> 
                <div class="flex flex-col items-start leading-none">
                    <span id="main-token-display" class="font-bold text-yellow-800 dark:text-yellow-100 text-lg">0</span>
                    <span class="text-[10px] font-bold text-yellow-600 dark:text-yellow-400 uppercase">Tokens</span>
                </div>
            </div>

            <button id="theme-toggle-header" onclick="document.getElementById('theme-toggle').click()" class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </div>

    <h1 class="text-5xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-400 dark:via-purple-400 dark:to-pink-400 mb-2 drop-shadow-sm tracking-tight">ELA LEGENDS</h1>
        
        <div class="bg-white/60 dark:bg-black/40 backdrop-blur-md py-3 px-8 rounded-full shadow-sm mb-10 border border-white/20">
            <p class="text-xl md:text-2xl text-slate-900 dark:text-white font-bold">Master reading, writing, and logic to defeat the Glitch.</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl mb-8">
            <button id="start-calibration-button" class="button bg-gradient-to-br from-blue-500 to-blue-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-blue-400/20">
                <span class="text-3xl block mb-2">üßô‚Äç‚ôÇÔ∏è</span>Calibration Quest
            </button>
            <button onclick="startSurvival()" class="button bg-gradient-to-br from-red-600 to-orange-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-red-400/20 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-1 bg-black/20 rounded-bl-lg text-xs font-mono">HARDCORE</div>
                <span class="text-3xl block mb-2">üíÄ</span>The Gauntlet
            </button>
            <button id="missions-button" class="button bg-gradient-to-br from-emerald-500 to-emerald-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-emerald-400/20">
                <span class="text-3xl block mb-2">üìú</span>Daily Missions
            </button>
            <button id="shop-button" class="button bg-gradient-to-br from-amber-400 to-orange-600 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-amber-400/20">
                <span class="text-3xl block mb-2">üõçÔ∏è</span>The Shop
            </button>
            <button id="progress-button" class="button bg-gradient-to-br from-violet-500 to-purple-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-violet-400/20">
                <span class="text-3xl block mb-2">üìí</span>My Sticker Book
            </button>
            <button onclick="generateReport()" class="button bg-gradient-to-br from-slate-600 to-slate-800 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-slate-500/20">
                <span class="text-3xl block mb-2">üñ®Ô∏è</span>Teacher Report
            </button>
            <button id="archive-button" onclick="openArchive()" class="col-span-1 md:col-span-2 button bg-gradient-to-r from-red-600 to-rose-600 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-red-400/20 flex flex-col md:flex-row items-center justify-center gap-4 relative overflow-hidden group">
                 <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                 <span class="text-4xl animate-pulse">‚ö†Ô∏è</span> 
                 <span>Glitch Archive (Fix Mistakes & Study)</span>
            </button>
        </div>
        
<button id="reset-button" onclick="if(confirm('Are you sure? This deletes all progress!')) resetGame()" class="mt-8 text-gray-500 hover:text-red-500 text-sm font-semibold transition-colors bg-white/50 px-4 py-2 rounded-lg">Reset Save Data</button>    </div>

<div id="calibration-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-white shadow-md hover:bg-gray-100 transition-colors z-50">
                <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>

            <h2 class="text-3xl md:text-4xl font-bold mb-4 relative z-10">Calibration Quest</h2>

            <div class="inline-block bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm border border-white/40 rounded-lg px-4 py-2 mb-6 shadow-sm">
                <p class="text-slate-900 dark:text-gray-100 font-semibold text-lg">
                    Answer these questions to determine your starting level.
                </p>
            </div>

            <div id="calibration-content" class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-inner">
                <div id="question-area"></div>
                <div id="message-box" class="mt-4 p-4 rounded-lg hidden"></div>
                <div class="flex justify-end mt-6">
                    <button id="submit-answer-button" class="button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Submit Answer</button>
                </div>
            </div>
            <div id="calibration-results" class="hidden text-center mt-8">
                <h3 class="text-3xl font-bold text-green-600 dark:text-green-400 mb-4">Quest Complete!</h3>
                <p class="text-xl text-gray-700 dark:text-gray-300 mb-4">Your calibrated ELA level is: <span id="ela-level-display" class="font-extrabold text-blue-600 dark:text-blue-400"></span></p>
                <button id="start-missions-button" class="button bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Start Daily Missions üöÄ</button>
            </div>
        </div>



        <div id="missions-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Daily Missions Hub</h2>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Your current ELA proficiency level: <span id="proficiency-display" class="font-bold text-indigo-500"></span></p>
            <div id="missions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
        
<div id="game-play-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute z-10 p-3 rounded-full transition-transform hover:rotate-90">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 pl-12">
                <h2 id="game-title" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white drop-shadow-sm">Mission Title</h2>
                <div class="mt-4 md:mt-0 bg-white dark:bg-gray-800 px-6 py-2 rounded-full shadow-lg border border-gray-100 dark:border-gray-700">
<div class="flex items-center gap-6">
    <div class="flex items-center gap-2 text-amber-600 dark:text-amber-400 font-mono text-xl font-bold bg-amber-100 dark:bg-amber-900/50 px-3 py-1 rounded-lg border border-amber-200 dark:border-amber-700">
        <span>‚è±Ô∏è</span>
        <span id="game-timer">00:00</span>
    </div>

    <p class="text-lg font-bold text-indigo-600 dark:text-indigo-400">
        Score: <span id="mission-score-display" class="text-2xl">0</span>
        <span class="text-gray-400 mx-2">/</span>
        <span id="mission-total-questions">0</span>
    </p>
</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="game-passage" class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-md rounded-2xl p-8 shadow-xl border border-white/20 text-lg leading-relaxed font-serif text-gray-800 dark:text-gray-200 h-fit">
                    </div>

                <div class="flex flex-col">
                    <div id="game-questions-area" class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-2xl border-t-8 border-indigo-500 flex-grow">
                        </div>
                    
                    <div class="mt-6 flex justify-end gap-4">
                        </div>
                </div>
            </div>
            <div id="game-feedback-area" class="mt-6"></div>
        </div>

        <div id="shop-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">The Shop</h2>
            <div class="flex justify-between items-center mb-6 p-4 rounded-lg bg-yellow-100 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-700">
                <p class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">Your Tokens: <span id="token-display" class="font-extrabold text-yellow-900 dark:text-yellow-100">0</span> üí∞</p>
            </div>
            <div id="shop-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="progress-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">My Progress</h2>

<div class="mt-8">
                <h3 class="text-2xl font-bold mb-4">Mission History</h3>
                <table id="mission-history-table" class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-700">
                            <th class="p-4 rounded-tl-lg">Mission</th>
                            <th class="p-4">Score</th>
                            <th class="p-4">Date</th>
                            <th class="p-4">Tokens</th>
                            <th class="p-4 rounded-tr-lg">XP</th>
                        </tr>
                    </thead>
                    <tbody id="mission-history-body"></tbody>
                </table>
            </div>
        </div>

        <div id="review-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Mission Review</h2>
            <div id="review-content" class="space-y-8"></div>
        </div>

        <div id="boss-round-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10">
                <svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>
            <div class="flex flex-col items-center mb-6">
                <h2 class="text-4xl font-extrabold text-red-600 dark:text-red-500 mb-2">BOSS BATTLE: The Glitch</h2>
                <p class="text-gray-600 dark:text-gray-300">Fix the errors to defeat the Boss!</p>
                
                <div class="w-full max-w-3xl grid grid-cols-2 gap-8 mt-4">
                    <div class="text-center">
                        <p class="font-bold text-blue-600 dark:text-blue-400">YOU (Editor)</p>
                        <div class="w-full bg-gray-300 h-6 rounded-full overflow-hidden border-2 border-gray-400">
                            <div id="player-hp-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="font-bold text-red-600 dark:text-red-400">THE GLITCH</p>
                        <div class="w-full bg-gray-300 h-6 rounded-full overflow-hidden border-2 border-gray-400">
                            <div id="boss-hp-bar" class="bg-red-500 h-full transition-all duration-500" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="boss-battle-area" class="bg-white dark:bg-gray-800 rounded-xl p-8 shadow-2xl border-4 border-red-500 relative max-w-4xl mx-auto">
                <div id="boss-text-display" class="text-lg md:text-xl leading-relaxed font-serif">
                    </div>
            </div>

            <div id="editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform scale-100 transition-transform">
                    <h3 class="text-xl font-bold mb-4">How should this be written?</h3>
                    <div id="editor-options" class="space-y-3">
                        </div>
                    <button id="close-editor-modal" class="mt-4 text-gray-500 hover:text-gray-700 underline text-sm w-full text-center">Cancel</button>
                </div>
            </div>
        </div>
        
    </div>

<div id="archive-screen" class="screen hidden p-4 md:p-8 relative">
        <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-white shadow-md hover:bg-gray-100 transition-colors z-50">
            <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
        </button>
        <h2 class="text-3xl md:text-4xl font-bold mb-2 relative z-10 text-red-600 dark:text-red-400">‚ö†Ô∏è Glitch Archive</h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6 bg-white/50 dark:bg-gray-800/50 p-2 rounded inline-block">Study the skills and fix the corrupted files to earn XP!</p>
        
        <div id="archive-list" class="grid grid-cols-1 gap-6 max-w-3xl mx-auto"></div>
        
        <div id="archive-empty-msg" class="hidden text-center mt-12 bg-white/40 dark:bg-black/20 p-8 rounded-2xl border border-white/50">
            <div class="text-6xl mb-4">‚ú®</div>
            <h3 class="text-2xl font-bold text-gray-700 dark:text-gray-300">System Clean!</h3>
            <p class="text-gray-500">No glitches detected. You've mastered everything!</p>
            <button onclick="navigate('welcome-screen')" class="mt-4 bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-indigo-600">Return to Base</button>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-box" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center relative transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modal-title" class="text-2xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-4"></p>
            <button id="modal-ok-btn" class="button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

   <script>
// --- AUDIO SYSTEM (DISABLED) ---
        function playSound(type) { /* Sound removed by user request */ }

// --- Game State ---
        let gameState = {
            currentScreen: 'welcome',
            currentMission: null,
            currentQuestionIndex: 0,
            missionScore: 0,
            missionHistoryData: [], 
            streak: 0,
            // --- NEW: AI Classmates to compete against ---
            rivals: [
                { name: "Hermione G.", xp: 450, avatar: "üìö" },
                { name: "Percy J.", xp: 320, avatar: "üåä" },
                { name: "Katniss E.", xp: 600, avatar: "üèπ" },
                { name: "Miles M.", xp: 150, avatar: "üï∑Ô∏è" }
            ],
            user: {
                xp: 0,
                level: 1,
                elaLevel: 0,
                tokens: 0,
                badges: [],
                history: [],
                purchasedItems: [],
                stickers: []
            }
        };
// --- NEW: TIMER LOGIC ---
let missionTimerInterval;
let missionSeconds = 0;

function startTimer() {
    missionSeconds = 0;
    const display = document.getElementById('game-timer');
    clearInterval(missionTimerInterval);

    missionTimerInterval = setInterval(() => {
        missionSeconds++;
        const mins = Math.floor(missionSeconds / 60).toString().padStart(2, '0');
        const secs = (missionSeconds % 60).toString().padStart(2, '0');
        if(display) display.textContent = `${mins}:${secs}`;
    }, 1000);
}

function stopTimer() {
    clearInterval(missionTimerInterval);
    return missionSeconds;
}
        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalBox = document.getElementById('modal-box');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        // Calibration
        const calibrationContent = document.getElementById('calibration-content');
        const questionArea = document.getElementById('question-area');
        const messageBox = document.getElementById('message-box');
        const submitButton = document.getElementById('submit-answer-button');
        const calibrationResults = document.getElementById('calibration-results');
        const elaLevelDisplay = document.getElementById('ela-level-display');
        
        // Missions
        const missionsList = document.getElementById('missions-list');
        const gamePlayScreen = document.getElementById('game-play-screen');
        const gameTitle = document.getElementById('game-title');
        const gamePassage = document.getElementById('game-passage');
        const gameQuestionsArea = document.getElementById('game-questions-area');
        const nextQuestionButton = document.getElementById('next-question-button');
        const finishMissionButton = document.getElementById('finish-mission-button');
        const gameFeedbackArea = document.getElementById('game-feedback-area');
        const missionScoreDisplay = document.getElementById('mission-score-display');
        const missionTotalQuestions = document.getElementById('mission-total-questions');
        const proficiencyDisplay = document.getElementById('proficiency-display');
        
        // Progress & Shop
        const levelDisplay = document.getElementById('level-display');
        const xpDisplay = document.getElementById('xp-display');
        const xpBar = document.getElementById('xp-bar');
        const badgesDisplay = document.getElementById('badges-display');
        const missionHistoryBody = document.getElementById('mission-history-body');
        const tokenDisplay = document.getElementById('token-display');
        const shopItemsList = document.getElementById('shop-items-list');
        const reviewContent = document.getElementById('review-content');


// --- Game Data (Item Bank) ---
// --- STICKER COLLECTIONS DATA ---

const stickerCollections = {
    mythic: {
        name: "Mythic Set",
        items: ['üêâ','üßô‚Äç‚ôÇÔ∏è','üè∞','ü¶Ñ','‚öîÔ∏è','üõ°Ô∏è','üîÆ','üëë']
    },
    space: {
        name: "Cosmic Set",
        items: ['üöÄ','üëΩ','ü™ê','‚òÑÔ∏è','üë®‚ÄçüöÄ','üî≠','üõ∏','‚≠ê']
    },
    literature: {
        name: "Lit Legends",
        items: ['üìñ','üñãÔ∏è','üìú','üïØÔ∏è','üëì','üé≠','üßõ','üïµÔ∏è‚Äç‚ôÇÔ∏è']
    },
    animals: {
        name: "Wild Kingdom",
        items: ['ü¶Å','üêò','üê∏','ü¶ã','ü¶à','üêº','ü¶â','ü¶ä']
    },
    // --- NEW COLLECTIONS ---
    foodie: {
        name: "Snack Attack",
        items: ['üçï','üçî','üçü','üç£','üç©','üç¶','ü•ë','üåÆ']
    },
    sports: {
        name: "MVP Sports",
        items: ['‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','ü•ä','üèÜ']
    },
    music: {
        name: "Rock Star",
        items: ['üé∏','üéπ','ü•Å','üé∑','üé∫','üé§','üéß','üéº']
    },
    travel: {
        name: "World Traveler",
        items: ['‚úàÔ∏è','üóΩ','üóº','üèùÔ∏è','‚õ∞Ô∏è','‚õ∫','üó∫Ô∏è','üóø']
    }
};

// --- UPDATED: RETEACH MINI-LESSONS (The Tutor) ---
const skillLessons = {
    // --- VOCABULARY ---
    'L.8.4.b': "<b>Greek & Latin Roots:</b> 'Bene' means Good (benefit). 'Mal' means Bad (malfunction). 'Spect' means Look (inspect). Memorize these to decode unknown words.",
    'L.8.5.b': "<b>Analogies:</b> Look for the relationship! Is it Part-to-Whole (Chapter : Book)? Tool-to-User (Microscope : Biologist)? Synonym/Antonym? Match that exact relationship.",
    
    // --- GRAMMAR ---
    'L.8.1.c': "<b>Verb Moods:</b> <br>‚Ä¢ <i>Indicative:</i> A fact (The sky is blue).<br>‚Ä¢ <i>Imperative:</i> A command (Go away).<br>‚Ä¢ <i>Subjunctive:</i> A wish or 'what if' (If I were you...).<br>‚Ä¢ <i>Interrogative:</i> A question.",
    'L.8.3.a': "<b>Active vs. Passive Voice:</b> <br>‚Ä¢ <i>Active:</i> The subject DOES the action (The boy kicked the ball).<br>‚Ä¢ <i>Passive:</i> The action happens TO the subject (The ball was kicked by the boy). Active is usually stronger!",
    'SAT.Convention.1': "<b>Sentence Boundaries:</b> Watch out for Run-Ons! You cannot connect two complete sentences with just a comma. Use a period, a semicolon (;), or a comma + conjunction (FANBOYS).",

'L.8.2.a': "<b>Punctuation (Ellipses & Dashes):</b> <br>‚Ä¢ Use an <b>Ellipsis (...)</b> to show a pause or omitted words.<br>‚Ä¢ Use a <b>Dash (‚Äî)</b> to show a sudden break, interruption, or to emphasize extra info.",
    'L.8.2.c': "<b>Confused Words:</b> <br>‚Ä¢ <i>Effect</i> is usually a Noun (The result).<br>‚Ä¢ <i>Affect</i> is usually a Verb (To change).<br>‚Ä¢ <i>Principal</i> is your pal (Person). <i>Principle</i> is a rule.",
    'RI.8.6': "<b>Point of View:</b> Does the author agree or disagree with the topic? Look for 'charged' words (e.g., 'disastrous' vs. 'innovative') to find their true opinion.",
    // --- READING LITERATURE ---
    'RL.8.6': "<b>Irony & Suspense:</b> <br>‚Ä¢ <i>Situational Irony:</i> The opposite of what you expect happens (e.g., a fire station burns down).<br>‚Ä¢ <i>Suspense:</i> Authors use short sentences, silence, and sensory details (heartbeat, creaking) to build tension.",
    'RL.9.3': "<b>Character Motivation:</b> Why did they do that? Look for the internal desire (revenge, love, fear) that drives the external action.",
    'RL.8.4': "<b>Metaphor & Simile:</b> A Simile uses 'like' or 'as' (Fast as a cheetah). A Metaphor says one thing IS another (Life is a highway).",

    // --- READING INFORMATIONAL ---
    'RI.8.8': "<b>Evaluating Arguments:</b> Does the author have PROOF? Look for statistics, studies, and expert quotes. Beware of 'Anecdotal Evidence' (just one person's story).",
    'RI.8.2': "<b>Central Idea:</b> What is the 'Big Picture'? Read the first and last sentence of the passage. The title is also a huge clue!",
    'RI.8.5': "<b>Text Structure:</b> How is it built?<br>‚Ä¢ <i>Compare/Contrast:</i> similarities/differences.<br>‚Ä¢ <i>Problem/Solution:</i> Explains an issue and how to fix it.<br>‚Ä¢ <i>Chronological:</i> Time order.",
    'W.8.8': "<b>Research Credibility:</b> Trust experts (.edu, .gov, organizations), not random blogs. Check the date: is the info current?",

    'RL.8.4.sound': "<b>Sound Devices:</b> <br>‚Ä¢ <i>Alliteration:</i> Repeated beginning sounds (Peter Piper picked).<br>‚Ä¢ <i>Assonance:</i> Repeated VOWEL sounds inside words (The r<b>ai</b>n in Sp<b>ai</b>n).",
    'RI.8.8.eval': "<b>Evidence Strength:</b> <br>‚Ä¢ <i>Relevant:</i> Directly supports the claim.<br>‚Ä¢ <i>Irrelevant:</i> Off-topic.<br>‚Ä¢ <i>Sufficient:</i> Is there ENOUGH proof, or just one example?",

    'W.8.2.c': "<b>Sentence Placement:</b> Good writing flows logically. <br>‚Ä¢ Look for <i>transition words</i> (However, Therefore).<br>‚Ä¢ Look for <i>pronouns</i> (It, He, They) referring to a previous noun.<br>‚Ä¢ Keep 'Time' and 'Action' in order.",
    'RL.8.9': "<b>Modern vs. Traditional:</b> Authors often retell old myths in modern settings.<br>‚Ä¢ Look for matching <i>character traits</i> (e.g., a strong warrior becomes a quarterback).<br>‚Ä¢ Look for similar <i>conflicts</i> or <i>themes</i>.",
    'L.8.4.a': "<b>Context Clues (Academic):</b> When you see a tough 'Science' or 'History' word, look at the sentences <i>around</i> it. Is there a definition, an example, or a contrast word (unlike, but) nearby?",
};

// ======================================================
// üöÄ MASTER CONTENT DATABASE (NWEA + SAT + STORY)
// ======================================================

// ======================================================
// üöÄ THE MEGA MASTER ITEM BANK: 800% CONTENT BOOST
// ======================================================

const itemBank = [
    // ==========================================
    // TIER 1: ROOKIE (Foundational - 25 Questions)
    // ==========================================
    {
        type: 'mission', id: 'rok-lit-confetti', genre: 'literature',
        passage: "from Confetti Girl: 'Mom always had after-school projects waiting for me... Dad helps, but sometimes he makes a big mess. Like today. He's got flour, potato skins, and crumpled napkins on the counter... How mad can a girl be at a man who... wears a green frog apron that says KISS THE COOK and tube socks over his hands for potholders?'",
        items: [
            { id: 'rok1a', stem: "What is the meaning of 'sarcasm' as used in paragraph 18?", options: ["a remark indicating mockery and annoyance", "a response that is meant to be taken literally", "an answer that indicates confusion or skepticism", "an observation that is silly and childish"], correct_answer: "a remark indicating mockery and annoyance", rationale: "Paragraph 18 explains how the father is used to 'mockery' from his students and ignores the daughter's biting tone.", standard: "L.8.4", difficulty: 2 },
            { id: 'rok1b', stem: "Which quotation from the passage helps clarify the meaning of sarcasm?", options: ["'Super... super... super something.'", "'It could have been super-duper or super-loop for all I care.'", "'So did I tell you we're having a book sale...?'", "'Yes, that's it. But I left it in my locker.'"], correct_answer: "'It could have been super-duper or super-loop for all I care.'", rationale: "This quote shows the narrator's dismissive and mocking attitude toward her father's academic interests.", standard: "L.8.4", difficulty: 3 },
            { id: 'rok1c', stem: "What attitude does the narrator reveal by using the book as a coaster in paragraph 34?", options: ["worry about finishing schoolwork", "dishonesty in lying to her father", "carelessness with household chores", "resentment of her father's efforts to impose his interests"], correct_answer: "resentment of her father's efforts to impose his interests", rationale: "Using the book as a coaster is a symbolic act of rejecting her father's obsession with literature.", standard: "RL.8.1", difficulty: 3 },
            { id: 'rok1d', stem: "Which detail shows that the father does not take himself too seriously?", options: ["He ignores his daughter's sarcasm", "He wears a green frog apron", "He asks about vocabulary words", "He searches for a copy of a novel"], correct_answer: "He wears a green frog apron", rationale: "Paragraph 11 describes him wearing a 'green frog apron' and 'tube socks' as potholders, showing self-deprecating humor.", standard: "RL.8.3", difficulty: 1 },
            { id: 'rok1e', stem: "How does the author create tension in paragraph 26?", options: ["By describing the father's cooking", "By showing the father abandon his food to hunt for a book", "By having the daughter leave the table", "By mentioning the cold beans"], correct_answer: "By showing the father abandon his food to hunt for a book", rationale: "The daughter feels her father prioritizes 'books and vocabulary words' over her, creating emotional distance.", standard: "RL.8.1", difficulty: 3 },
            { id: 'rok1f', stem: "The word 'coordinated' in paragraph 1 most nearly means...", options: ["graceful and skillful", "organized and neat", "social and outgoing", "loud and demanding"], correct_answer: "graceful and skillful", rationale: "The text explains she wasn't 'coordinated' with her left hand, making her painting look messy.", standard: "L.8.4", difficulty: 2 },
            { id: 'rok1g', stem: "What does the father mean when he says 'super' is a prefix that means 'above and beyond'?", options: ["The words are very hard", "Prefixes can help determine meaning", "English class is unnecessary", "Vocabulary is the only thing that matters"], correct_answer: "Prefixes can help determine meaning", rationale: "He is teaching her a decoding strategy to understand complex words.", standard: "L.8.4.b", difficulty: 3 },
            { id: 'rok1h', stem: "Which sentence best supports the idea that the father and daughter have 'rules'?", options: ["'Dad helps, but sometimes he makes a big mess.'", "'I cook while Dad cleans‚Äîthat's our rule.'", "'Thought I'd give you a break.'", "'Everything's great until he asks about English.'"], correct_answer: "'I cook while Dad cleans‚Äîthat's our rule.'", rationale: "This explicitly states the division of labor in their household.", standard: "RL.8.1", difficulty: 1 }
        ]
    },
    {
        type: 'mission', id: 'rok-lit-tortilla', genre: 'literature',
        passage: "from Tortilla Sun: 'Clang cla-clang... I found Mom in the kitchen with a chisel and hammer, chipping away at the kitchen counter... I stormed off to my room and threw myself onto my bed. I ached inside. Like the feeling you get watching a lost balloon float far into the sky until it becomes an invisible nothing.'",
        items: [
            { id: 'rok2a', stem: "How do the phrases 'stormed off' and 'invisible nothing' in paragraph 35 contribute to the tone?", options: ["They show guilt and disappointment", "They emphasize growing hopelessness", "They reflect comforting daydreams", "They highlight independence"], correct_answer: "They emphasize growing hopelessness", rationale: "The imagery of a balloon disappearing into 'nothing' reflects the narrator's feeling of powerlessness.", standard: "RL.8.4", difficulty: 3 },
            { id: 'rok2b', stem: "Which paragraph most directly reinforces the narrator's feeling of loss?", options: ["paragraph 32", "paragraph 37", "paragraph 38", "paragraph 39"], correct_answer: "paragraph 38", rationale: "In paragraph 38, the narrator scratches out the word 'opportunity' until it is a 'big blob of blue ink,' showing her rejection of the move.", standard: "RL.8.1", difficulty: 3 },
            { id: 'rok2c', stem: "Which statement provides an objective summary of the passage?", options: ["A mother neglects her daughter for a degree", "A mother decides they will move to another country", "A girl learns she is being sent to New Mexico for the summer and becomes withdrawn", "A girl believes her father is a better parent"], correct_answer: "A girl learns she is being sent to New Mexico for the summer and becomes withdrawn", rationale: "The summary captures the main event (the summer move) and the daughter's emotional response.", standard: "RL.8.2", difficulty: 2 },
            { id: 'rok2d', stem: "Why is the baseball important to the narrator in paragraph 46?", options: ["It is a valuable collectible", "It belonged to her father and makes her feel connected to him", "She intends to play a game in New Mexico", "She stole it to make her mother angry"], correct_answer: "It belonged to her father and makes her feel connected to him", rationale: "Holding the baseball allows her to grip onto a piece of her identity linked to her father.", standard: "RL.8.1", difficulty: 2 },
            { id: 'rok2e', stem: "What does the narrator mean when she says New Mexico is 'worlds away' from California?", options: ["It is on another planet", "The culture and distance feel extreme and isolating", "She hates the desert", "She wants to live in a city"], correct_answer: "The culture and distance feel extreme and isolating", rationale: "She views the move as a total displacement from the life she knows.", standard: "L.8.5", difficulty: 3 },
            { id: 'rok2f', stem: "The mother's response 'You're going to New Mexico and that's final' shows she is...", options: ["Angry and hateful", "Determined to finish her research", "Lazy and uncaring", "Forgetful"], correct_answer: "Determined to finish her research", rationale: "She is making a firm decision to enable her to finish her work in Costa Rica.", standard: "RL.8.3", difficulty: 2 },
            { id: 'rok2g', stem: "What is implied by the mother's phone conversation in paragraph 17?", options: ["She is hiding a secret", "The move has been planned for a while", "She is talking to the narrator's father", "She is lost"], correct_answer: "The move has been planned for a while", rationale: "Izzy realizes the 'phone call made perfect sense' once she hears about the New Mexico plan.", standard: "RL.8.1", difficulty: 3 },
            { id: 'rok2h', stem: "The narrator's story card about 'Gypsy' being tossed in a dungeon is an example of...", options: ["A flashback", "Parallelism with her own feelings", "A prediction of the future", "A historical fact"], correct_answer: "Parallelism with her own feelings", rationale: "She uses the story to process her own feelings of being 'trapped' by her mother's choices.", standard: "RL.8.6", difficulty: 3 },
            { id: 'rok2i', stem: "Which word best describes the mother's tone in paragraph 45?", options: ["Demanding", "Muffled and pleading", "Cold and distant", "Excited and loud"], correct_answer: "Muffled and pleading", rationale: "The text says her voice was 'muffled' and she asks 'Would you please talk to me?'.", standard: "RL.8.4", difficulty: 2 }
        ]
    },

    // ==========================================
    // TIER 2: SCHOLAR (Proficient - 25 Questions)
    // ==========================================
    {
        type: 'mission', id: 'sch-borer-info', genre: 'informational',
        passage: "from Emerald Ash Borer: 'The emerald ash borer is a small, green beetle... During its life cycle, EAB undergoes a complete metamorphosis. It starts as an egg, becomes a larva, then changes to become a pupa and then an adult... EAB is an insect that is not native to North America.'",
        items: [
            { id: 'sch1a', stem: "How does the author organize the information about the emerald ash borer?", options: ["providing general facts followed by a statement of a problem", "defining the problem followed by proposed action", "presenting a problem followed by a solution", "listing facts in order of importance"], correct_answer: "providing general facts followed by a statement of a problem", rationale: "The passage first defines the beetle and its life cycle before introducing the 'Problem' section in paragraph 5.", standard: "RI.8.5", difficulty: 5 },
            { id: 'sch1b', stem: "How does paragraph 3 contribute to the organizational pattern?", options: ["showing significance of facts", "explaining how to prevent infestations", "providing scientific names of species", "contrasting the food sources of mature and immature EABs"], correct_answer: "contrasting the food sources of mature and immature EABs", rationale: "Paragraph 3 explains that larvae feed on phloem while adults feed on leaves.", standard: "RI.8.5", difficulty: 5 },
            { id: 'sch1c', stem: "What is the meaning of 'established' as it is used in paragraph 5?", options: ["in a strong position permitting growth", "proven beyond a doubt", "well known and respected", "accepted as a rule or law"], correct_answer: "in a strong position permitting growth", rationale: "The text states the beetle is 'established' in several states, meaning it has successfully inhabited the area.", standard: "L.8.4", difficulty: 6 },
            { id: 'sch1d', stem: "Based on the passage, what is one conclusion that can be drawn?", options: ["EAB habits are harmful to ash trees", "EAB is the most destructive buprestid", "EAB causes problems for homeowners", "Laws are needed to protect ash trees"], correct_answer: "EAB habits are harmful to ash trees", rationale: "Larvae feed on inner bark, which is vital for nutrient transport, effectively killing the tree.", standard: "RI.8.1", difficulty: 4 },
            { id: 'sch1e', stem: "Which phrase helps the reader understand the meaning of 'established'?", options: ["'not native'", "'first found'", "'several years previous'", "'found in 12 states'"], correct_answer: "'found in 12 states'", rationale: "Widespread distribution across 12 states indicates the population has taken hold.", standard: "L.8.4", difficulty: 5 },
            { id: 'sch1f', stem: "Why does the author include paragraph 5?", options: ["understand damage types", "understand why issue didn't exist in the previous century", "understand how EAB exists in trees", "understand where EAB travels next"], correct_answer: "understand why issue didn't exist in the previous century", rationale: "It explains the borer was first found in 2002 and likely arrived on woody packaging.", standard: "RI.8.1", difficulty: 7 },
            { id: 'sch1g', stem: "Successive 'instars' refer to what according to the text?", options: ["Flight patterns", "Larval growth stages", "Mating rituals", "Winter nests"], correct_answer: "Larval growth stages", rationale: "Paragraph 2 explicitly defines instars as growth stages.", standard: "L.8.4.b", difficulty: 4 },
            { id: 'sch1h', stem: "Movement of ash wood has been 'cited' as a likely means of spread. 'Cited' means...", options: ["Ignored", "Reversed", "Mentioned as evidence", "Canceled"], correct_answer: "Mentioned as evidence", rationale: "The text uses 'cited' to identify the cause of the spread.", standard: "L.8.4", difficulty: 5 }
        ]
    },
    {
        type: 'mission', id: 'sch-snow-info', genre: 'informational',
        passage: "from 'A Beginner's Guide to Snowboarding': 'higher-end gear can give you much more control, which generally results in less falling... you need to figure out which direction you'll face when riding down the mountain also known as your stance... if your left foot is in front, you ride \"regular,\" and if your right foot is in front, you ride \"goofy.\"'",
        items: [
            { id: 'sch2a', stem: "In paragraph 3, how does the author connect professionals and amateurs?", options: ["suggesting both need high-quality equipment", "contrasting equipment types", "comparing equipment selection", "implying sales associates treat them differently"], correct_answer: "suggesting both need high-quality equipment", rationale: "The author argues higher-end gear provides more control and comfort even for beginners.", standard: "RI.8.3", difficulty: 5 },
            { id: 'sch2b', stem: "Which sentence shows the author's purpose is to promote snowboarding?", options: ["'Snowboarding is fun and good for you.'", "'Basics are important to avoid bad habits.'", "'Go slow at first.'", "'Falling is part of learning.'"], correct_answer: "'Snowboarding is fun and good for you.'", rationale: "This statement highlights the positive aspects of the sport to encourage the reader.", standard: "RI.8.6", difficulty: 4 },
            { id: 'sch2c', stem: "What does the author suggest about 'Goofy' stance?", options: ["It is for children", "It means riding with the right foot forward", "It is harder than regular", "It is only for surfing"], correct_answer: "It means riding with the right foot forward", rationale: "Paragraph 5 defines the goofy stance based on foot placement.", standard: "RI.8.1", difficulty: 4 },
            { id: 'sch2d', stem: "Which detail supports the idea that snowboarding is physically demanding?", options: ["'Kids think you're cool'", "'Burn 500 calories an hour'", "'Local shop will hook you up'", "'Sunny with soft snow'"], correct_answer: "'Burn 500 calories an hour'", rationale: "High calorie burning indicates significant physical exertion.", standard: "RI.8.1", difficulty: 5 },
            { id: 'sch2e', stem: "What is the 'bonus point' mentioned in paragraph 2?", options: ["Winning a race", "Having a hot tub", "Buying a new board", "Finding a cheap rental"], correct_answer: "Having a hot tub", rationale: "The author humorously suggests a hot tub is a major plus after a day of snowboarding.", standard: "RI.8.1", difficulty: 4 },
            { id: 'sch2f', stem: "The author compares snowboarding to skiing to show that they are...", options: ["Almost identical", "Completely different", "Equally expensive", "Both dangerous"], correct_answer: "Completely different", rationale: "Paragraph 11 lists specific mechanical differences between the two sports.", standard: "RI.8.5", difficulty: 5 },
            { id: 'sch2g', stem: "What advice is given for getting on and off a chairlift?", options: ["Jump early", "Ask the operator to slow it down", "Don't use the lift", "Hold onto a friend"], correct_answer: "Ask the operator to slow it down", rationale: "Paragraph 7 suggests slowing the chair to help beginners.", standard: "RI.8.1", difficulty: 4 },
            { id: 'sch2h', stem: "The tone of this guide can best be described as...", options: ["Strict and angry", "Helpful and encouraging", "Sarcastic and mean", "Bored and detached"], correct_answer: "Helpful and encouraging", rationale: "The author shares personal tips and emphasizes that the reader will be 'just fine'.", standard: "RI.8.4", difficulty: 5 },
            { id: 'sch2i', stem: "What is 'edge control' in the context of the passage?", options: ["A gear type", "Keeping the board from catching the snow", "Buying a specific boot", "Stopping at the edge of the hill"], correct_answer: "Keeping the board from catching the snow", rationale: "Paragraph 9 describes edge control as vital to starting out.", standard: "L.8.4", difficulty: 6 }
        ]
    },

    // ==========================================
    // TIER 3: LEGEND (Advanced - 25 Questions)
    // ==========================================
    {
        type: 'mission', id: 'leg-elephant-trunk', genre: 'scientific',
        passage: "from 'Elephants Can Lend a Helping Trunk': 'The pachyderms understand that they will fail at a task without a partner's assistance... Elephants now join an elite club of social cooperators... It's particularly striking that the elephants were able to \"inhibit pulling\" longer than chimpanzees do.'",
        items: [
            { id: 'leg1a', stem: "The key terms 'cognition' and 'cognitive' in paragraphs 1 and 4 refer to...", options: ["physical strength", "emotional expression", "mental awareness", "visual sensitivity"], correct_answer: "mental awareness", rationale: "The context of 'understanding' and 'recognizing' needs indicates a mental process.", standard: "RI.8.4", difficulty: 8 },
            { id: 'leg1b', stem: "How does paragraph 4 contribute to the article's topic?", options: ["summarizes other animal research", "emphasizes that findings are original and important", "questions the assertion of researchers", "shows elephant study challenged previous work"], correct_answer: "emphasizes that findings are original and important", rationale: "Paragraph 4 includes quotes from other scientists who describe the experiment as 'clever'.", standard: "RI.8.5", difficulty: 9 },
            { id: 'leg1c', stem: "How does the photograph help readers understand technical information?", options: ["illustrates pairs waiting", "demonstrates natural behavior", "clarifies how objects in the experiment were set up", "shows how the rope might slip"], correct_answer: "clarifies how objects in the experiment were set up", rationale: "The photo visualizes the PVC frame, rope, and net apparatus used in the task.", standard: "RI.8.7", difficulty: 8 },
            { id: 'leg1d', stem: "What was the purpose of the 'hand signal' mahouts were given?", options: ["guaranteeing elephants made own choices", "keeping elephants calm", "preventing misunderstanding", "protecting researchers"], correct_answer: "guaranteeing elephants made own choices", rationale: "Using a signal the elephants couldn't see ensured the mahouts weren't cuing the animals to pull.", standard: "RI.8.8", difficulty: 10 },
            { id: 'leg1e', stem: "The success rate chart builds on the passage by...", options: ["providing specific time release data", "confirming testing intervals", "showing rope length", "recording mahout distance"], correct_answer: "providing specific time release data", rationale: "The chart displays success percentages based on release intervals (s <= 25 and 26 <= s <= 45).", standard: "RI.8.7", difficulty: 9 },
            { id: 'leg1f', stem: "The study showed elephants could 'inhibit pulling.' 'Inhibit' means...", options: ["Encourage", "Restrain or prevent", "Speed up", "Ignore"], correct_answer: "Restrain or prevent", rationale: "The elephants had to stop themselves from pulling until the partner arrived.", standard: "L.8.4", difficulty: 8 },
            { id: 'leg1g', stem: "Why did the researchers use 'sliding tables' and 'rope'?", options: ["To play a game", "To require simultaneous effort from two animals", "To test physical strength", "To feed the animals quickly"], correct_answer: "To require simultaneous effort from two animals", rationale: "The table could only be moved if both ends of the rope were pulled together.", standard: "RI.8.1", difficulty: 8 },
            { id: 'leg1h', stem: "What does the phrase 'elite club' imply about social cooperators?", options: ["They are wealthy", "The ability to cooperate is rare in the animal kingdom", "They live in Thailand", "They are all mammals"], correct_answer: "The ability to cooperate is rare in the animal kingdom", rationale: "Paragraph 1 states this level of cognition is 'rarely found in other species'.", standard: "L.8.5", difficulty: 9 }
        ]
    },
    {
        type: 'mission', id: 'leg-balabad-lit', genre: 'literature',
        passage: "from The Seven Keys of Balabad: 'Bahauddin Shah stumbled through the darkened passageway... gripping the cold stone wall for balance... The old man wore a heavy iron key chain around his belt, and it weighed down on him in more ways than one. There was so little time!'",
        items: [
            { id: 'leg2a', stem: "Which sentence states a central idea of the passage?", options: ["Shah is lost and frightened", "Shah is the guardian of a secret for city survival", "The caverns are a hiding place", "Invaders are in hostile territory"], correct_answer: "Shah is the guardian of a secret for city survival", rationale: "Shah is on the 'most important mission of his life' carrying keys to protect his people.", standard: "RL.8.2", difficulty: 8 },
            { id: 'leg2b', stem: "How does paragraph 1 help develop the plot?", options: ["creates admiration", "establishes conflict", "creates suspense via sensory details", "foreshadows rising action"], correct_answer: "creates suspense via sensory details", rationale: "Details like the 'darkened passageway' and 'thumping' heart build tension.", standard: "RL.8.5", difficulty: 8 },
            { id: 'leg2c', stem: "What aspect of Shah's character is revealed throughout?", options: ["He does not give up in difficulty", "He takes his position seriously", "He is concerned for citizens", "He has confidence city is untouched"], correct_answer: "He takes his position seriously", rationale: "Shah's determination to reach the surface with the keys shows his dedication to his role.", standard: "RL.8.3", difficulty: 9 },
            { id: 'leg2d', stem: "What inference can be made about Shah from paragraph 2?", options: ["He was too weak", "He felt a great responsibility", "He was worried about the weight", "He felt keys were a symbol of authority"], correct_answer: "He felt a great responsibility", rationale: "The keys weighing on him 'in more ways than one' refers to the heavy emotional burden of his task.", standard: "RL.8.1", difficulty: 9 },
            { id: 'leg2e', stem: "The comparison of Shah's body to a 'falcon returning to his master's arm' implies...", options: ["He is fast", "He has an instinctive knowledge of the caves", "He is being controlled", "He wants to fly"], correct_answer: "He has an instinctive knowledge of the caves", rationale: "He knows 'every corner' and is naturally drawn to the exit.", standard: "L.8.5", difficulty: 9 },
            { id: 'leg2f', stem: "The 'thud of cannon fire' in paragraph 9 indicates...", options: ["Construction", "An ongoing attack on the city", "A celebration", "A storm"], correct_answer: "An ongoing attack on the city", rationale: "The context of 'invaders' and 'outsiders' confirms a military conflict.", standard: "RL.8.1", difficulty: 8 },
            { id: 'leg2g', stem: "What does 'Baladis are survivors' reveal about Shah's outlook?", options: ["He is hopeless", "He is resilient and optimistic about the future", "He wants to leave", "He is angry"], correct_answer: "He is resilient and optimistic about the future", rationale: "He believes his people will 'rebuild' even after destruction.", standard: "RL.8.3", difficulty: 9 },
            { id: 'leg2h', stem: "Why was the tunnel exit a 'small shaft... straight up from the stone ceiling'?", options: ["It was a chimney", "To remain a secret hidden from outsiders", "It was broken", "To let in light"], correct_answer: "To remain a secret hidden from outsiders", rationale: "The text says 'you would never have seen it' if you didn't know where to look.", standard: "RL.8.1", difficulty: 8 }
        ]
    }
];

// --- SYNCED MISSION DATA ---
// --- SYNCED MISSION DATA ---
const allMissions = [
    { id: 'm-confetti', title: 'The Root Cellar', description: 'Mastering RI.8.1: Citing Evidence (Confetti Girl)', difficulty: 2, passageId: 'rok-lit-confetti', minLevel: 1 },
    { id: 'm-tortilla', title: 'Verb Vault', description: 'Mastering RL.8.2: Tone & Summary (Tortilla Sun)', difficulty: 3, passageId: 'rok-lit-tortilla', minLevel: 1 },
    { id: 'm-borer', title: 'Heat Island Effect', description: 'Mastering RI.8.5: Text Structure (Emerald Borer)', difficulty: 5, passageId: 'sch-borer-info', minLevel: 1 },
    { id: 'm-snow', title: 'AI Awareness', description: 'Mastering RI.8.6: Author Purpose (Snowboarding)', difficulty: 6, passageId: 'sch-snow-info', minLevel: 2 },
    { id: 'm-elephants', title: 'Classic Paradox', description: 'Mastering RI.8.4: Scientific Analysis (Elephants)', difficulty: 8, passageId: 'leg-elephant-trunk', minLevel: 2 },
    { id: 'm-balabad', title: 'Arachosia Keys', description: 'Mastering RL.8.2: Complex Plot (Balabad)', difficulty: 10, passageId: 'leg-balabad-lit', minLevel: 2 },
    { id: 'final-exam', title: 'üèÜ THE FINAL GAUNTLET', description: 'Cumulative Exam: Levels 1-10. Double XP!', difficulty: 10, passageId: 'EXAM', minLevel: 3 }
];

// --- MISSIONS HUB: ADAPTIVE TIERING ---
function renderMissionQuestion() {
    // 1. Find the passage block
    const missionItem = itemBank.find(zone => 
        zone.id === gameState.currentMission.passageId || 
        zone.genre === gameState.currentMission.id
    );
    
    if (!missionItem) {
        showModal("Error", "Mission content not found!", "error");
        navigate('missions-screen');
        return;
    }

    // 2. Identify the specific question in the set
    const currentItem = missionItem.items[gameState.currentQuestionIndex];
    
    // 3. If no more questions in this set, end the mission
    if (!currentItem) { 
        endMission(missionItem.items.length); 
        return; 
    }
    
    // 4. Update UI
    gameTitle.textContent = gameState.currentMission.title;
    missionScoreDisplay.innerHTML = `${gameState.missionScore}`;
    missionTotalQuestions.textContent = missionItem.items.length;

    gamePassage.innerHTML = `<p class="font-bold mb-2 text-lg text-indigo-600 uppercase tracking-tight">Reading Passage</p>
                             <div class="prose dark:prose-invert max-w-none font-serif">${missionItem.passage}</div>`;

    gameQuestionsArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-sm text-indigo-500 uppercase mb-1">Question ${gameState.currentQuestionIndex + 1} of ${missionItem.items.length}</p>
            <p class="mb-4 text-xl font-semibold leading-snug">${currentItem.stem}</p>
            <div id="options-container" class="space-y-3">
                ${currentItem.options.map(opt => `
                    <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 cursor-pointer hover:bg-indigo-50 transition-all">
                        <input type="radio" name="mission-q" value="${opt}" class="mt-1 mr-3 w-5 h-5">
                        <span class="flex-1 text-base">${opt}</span>
                    </label>`).join('')}
            </div>
        </div>`;

    renderSubmitButton(currentItem, missionItem.items.length);
}

// --- NEW BOSS BATTLE DATA ---
        const bossBattles = [
{
                id: 'boss-1',
                title: 'The Run-On Robot',
                bossMaxHP: 3, 
                passageParts: [
                    { text: "The concept of artificial intelligence has existed for centuries, " },
                    { 
                        type: 'error', id: 'err1',
                        original: "however, modern computers made it a reality.",
                        // FIX: clearer options to teach semicolon vs FANBOYS
                        options: ["NO CHANGE", "however; modern computers made it a reality.", "but modern computers made it a reality.", "modern computers, made it a reality."],
                        correctIndex: 2,
                        rationale: "Comma Splice Fix: You cannot join two sentences with just a comma and 'however'. Use a conjunction like 'but', or use a semicolon."
                    },
                    { text: " Early computers were massive machines " },
                    { 
                        type: 'error', id: 'err2',
                        original: "that took up entire rooms.",
                        options: ["NO CHANGE", "who took up entire rooms.", "they took up entire rooms.", "it took up entire rooms."],
                        correctIndex: 0,
                        rationale: "Relative Pronouns: Use 'that' for objects (machines). Use 'who' for people."
                    },
                    { text: " Today, we carry more processing power in our pockets " },
                    { 
                        type: 'error', id: 'err3',
                        original: "then NASA had during the moon landing.",
                        options: ["NO CHANGE", "than NASA had during the moon landing.", "then NASA has during the moon landing.", "than NASA has during the moon landing."],
                        correctIndex: 1,
                        rationale: "Word Choice: 'Than' is for comparisons (more than). 'Then' is for time."
                    }
                ]
            },

            {
                id: 'boss-2',
                title: 'Captain Comma',
                bossMaxHP: 3,
                passageParts: [
                    { text: "Cooking is my favorite hobby, " },
                    {
                        type: 'error', id: 'cc1',
                        original: "I make dinner every night.",
                        options: ["NO CHANGE", "I make dinner, every night.", "so I make dinner every night.", "I make dinner every night"],
                        correctIndex: 2,
                        rationale: "Comma Splice! You cannot join two sentences with just a comma. You need a conjunction like 'so'."
                    },
                    { text: " My specialties include lasagna, tacos " },
                    {
                        type: 'error', id: 'cc2',
                        original: "and, spicy curry.",
                        options: ["NO CHANGE", "and spicy curry.", "and spicy, curry.", "and: spicy curry."],
                        correctIndex: 1,
                        rationale: "No comma is needed after 'and' in a simple list unless it's an Oxford comma situation, but the comma here breaks the flow."
                    },
                    { text: " My friends say I should open a restaurant " },
                    {
                        type: 'error', id: 'cc3',
                        original: "because, my food is delicious.",
                        options: ["NO CHANGE", "because my food is delicious.", "because; my food is delicious.", "because my food, is delicious."],
                        correctIndex: 1,
                        rationale: "Do not put a comma before 'because' when it follows the main clause."
                    }
                ]
            },

            {
                id: 'boss-3',
                title: 'The Modifier Monster',
                bossMaxHP: 3,
                passageParts: [
                    { text: "Walking down the street, " },
                    {
                        type: 'error', id: 'mm1',
                        original: "the trees looked beautiful.",
                        options: ["NO CHANGE", "I saw the beautiful trees.", "the trees were looking beautiful.", "beauty was seen in the trees."],
                        correctIndex: 1,
                        rationale: "Dangling Modifier: The 'trees' were not walking down the street! YOU were. The subject (I) must immediately follow the introductory phrase."
                    },
                    { text: " hungry after the long walk, " },
                    {
                        type: 'error', id: 'mm2',
                        original: "the pizza shop smelled amazing.",
                        options: ["NO CHANGE", "the smell of pizza was amazing.", "I thought the pizza shop smelled amazing.", "amazing smells came from the pizza shop."],
                        correctIndex: 2,
                        rationale: "Misplaced Modifier: The 'shop' wasn't hungry. You were! The subject 'I' must perform the action of being hungry."
                    },
                    { text: " I ordered a slice with pepperoni, " },
                    {
                        type: 'error', id: 'mm3',
                        original: "which was greasy.",
                        options: ["NO CHANGE", "that was greasy.", "being greasy.", "it was greasy."],
                        correctIndex: 0,
                        rationale: "Correct Usage: 'Which' correctly refers back to the pepperoni slice. The comma + which sets off a non-essential clause."
                    }
                ]
            },
            {
                id: 'boss-4',
                title: 'The Parallel Phantom',
                bossMaxHP: 3,
                passageParts: [
                    { text: "To succeed in this class, you must be attentive, hardworking, and " },
                    {
                        type: 'error', id: 'pp1',
                        original: "do your homework.",
                        options: ["NO CHANGE", "doing your homework.", "complete your homework.", "studious."],
                        correctIndex: 3,
                        rationale: "Parallelism: 'Attentive' and 'hardworking' are adjectives. The list must end with another adjective ('studious'), not a verb phrase."
                    },
                    { text: " The teacher expects us to listen carefully, to take notes, and " },
                    {
                        type: 'error', id: 'pp2',
                        original: "asking questions.",
                        options: ["NO CHANGE", "to ask questions.", "ask questions.", "questioning."],
                        correctIndex: 1,
                        rationale: "Parallelism: The pattern is 'to listen', 'to take'. It must match with 'to ask'."
                    },
                    { text: " She says that wisdom comes not from memorizing facts, but " },
                    {
                        type: 'error', id: 'pp3',
                        original: "from understanding concepts.",
                        options: ["NO CHANGE", "understanding concepts.", "to understand concepts.", "concepts are understood."],
                        correctIndex: 0,
                        rationale: "Parallelism: 'Not from X, but from Y'. The phrase 'from understanding' matches 'from memorizing'."
                    }
                ]
            }
        ];

        const allBadges = {
            'first_mission': { name: 'First Quest', icon: 'üåü' },
            'perfect_score': { name: 'Flawless Victory', icon: 'üéØ' },
            'hot_text_master': { name: 'Text Alchemist', icon: 'üìù' },
            'boss_slayer': { name: 'Glitch Hunter', icon: 'üëæ' }
        };

const shopItems = [
    { 
        id: 'mystery-box', 
        name: 'üé∞ High Roller Box', 
        description: 'High Risk (100 Tokens). Win Stickers, XP, or JACKPOT.', 
        cost: 100, 
        type: 'consumable',
        color: 'bg-gradient-to-r from-fuchsia-600 to-purple-600 border-2 border-yellow-400',
        action: async () => {
            // ALL possible stickers (Old + New)
            const possibleStickers = [
                'üêâ','üßô‚Äç‚ôÇÔ∏è','üè∞','ü¶Ñ','‚öîÔ∏è','üõ°Ô∏è','üîÆ','üëë', // Mythic
                'üöÄ','üëΩ','ü™ê','‚òÑÔ∏è','üë®‚ÄçüöÄ','üî≠','üõ∏','‚≠ê', // Space
                'ü¶Å','üêò','üê∏','ü¶ã','ü¶à','üêº','ü¶â','ü¶ä', // Animals
                'üìñ','üñãÔ∏è','üìú','üïØÔ∏è','üëì','üé≠','üßõ','üïµÔ∏è‚Äç‚ôÇÔ∏è', // Lit
                'üçï','üçî','üçü','üç£','üç©','üç¶','ü•ë','üåÆ', // Food
                '‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','ü•ä','üèÜ', // Sports
                'üé∏','üéπ','ü•Å','üé∑','üé∫','üé§','üéß','üéº', // Music
                '‚úàÔ∏è','üóΩ','üóº','üèùÔ∏è','‚õ∞Ô∏è','‚õ∫','üó∫Ô∏è','üóø'  // Travel
            ];
            const roll = Math.random();
            let msg = ""; 
            let type = "info";
            if (roll < 0.25) { 
                msg = "üí® Dust and cobwebs... The box was empty.";
                type = "error"; 
                playSound('incorrect'); 
            } 
            else if (roll < 0.50) { 
                const xp = 200;
                addXp(xp); 
                msg = `‚ú® Not bad! You found <b>${xp} XP</b>!`; 
                type = "success"; 
                playSound('correct');
            } 
            else if (roll < 0.80) { 
                const newSticker = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                if(!gameState.user.stickers.includes(newSticker)) {
                    gameState.user.stickers.push(newSticker);
                    msg = `üéâ You found a Sticker!<br><span class="text-6xl block mt-4">${newSticker}</span>`;
                    type = "success";
                    triggerConfetti();
                } else {
                    gameState.user.tokens += 25;
                    msg = `You found a Sticker (${newSticker}), but you owned it. Refunded 25 Tokens.`;
                }
                playSound('win');
            }
            else if (roll < 0.95) {
                const tk = 150;
                gameState.user.tokens += tk;
                msg = `üí∞ Money Bags! You found <b>${tk} Tokens</b>!`;
                type = "success";
                playSound('buy');
            }
            else { 
                // JACKPOT
                const s1 = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                const s2 = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                if(!gameState.user.stickers.includes(s1)) gameState.user.stickers.push(s1);
                if(!gameState.user.stickers.includes(s2)) gameState.user.stickers.push(s2);
                addXp(500);
                msg = `üö® <b>MEGA JACKPOT!!</b> üö®<br>You found 500 XP and TWO Stickers!<br><div class="flex justify-center gap-4 mt-4 text-6xl"><span>${s1}</span><span>${s2}</span></div>`;
                type = "success";
                playSound('win'); 
                triggerConfetti();
            }
            saveProgress(); updateUI();
            await showModal('Mystery Box Result', msg, type);
        }
    },
    // --- EXISTING PACKS ---
    { 
        id: 'sticker-pack-myth', name: 'üêâ Mythic Pack', description: 'Fantasy Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-emerald-500 to-teal-600',
        action: () => buyStickerPack(stickerCollections.mythic.items, 'Mythic')
    },
    { 
        id: 'sticker-pack-space', name: 'üöÄ Cosmic Pack', description: 'Space Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-blue-600 to-indigo-800',
        action: () => buyStickerPack(stickerCollections.space.items, 'Cosmic')
    },
    { 
        id: 'sticker-pack-lit', name: 'üìñ Lit Pack', description: 'Book Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-amber-600 to-orange-700',
        action: () => buyStickerPack(stickerCollections.literature.items, 'Literature')
    },
    { 
        id: 'sticker-pack-zoo', name: 'ü¶Å Animal Pack', description: 'Wild Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-green-600 to-lime-700',
        action: () => buyStickerPack(stickerCollections.animals.items, 'Animal')
    },
    // --- NEW PACKS ---
    { 
        id: 'sticker-pack-food', name: 'üçï Snack Pack', description: 'Yummy Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-yellow-400 to-orange-500',
        action: () => buyStickerPack(stickerCollections.foodie.items, 'Snack')
    },
    { 
        id: 'sticker-pack-sport', name: 'üèÜ Sports Pack', description: 'Athletic Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-blue-500 to-cyan-500',
        action: () => buyStickerPack(stickerCollections.sports.items, 'Sports')
    },
    { 
        id: 'sticker-pack-music', name: 'üé∏ Rock Pack', description: 'Music Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-purple-500 to-pink-500',
        action: () => buyStickerPack(stickerCollections.music.items, 'Music')
    },
    { 
        id: 'sticker-pack-travel', name: '‚úàÔ∏è Travel Pack', description: 'World Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-indigo-400 to-blue-600',
        action: () => buyStickerPack(stickerCollections.travel.items, 'Travel')
    },
    // --- POWER UPS ---
    { 
        id: 'skip-ticket', name: '‚è© Skip Ticket', description: 'Auto-Corrects a hard question.', cost: 75, type: 'consumable', color: 'bg-gradient-to-br from-cyan-400 to-blue-500',
        action: () => { gameState.user.purchasedItems.push({ id: 'skip-ticket' }); playSound('buy'); }
    },
    { 
        id: 'lifeline-5050', name: 'üí£ 50/50 Bomb', description: 'Removes 2 wrong answers.', cost: 30, type: 'consumable', color: 'bg-gradient-to-br from-red-500 to-orange-500',
        action: () => { gameState.user.purchasedItems.push({ id: 'lifeline-5050' }); playSound('buy'); }
    }
];

// Helper for buying packs (Keep code clean)
async function buyStickerPack(pool, packName) {
    const newSticker = pool[Math.floor(Math.random() * pool.length)];
    if(!gameState.user.stickers.includes(newSticker)) {
        gameState.user.stickers.push(newSticker);
        playSound('win'); triggerConfetti();
        await showModal(`${packName} Pack!`, `You got: <span class="text-6xl block mt-2">${newSticker}</span>`, 'success');
    } else {
        gameState.user.tokens += 15; // Increased refund slightly
        playSound('buy');
        await showModal('Duplicate!', `You already have ${newSticker}. Refunded 15 Tokens.`, 'info');
    }
    saveProgress();
}

        // --- CORE FUNCTIONS ---
function showModal(title, message, type = 'info') {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // <--- UPDATED: Allows bold/italic text in explanations
            
            modalBox.className = `bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center relative transform transition-all duration-300`;
            if(type === 'success') { modalBox.classList.add('border-t-4', 'border-green-500'); modalTitle.className='text-2xl font-bold mb-2 text-green-600'; }
            else if(type === 'error') { modalBox.classList.add('border-t-4', 'border-red-500'); modalTitle.className='text-2xl font-bold mb-2 text-red-600'; }
            else { modalBox.classList.add('border-t-4', 'border-blue-500'); modalTitle.className='text-2xl font-bold mb-2 text-blue-600'; }
            
            modalBackdrop.classList.remove('hidden');
            setTimeout(() => { modalBox.classList.remove('scale-95', 'opacity-0'); }, 10);
            return new Promise(resolve => {
                modalOkBtn.onclick = () => {
                    modalBox.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => { modalBackdrop.classList.add('hidden'); resolve(); }, 300);
                };
            });
        }

        function navigate(screenId) {
            screens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            gameState.currentScreen = screenId;
        }

        // --- Calibration Logic ---
        let calibrationProgress = { questions: [], currentQuestion: 0, elaLevel: 0 };
function startCalibrationQuest() {
    // This now correctly pulls the calibration items we added above
    calibrationProgress.questions = itemBank.filter(item => item.type === 'calibration');
    calibrationProgress.currentQuestion = 0;
    calibrationProgress.elaLevel = 0;
    
    if(calibrationProgress.questions.length === 0) {
        showModal("Error", "No calibration questions found in database!", "error");
        return;
    }

    navigate('calibration-screen');
    renderCalibrationQuestion();
}

function renderCalibrationQuestion() {
    const currentItem = calibrationProgress.questions[calibrationProgress.currentQuestion];
    if (!currentItem) { endCalibrationQuest(); return; }

    questionArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-lg mb-2 text-blue-600 uppercase">Diagnostic Question ${calibrationProgress.currentQuestion + 1}</p>
            <div class="p-6 bg-white dark:bg-gray-700 rounded-xl shadow-inner border-l-4 border-blue-500 mb-4">
                <p class="italic text-gray-800 dark:text-gray-100 font-serif leading-relaxed">${currentItem.passage}</p>
            </div>
        </div>
        <div>
            <p class="font-bold mb-4 text-xl">${currentItem.items[0].stem}</p>
            <div id="options-container" class="grid grid-cols-1 gap-3">
                ${currentItem.items[0].options.map(option => `
                    <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all">
                        <input type="radio" name="calibration-q" value="${option}" class="mr-3 w-5 h-5">
                        <span class="text-lg font-medium">${option}</span>
                    </label>`).join('')}
            </div>
        </div>`;
    submitButton.onclick = submitCalibrationAnswer;
}

        async function submitCalibrationAnswer() {
            const selectedOption = document.querySelector('input[name="calibration-q"]:checked');
            if (!selectedOption) { await showModal('Oops!', 'Please select an answer.', 'error'); return; }

            const currentItem = calibrationProgress.questions[calibrationProgress.currentQuestion];
            const isCorrect = selectedOption.value === currentItem.items[0].correct_answer;

            if (isCorrect) {
                calibrationProgress.elaLevel += currentItem.items[0].difficulty;
                playSound('correct');
                await showModal('Correct!', 'Nice job! ' + currentItem.items[0].rationale, 'success');
            } else {
                playSound('incorrect');
                await showModal('Incorrect.', 'The correct answer was ' + currentItem.items[0].correct_answer, 'error');
            }
            
            calibrationProgress.currentQuestion++;
            renderCalibrationQuestion();
        }

function endCalibrationQuest() {
    const score = calibrationProgress.elaLevel;
    
    // Tiering Logic
    if (score >= 13) {
        gameState.user.elaLevel = 3; 
        elaLevelDisplay.textContent = 'Mythic Legend';
    } else if (score >= 7) {
        gameState.user.elaLevel = 2;
        elaLevelDisplay.textContent = 'Expert Scholar';
    } else {
        gameState.user.elaLevel = 1;
        elaLevelDisplay.textContent = 'Rookie Adventurer';
    }

    calibrationContent.classList.add('hidden');
    calibrationResults.classList.remove('hidden');
    
    // FIX: Tie the button to the Missions Hub
    document.getElementById('start-missions-button').onclick = () => {
        calibrationResults.classList.add('hidden');
        renderMissions();
    };
    
    saveProgress();
    updateUI();
}

// --- Missions Logic ---
// --- Missions Hub: Adaptive Tiering ---
function renderMissions() {
    missionsList.innerHTML = '';
    // Map numerical level to a readable title
    const rankTitle = gameState.user.elaLevel >= 3 ? 'Legend' : (gameState.user.elaLevel === 2 ? 'Scholar' : 'Rookie');
    proficiencyDisplay.textContent = rankTitle;
    
    // FILTER: Only show missions that match the user's tier +/- 1
    const availableMissions = allMissions.filter(m => {
        const missionTier = m.difficulty <= 3 ? 1 : (m.difficulty <= 7 ? 2 : 3);
        return Math.abs(missionTier - gameState.user.elaLevel) <= 1;
    });

    availableMissions.forEach(mission => {
        const isLocked = gameState.user.level < mission.minLevel;
        const diffColor = mission.difficulty > 7 ? 'text-red-500' : (mission.difficulty > 4 ? 'text-orange-500' : 'text-green-500');
        const missionCard = document.createElement('div');
        
        if (isLocked) {
            missionCard.className = `bg-gray-100 dark:bg-gray-800 rounded-2xl p-6 shadow border-2 border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center text-center opacity-60`;
            missionCard.innerHTML = `<h3 class="text-lg font-bold text-gray-400">Level ${mission.minLevel} Required</h3><p class="text-sm text-gray-400 mb-4">${mission.title}</p>`;
        } else {
            missionCard.className = `bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl border border-indigo-100 dark:border-indigo-900 flex flex-col hover:border-indigo-500 transition-all transform hover:-translate-y-1 cursor-pointer`;
            missionCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-tighter">LVL ${mission.minLevel}+</span>
                    <span class="${diffColor} text-xs font-bold">Difficulty: ${mission.difficulty}/10</span>
                </div>
                <h3 class="text-xl font-bold mb-1 text-gray-800 dark:text-gray-100">${mission.title}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-6 leading-relaxed">${mission.description}</p>
                <button class="start-mission-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-colors" data-mission-id="${mission.id}">BEGIN QUEST ‚öîÔ∏è</button>`;
        }
        missionsList.appendChild(missionCard);
    });

    appendBossCardToMissions();
    document.querySelectorAll('.start-mission-btn').forEach(btn => {
        btn.onclick = (e) => startMission(e.target.dataset.missionId);
    });
    navigate('missions-screen');
}

function startMission(missionId) {
    gameState.currentMission = allMissions.find(m => m.id === missionId);
    gameState.currentQuestionIndex = 0;
    gameState.missionScore = 0;
    gameState.streak = 0;
    gameState.missionHistoryData = [];
    navigate('game-play-screen');
    startTimer(); 
    renderMissionQuestion();
}

function renderMissionQuestion() {
    const missionItem = itemBank.find(zone => 
        zone.id === gameState.currentMission.passageId || 
        zone.genre === gameState.currentMission.id ||
        zone.items.some(i => i.id.startsWith(gameState.currentMission.passageId))
    );
    
    if (!missionItem) {
        showModal("Error", "Mission content not found! Check passageId alignment.", "error");
        navigate('missions-screen');
        return;
    }

    const currentItem = missionItem.items[gameState.currentQuestionIndex];
    if (!currentItem) { endMission(missionItem.items.length); return; }
    
    gameTitle.textContent = gameState.currentMission.title;
    missionScoreDisplay.innerHTML = `${gameState.missionScore}`;
    missionTotalQuestions.textContent = missionItem.items.length;

    gamePassage.innerHTML = `<p class="font-bold mb-2 text-lg text-indigo-600 dark:text-indigo-400">Passage</p><div class="prose dark:prose-invert max-w-none">${missionItem.passage}</div>`;

    gameQuestionsArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-lg mb-2 text-indigo-500">Question ${gameState.currentQuestionIndex + 1}</p>
            <p class="mb-4 text-lg font-medium">${currentItem.stem}</p>
            <div id="options-container" class="space-y-3">
                ${currentItem.options.map((option, index) => `
                    <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 cursor-pointer hover:bg-indigo-50 transition-all">
                        <input type="radio" name="mission-q" value="${option}" class="mt-1 mr-3 w-5 h-5">
                        <span class="flex-1 text-base text-gray-800 dark:text-gray-200">${option}</span>
                    </label>`).join('')}
            </div>
        </div>`;

    renderSubmitButton(currentItem, missionItem.items.length);
}

function renderSubmitButton(currentItem, total) {
    const container = document.querySelector('#game-play-screen .flex.justify-end');
    container.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg';
    btn.textContent = 'Submit Answer';
    btn.onclick = () => checkMissionAnswer(currentItem, total, btn);
    container.appendChild(btn);
}

async function checkMissionAnswer(currentItem, total, btn) {
    const selected = document.querySelector('input[name="mission-q"]:checked');
    if(!selected) { await showModal('Oops', 'Select an answer', 'error'); return; }
    
    const isCorrect = selected.value === currentItem.correct_answer;
    btn.disabled = true;

    // --- RIGOR: Save data for the Review Screen ---
    gameState.missionHistoryData.push({
        question: currentItem.stem,
        userAnswer: selected.value,
        correctAnswer: currentItem.correct_answer,
        isCorrect: isCorrect,
        rationale: currentItem.rationale,
        standard: currentItem.standard || "General"
    });

    // Track Stats for Teacher Report
    const std = currentItem.standard || "General";
    if (!gameState.user.standardsReport) gameState.user.standardsReport = {};
    if (!gameState.user.standardsReport[std]) {
        gameState.user.standardsReport[std] = { correct: 0, total: 0, desc: getStandardDesc(std) };
    }
    gameState.user.standardsReport[std].total++;

    if (isCorrect) {
        gameState.missionScore++;
        gameState.streak++;
        gameState.user.standardsReport[std].correct++;
        await showModal('Correct!', currentItem.rationale, 'success');
    } else {
        gameState.streak = 0;
        if(!gameState.user.missedQuestions) gameState.user.missedQuestions = [];
        gameState.user.missedQuestions.push({...currentItem, id: 'glitch-' + Date.now()});
        await showModal('Incorrect', currentItem.rationale, 'error');
    }

    // --- TIER SCALING ENGINE: Check accuracy after 5 questions ---
    const currentAccuracy = gameState.missionScore / (gameState.currentQuestionIndex + 1);

    if (gameState.currentQuestionIndex >= 4 && currentAccuracy >= 0.90) {
        if (gameState.user.elaLevel < 3) {
            gameState.user.elaLevel++;
            showModal("TIER PROMOTION", "Your accuracy is elite. New high-level missions unlocked!", "success");
            saveProgress();
        }
    } else if (gameState.currentQuestionIndex >= 4 && currentAccuracy <= 0.40) {
        if (gameState.user.elaLevel > 1) {
            gameState.user.elaLevel--;
            showModal("DIFFICULTY ADJUSTED", "System recalibrating to provide foundational support.", "info");
            saveProgress();
        }
    }

    gameState.currentQuestionIndex++;
    renderMissionQuestion();
}

// --- RESTORE: Missing function to create the submit button ---
function renderSubmitButton(currentItem, total) {
    const container = document.querySelector('#game-play-screen .flex.justify-end');
    if(!container) return;
    container.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg';
    btn.textContent = 'Submit Answer';
    btn.onclick = () => checkMissionAnswer(currentItem, total, btn);
    container.appendChild(btn);
}

function endMission(total) {
    const timeTaken = stopTimer(); 
    const accuracy = total > 0 ? gameState.missionScore / total : 0;
    const xpEarned = Math.round(accuracy * 100);
    let tokensEarned = (gameState.missionScore * 15);

    gameState.user.tokens += tokensEarned;
    addXp(xpEarned);

    gameState.user.history.push({
        missionTitle: gameState.currentMission.title,
        score: `${gameState.missionScore}/${total}`,
        date: new Date().toLocaleDateString(),
        tokensEarned: tokensEarned,
        xpEarned: xpEarned
    });

    saveProgress();
    updateUI();
    renderReview(total, xpEarned, tokensEarned, 0, timeTaken);
}

function renderReview(total, xp, tokens, speedBonus, timeTaken) {
    const reviewContent = document.getElementById('review-content');
    reviewContent.innerHTML = ''; 

    const mins = Math.floor(timeTaken / 60);
    const secs = (timeTaken % 60).toString().padStart(2, '0');

    // 1. Create Summary Header
    const summaryCard = document.createElement('div');
    summaryCard.className = "bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-xl border-t-8 border-indigo-500 text-center mb-8";
    summaryCard.innerHTML = `
        <h2 class="text-3xl font-black mb-4 text-indigo-600 dark:text-indigo-400">MISSION COMPLETE</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                <p class="text-xs font-bold text-blue-600 uppercase">Score</p>
                <p class="text-2xl font-black">${gameState.missionScore}/${total}</p>
            </div>
            <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-xl">
                <p class="text-xs font-bold text-amber-600 uppercase">Time</p>
                <p class="text-2xl font-black">${mins}:${secs}</p>
            </div>
            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl">
                <p class="text-xs font-bold text-green-600 uppercase">XP</p>
                <p class="text-2xl font-black">+${xp}</p>
            </div>
            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl">
                <p class="text-xs font-bold text-yellow-600 uppercase">Tokens</p>
                <p class="text-2xl font-black">+${tokens}</p>
            </div>
        </div>
        ${speedBonus > 0 ? `<div class="mt-4 text-sm font-bold text-emerald-500 animate-bounce">‚ö° Speed Bonus Applied: +${speedBonus} Tokens!</div>` : ''}
    `;
    reviewContent.appendChild(summaryCard);

    // 2. Create Question Breakdown
    gameState.missionHistoryData.forEach((data, index) => {
        const card = document.createElement('div');
        const isCorrect = data.isCorrect;
        card.className = `p-6 rounded-xl shadow-md border-l-8 mb-4 ${isCorrect ? 'bg-green-50 border-green-500 dark:bg-gray-800' : 'bg-red-50 border-red-500 dark:bg-gray-800'}`;
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="font-bold text-gray-400 text-xs uppercase tracking-widest">Question ${index + 1} ‚Ä¢ ${data.standard}</span>
                <span class="${isCorrect ? 'text-green-600' : 'text-red-600'} font-black italic">${isCorrect ? 'SUCCESS' : 'GLITCHED'}</span>
            </div>
            <p class="font-bold text-lg mb-3 text-gray-800 dark:text-gray-100">${data.question}</p>
            <div class="bg-white/50 dark:bg-black/20 p-3 rounded-lg border border-black/5 mb-3">
                <p class="text-sm"><b>Your Answer:</b> <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${data.userAnswer}</span></p>
            </div>
            <div class="text-xs leading-relaxed text-gray-600 dark:text-gray-400 p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded border border-indigo-100 dark:border-indigo-900/50">
                <b>Explanation:</b> ${data.rationale}
            </div>
        `;
        reviewContent.appendChild(card);
    });

    // 3. Return Home Button
    const btnContainer = document.createElement('div');
    btnContainer.className = "text-center py-8";
    btnContainer.innerHTML = `<button onclick="navigate('welcome-screen')" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 px-16 rounded-2xl text-xl shadow-2xl transition-transform hover:scale-105">RETURN TO BASE ‚û°</button>`;
    reviewContent.appendChild(btnContainer);

    navigate('review-screen');
}

// --- SURVIVAL: THE GAUNTLET ---
function startSurvival() {
    const allItems = itemBank.flatMap(zone => 
        zone.items.map(item => ({ ...item, passage: zone.passage }))
    ).sort((a, b) => a.difficulty - b.difficulty);
    
    gameState.survivalQueue = allItems;
    gameState.mode = 'survival';
    gameState.missionScore = 0;
    gameState.currentQuestionIndex = 0;
    
    navigate('game-play-screen');
    startTimer();
    renderSurvivalQuestion();
}

function renderSurvivalQuestion() {
    const currentItem = gameState.survivalQueue[gameState.currentQuestionIndex];
    if (!currentItem) { navigate('welcome-screen'); return; }

    gameTitle.innerHTML = `<span class="text-red-600 uppercase italic font-black">üíÄ The Gauntlet</span>`;
    gamePassage.innerHTML = `<div class="prose dark:prose-invert">${currentItem.passage}</div>`;
    gameQuestionsArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-red-500 mb-2 italic tracking-widest uppercase">Survival Level: ${currentItem.difficulty}</p>
            <p class="mb-4 text-lg font-medium">${currentItem.stem}</p>
            <div id="options-container" class="space-y-3">
                ${currentItem.options.map(opt => `
                    <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 cursor-pointer hover:bg-red-50 transition-all">
                        <input type="radio" name="survival-q" value="${opt}" class="mr-3">
                        <span>${opt}</span>
                    </label>`).join('')}
            </div>
            <button onclick="checkSurvivalAnswer()" class="w-full mt-6 bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg">Submit Answer</button>
        </div>`;
}

async function checkSurvivalAnswer() {
    const currentItem = gameState.survivalQueue[gameState.currentQuestionIndex];
    const selected = document.querySelector('input[name="survival-q"]:checked');
    if(!selected) return;

    if (selected.value === currentItem.correct_answer) {
        gameState.missionScore++;
        gameState.currentQuestionIndex++;
        await showModal('SURVIVED!', `Streak: ${gameState.missionScore}`, 'success');
        renderSurvivalQuestion();
    } else {
        stopTimer();
        await showModal('üíÄ GAME OVER', `Correct: ${currentItem.correct_answer}<br><br>${currentItem.rationale}`, 'error');
        saveProgress();
        navigate('welcome-screen');
    }
}

// --- SYSTEM HELPERS ---
function addXp(amount) {
    gameState.user.xp += amount;
    while (gameState.user.xp >= 100) { 
        gameState.user.xp -= 100; 
        gameState.user.level++; 
        triggerConfetti();
    }
    updateUI();
}

function updateUI() {
    const profDisplay = document.getElementById('proficiency-display');
if(profDisplay) {
    const rank = gameState.user.elaLevel >= 3 ? 'LEGEND' : (gameState.user.elaLevel === 2 ? 'SCHOLAR' : 'ROOKIE');
    profDisplay.className = `font-black px-3 py-1 rounded-full text-xs ${rank === 'LEGEND' ? 'bg-purple-600 text-white animate-pulse' : (rank === 'SCHOLAR' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700')}`;
    profDisplay.textContent = rank;
};
    const mainLevel = document.getElementById('main-level-display');
    const mainXpCur = document.getElementById('main-xp-current');
    const mainXpBar = document.getElementById('main-xp-bar');
    const mainTokens = document.getElementById('main-token-display');

    if(mainLevel) mainLevel.textContent = gameState.user.level;
    if(mainXpCur) mainXpCur.textContent = gameState.user.xp;
    if(mainXpBar) mainXpBar.style.width = `${gameState.user.xp}%`; 
    if(mainTokens) mainTokens.textContent = gameState.user.tokens;
    if(tokenDisplay) tokenDisplay.textContent = gameState.user.tokens;
}

function saveProgress() { localStorage.setItem('elaGameProgress', JSON.stringify(gameState.user)); }
function loadProgress() { 
    const saved = localStorage.getItem('elaGameProgress'); 
    if(saved) gameState.user = { ...gameState.user, ...JSON.parse(saved) }; 
}

function resetGame() {
    localStorage.removeItem('elaGameProgress');
    location.reload();
}

function triggerConfetti() { if(typeof confetti !== 'undefined') confetti({ particleCount: 150, spread: 90 }); }

// --- TEACHER REPORT HELPER: STANDARD DEFINITIONS ---
function getStandardDesc(std) {
    const map = {
        'RI.8.1': 'Citing Evidence',
        'RI.8.2': 'Central Idea & Summary',
        'RI.8.3': 'Connections & Distinctions',
        'RI.8.4': 'Vocabulary in Context',
        'RI.8.5': 'Text Structure',
        'RI.8.6': 'Author Point of View',
        'RI.8.8': 'Evaluating Arguments',
        'RL.8.1': 'Inference & Evidence',
        'RL.8.2': 'Theme & Plot',
        'RL.8.3': 'Character Development',
        'RL.8.4': 'Figurative Language',
        'RL.8.6': 'Irony & Suspense',
        'L.8.1': 'Grammar & Usage',
        'L.8.2': 'Punctuation & Spelling',
        'L.8.4': 'Vocabulary Acquisition',
        'L.8.5': 'Figures of Speech'
    };
    return map[std] || 'General ELA Mastery';
}

// --- GLITCH ARCHIVE: RETEACH & REPAIR SYSTEM ---
function openArchive() {
    const list = document.getElementById('archive-list');
    const emptyMsg = document.getElementById('archive-empty-msg');
    list.innerHTML = '';
    
    // Check if user has any missed questions saved
    if (!gameState.user.missedQuestions || gameState.user.missedQuestions.length === 0) {
        emptyMsg.classList.remove('hidden');
    } else {
        emptyMsg.classList.add('hidden');
        gameState.user.missedQuestions.forEach((item) => {
            const card = document.createElement('div');
            const standardKey = item.standard || 'General';
            
            // Pull the specific mini-lesson you wrote in skillLessons
            const lessonText = skillLessons[standardKey] || "Review the text for direct evidence. ELA mastery requires citing specific lines to support your claims.";

            card.className = "bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border-l-8 border-red-500 mb-6 relative overflow-hidden";
            card.innerHTML = `
                <div class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">CORRUPTED</div>
                <div class="mb-4 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-900/50">
                    <p class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase mb-1 tracking-widest">Targeted Study: ${getStandardDesc(standardKey)}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">${lessonText}</p>
                </div>
                <p class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">${item.stem}</p>
                <div class="space-y-2">
                    ${item.options.map(opt => `
                        <button class="w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors font-medium" 
                        onclick="checkArchiveAnswer('${item.id}', '${opt.replace(/'/g, "\\'")}', this)">
                            ${opt}
                        </button>`).join('')}
                </div>
                <p class="mt-4 text-[10px] text-gray-400 font-mono italic">Successful purge grants +10 XP and +5 Tokens</p>
            `;
            list.appendChild(card);
        });
    }
    navigate('archive-screen');
}

async function checkArchiveAnswer(itemId, answer, btnElement) {
    const itemIndex = gameState.user.missedQuestions.findIndex(q => q.id === itemId);
    if (itemIndex === -1) return;
    const item = gameState.user.missedQuestions[itemIndex];
    
    if (answer === item.correct_answer) {
        // Correct Fix
        await showModal('Glitch Purged! üõ°Ô∏è', `Excellent! You applied the skill correctly.<br><br><b>Explanation:</b> ${item.rationale}`, 'success');
        
        gameState.user.missedQuestions.splice(itemIndex, 1);
        gameState.user.tokens += 5; 
        addXp(10);
        saveProgress();
        triggerConfetti();
        openArchive(); // Refresh the list
    } else {
        // Failed Fix
        btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
        btnElement.disabled = true;
        btnElement.innerHTML += " ‚ùå";
    }
}

// --- DEPLOYMENT & CONTENT VALIDATION SYSTEM ---
/**
 * Scans the mission list to ensure every button has a 
 * matching academic passage in the item bank.
 */
function validateMissionContent() {
    console.log("üöÄ Starting Content Deployment Scan...");
    let missingContent = [];

    allMissions.forEach(mission => {
        // Special case: Skip validation for the dynamic Final Exam
        if (mission.passageId === 'EXAM') return;

        // Search logic must match renderMissionQuestion exactly
        const hasContent = itemBank.find(zone => 
            zone.id === mission.passageId || 
            zone.genre === mission.id ||
            (zone.items && zone.items.some(i => i.id.startsWith(mission.passageId)))
        );

        if (!hasContent) {
            missingContent.push(`[${mission.id}] ${mission.title}`);
        }
    });

    if (missingContent.length > 0) {
        console.error("‚ùå DEPLOYMENT ERROR: The following missions are missing academic content in itemBank:", missingContent);
    } else {
        console.log("‚úÖ All Missions Validated: Ready for student deployment.");
    }
}

/**
 * Enhanced Start Mission with Safety Catch
 */
function safeStartMission(missionId) {
    const mission = allMissions.find(m => m.id === missionId);
    const content = itemBank.find(zone => 
        zone.id === mission.passageId || 
        zone.genre === mission.id ||
        (zone.items && zone.items.some(i => i.id.startsWith(mission.passageId)))
    );

    if (!content) {
        showModal("System Error", "This mission file is corrupted or missing content. Please choose another quest.", "error");
        return;
    }
    
    startMission(missionId);
}

function appendBossCardToMissions() {
    // Only show boss if student has reached a high enough level
    if (gameState.user.level < 3) return;

    const bossCard = document.createElement('div');
    bossCard.className = "col-span-1 md:col-span-2 lg:col-span-3 bg-gradient-to-r from-red-900 to-black rounded-2xl p-8 shadow-2xl border-4 border-red-600 flex flex-col md:flex-row items-center justify-between gap-6 transform hover:scale-[1.02] transition-transform";
    bossCard.innerHTML = `
        <div class="flex-1 text-center md:text-left">
            <h3 class="text-3xl font-black text-white mb-2">üö® GLITCH DETECTED</h3>
            <p class="text-red-200 text-lg">The system core is corrupted. Face the Glitch to restore order.</p>
        </div>
        <button onclick="startBossBattle('boss-1')" class="bg-red-600 hover:bg-red-500 text-white font-black py-4 px-10 rounded-xl shadow-lg animate-pulse">ELIMINATE THREAT</button>
    `;
    missionsList.appendChild(bossCard);
}

function generateReport() {
    const stats = gameState.user.standardsReport || {};
    let rows = "";
    let totalCorrect = 0;
    let totalQ = 0;

    for (const [std, data] of Object.entries(stats)) {
        const percent = Math.round((data.correct / data.total) * 100);
        totalCorrect += data.correct;
        totalQ += data.total;
        rows += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px;"><b>${std}</b><br><small>${data.desc}</small></td>
                <td style="padding: 10px; text-align: center;">${data.correct}/${data.total}</td>
                <td style="padding: 10px; text-align: center; color: ${percent >= 80 ? 'green' : 'red'};"><b>${percent}%</b></td>
            </tr>`;
    }

    const overall = totalQ > 0 ? Math.round((totalCorrect / totalQ) * 100) : 0;

    const reportHTML = `
        <div style="font-family: sans-serif; padding: 20px; color: #333;">
            <h1 style="color: #4f46e5;">ELA Legends: Proficiency Report</h1>
            <p><b>Student Rank:</b> ${proficiencyDisplay.textContent} | <b>Level:</b> ${gameState.user.level}</p>
            <p><b>Overall Accuracy:</b> ${overall}%</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <tr style="background: #f3f4f6;">
                    <th style="padding: 10px; text-align: left;">Standard</th>
                    <th style="padding: 10px;">Score</th>
                    <th style="padding: 10px;">Mastery</th>
                </tr>
                ${rows || "<tr><td colspan='3' style='text-align:center; padding: 20px;'>No mission data recorded yet.</td></tr>"}
            </table>
            <p style="margin-top: 30px; font-size: 12px; color: #666;">Generated on: ${new Date().toLocaleString()}</p>
            <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 5px; cursor: pointer;">Print Report</button>
        </div>
    `;

    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
}

// --- BOSS BATTLE SYSTEM CORE ---
let currentBossHP = 0;
let currentPlayerHP = 3;
let currentBossData = null;

function startBossBattle(bossId) {
    currentBossData = bossBattles.find(b => b.id === bossId);
    currentBossHP = currentBossData.bossMaxHP;
    currentPlayerHP = 3;
    
    updateBossUI();
    renderBossText();
    navigate('boss-round-screen');
}

function updateBossUI() {
    const playerBar = document.getElementById('player-hp-bar');
    const bossBar = document.getElementById('boss-hp-bar');
    
    if(playerBar) playerBar.style.width = (currentPlayerHP / 3 * 100) + '%';
    if(bossBar) bossBar.style.width = (currentBossHP / currentBossData.bossMaxHP * 100) + '%';
}

function renderBossText() {
    const display = document.getElementById('boss-text-display');
    display.innerHTML = '';

    currentBossData.passageParts.forEach(part => {
        if (part.type === 'error') {
            const span = document.createElement('span');
            span.className = "bg-red-100 border-b-2 border-red-500 cursor-pointer hover:bg-red-200 px-1 mx-1 rounded transition-colors font-bold text-red-700";
            span.textContent = part.original;
            span.onclick = () => openEditorModal(part);
            display.appendChild(span);
        } else {
            const textNode = document.createTextNode(part.text);
            display.appendChild(textNode);
        }
    });
}

function openEditorModal(part) {
    const modal = document.getElementById('editor-modal');
    const optionsContainer = document.getElementById('editor-options');
    optionsContainer.innerHTML = '';

    part.options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all font-medium";
        btn.textContent = opt;
        btn.onclick = () => checkBossAnswer(part, index);
        optionsContainer.appendChild(btn);
    });

    modal.classList.remove('hidden');
    document.getElementById('close-editor-modal').onclick = () => modal.classList.add('hidden');
}

async function checkBossAnswer(part, selectedIndex) {
    document.getElementById('editor-modal').classList.add('hidden');
    
    if (selectedIndex === part.correctIndex) {
        currentBossHP--;
        await showModal("DIRECT HIT! üéØ", `<b>Correction applied!</b><br><br>${part.rationale}`, "success");
    } else {
        currentPlayerHP--;
        await showModal("SYSTEM CRASH! ‚ö°", `The Glitch attacked your core!<br><br><b>Explanation:</b> ${part.rationale}`, "error");
    }

    updateBossUI();

    if (currentBossHP <= 0) {
        addXp(500);
        gameState.user.tokens += 200;
        triggerConfetti();
        await showModal("VICTORY! üèÜ", "The Glitch has been purged from this sector! +500 XP / +200 Tokens", "success");
        navigate('welcome-screen');
    } else if (currentPlayerHP <= 0) {
        await showModal("DEFEATED üíÄ", "The Glitch was too strong. Study your standards and try again!", "error");
        navigate('welcome-screen');
    }
}// --- STICKER BOOK: COLLECTION DISPLAY ---
function renderStickerBook() {
    const progressScreen = document.getElementById('progress-screen');
    const stickerAreaId = 'sticker-collection-grid';
    let stickerGrid = document.getElementById(stickerAreaId);
    
    // If the grid doesn't exist, create it once
    if (!stickerGrid) {
        const wrapper = document.createElement('div');
        wrapper.className = "mt-10 pt-10 border-t border-gray-200 dark:border-gray-700";
        wrapper.innerHTML = `
            <h3 class="text-3xl font-black mb-6 text-transparent bg-clip-text bg-gradient-to-r from-violet-500 to-purple-600">MY STICKER COLLECTION</h3>
            <div id="${stickerAreaId}" class="grid grid-cols-4 md:grid-cols-8 gap-4 p-8 bg-white/40 dark:bg-black/20 backdrop-blur-md rounded-3xl border-2 border-dashed border-purple-300 dark:border-purple-900/50"></div>
        `;
        progressScreen.appendChild(wrapper);
        stickerGrid = document.getElementById(stickerAreaId);
    }

    // Populate the grid
    stickerGrid.innerHTML = '';
    if (!gameState.user.stickers || gameState.user.stickers.length === 0) {
        stickerGrid.innerHTML = '<p class="col-span-full text-center text-gray-400 italic py-8">Your sticker book is empty! Head to the Shop to buy packs. üõçÔ∏è</p>';
    } else {
        gameState.user.stickers.forEach(emoji => {
            const div = document.createElement('div');
            div.className = "text-5xl p-4 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 flex items-center justify-center transform hover:scale-125 hover:rotate-6 transition-all cursor-default select-none";
            div.textContent = emoji;
            stickerGrid.appendChild(div);
        });
    }
    
    renderMissionHistory(); // Keep the table updated too
    navigate('progress-screen');
}

function renderMissionHistory() {
    missionHistoryBody.innerHTML = gameState.user.history.map(entry => `
        <tr class="border-b border-gray-100 dark:border-gray-700">
            <td class="p-4 font-bold text-indigo-600">${entry.missionTitle}</td>
            <td class="p-4">${entry.score}</td>
            <td class="p-4 text-xs">${entry.date}</td>
            <td class="p-4 text-yellow-600 font-bold">+${entry.tokensEarned}</td>
            <td class="p-4 text-green-600 font-bold">+${entry.xpEarned}</td>
        </tr>
    `).join('');
}

// --- SHOP SYSTEM: RENDER & PURCHASE LOGIC ---
function renderShop() {
    const list = document.getElementById('shop-items-list');
    const displayTokens = document.getElementById('token-display');
    
    if (list) {
        list.innerHTML = '';
        shopItems.forEach(item => {
            const card = document.createElement('div');
            card.className = `${item.color} rounded-2xl p-6 shadow-xl border border-white/20 flex flex-col justify-between transform hover:scale-[1.02] transition-all text-white`;
            card.innerHTML = `
                <div>
                    <h3 class="text-2xl font-black mb-1 drop-shadow-md">${item.name}</h3>
                    <p class="text-xs opacity-90 font-medium leading-tight mb-4">${item.description}</p>
                </div>
                <button onclick="buyItem('${item.id}')" class="w-full bg-white/20 hover:bg-white/40 backdrop-blur-md text-white font-black py-3 rounded-xl border border-white/30 shadow-lg transition-colors">
                    COST: ${item.cost} ü™ô
                </button>
            `;
            list.appendChild(card);
        });
    }

    if (displayTokens) displayTokens.textContent = gameState.user.tokens;
    navigate('shop-screen');
}

async function buyItem(itemId) {
    const item = shopItems.find(i => i.id === itemId);
    if (gameState.user.tokens >= item.cost) {
        gameState.user.tokens -= item.cost;
        updateUI();
        // Execute the item's specific action (e.g., opening a pack or adding a skip ticket)
        await item.action();
        saveProgress();
        if(document.getElementById('token-display')) document.getElementById('token-display').textContent = gameState.user.tokens;
    } else {
        showModal('Insufficient Funds', 'You need more tokens! Complete missions to earn more.', 'error');
    }
}
// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    loadProgress();
    updateUI();

    // Run Deployment Scan
    validateMissionContent();

    document.getElementById('start-calibration-button').onclick = startCalibrationQuest;
    document.getElementById('missions-button').onclick = renderMissions;
document.getElementById('shop-button').onclick = renderShop;
    document.getElementById('progress-button').onclick = renderStickerBook;
    
    // Update Mission Hub to use the Safe Start logic
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('start-mission-btn')) {
            safeStartMission(e.target.dataset.missionId);
        }
    });

    document.querySelectorAll('.home-button').forEach(btn => {
        btn.onclick = () => { 
            stopTimer(); 
            navigate('welcome-screen'); 
        };
    });
});

    </script>
</body>
</html>