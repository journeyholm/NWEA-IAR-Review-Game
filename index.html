<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic ELA Assessment-Prep Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* --- ANIMATED BACKGROUND --- */
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
        }
        .dark body {
            background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #533483);
            background-size: 400% 400%;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- GLASSMORPHISM UI --- */
        .game-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .dark .game-container {
            background: rgba(17, 24, 39, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- JUICY BUTTONS --- */
        .button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: none;
        }
        .button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            filter: brightness(1.1);
        }
        .button:active {
            transform: translateY(-1px);
        }

        /* --- FIXED: HOME BUTTON & HEADER TEXT --- */
        .home-button { 
top: 1.5rem !important;
            left: 1.5rem !important; /* Moved right */
            background: white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            z-index: 50;
        }
        .dark .home-button { 
            background: #374151; 
            color: white; 
        }

        /* This specifically fixes the "The Shop" text visibility and overlap */
/* FORCE DARK HEADERS FOR READABILITY */
        #shop-screen h2, 
        #missions-screen h2, 
        #progress-screen h2, 
        #review-screen h2,
        #calibration-screen h2, 
        #game-play-screen h2,
        #boss-round-screen h2 {
            padding-left: 4rem; /* Space for the home button */
            color: #111827 !important; /* Force dark text */
            text-shadow: 0px 1px 2px rgba(255,255,255,0.8); /* subtle light shadow to pop against background */
        }
        
        /* White text for Dark Mode */
        .dark #shop-screen h2, 
        .dark #missions-screen h2, 
        .dark #progress-screen h2, 
        .dark #review-screen h2,
        .dark #calibration-screen h2, 
        .dark #game-play-screen h2,
        .dark #boss-round-screen h2 {
            color: #ffffff !important;
            text-shadow: none;
        }

        /* --- UTILS --- */
        .ribbon { background-color: #ef4444; top: -10px; right: -10px; transform: rotate(45deg); padding: 0 2rem; color: white; font-weight: bold; }
        .screen { animation: fadeSlideUp 0.5s ease-out; }
        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Hot Text & Boss Styles */
        .hot-text-word { display: inline-block; margin: 0 3px; padding: 2px 6px; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .hot-text-word:hover { background-color: rgba(59, 130, 246, 0.1); }
        .hot-text-word.selected { background-color: #3b82f6; color: white; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4); transform: scale(1.05); }
        .hot-text-word.correct { background-color: #10b981; color: white; }
        .hot-text-word.incorrect { background-color: #ef4444; color: white; }
        
        .boss-error { border-bottom: 3px solid #ef4444; cursor: pointer; font-weight: 600; color: #ef4444; }
        .boss-error:hover { background-color: #fee2e2; color: #b91c1c; }
        .boss-fixed { color: #059669; font-weight: bold; border-bottom: 2px solid #059669; background-color: #d1fae5; padding: 0 4px; border-radius: 4px; }
    /* --- START OF RARE STICKER EFFECT --- */

/* --- NEW STICKER RARITY SYSTEM --- */
        .sticker-item { position: relative; overflow: hidden; transition: transform 0.2s; }
        .sticker-item:hover { transform: scale(1.15) rotate(3deg); z-index: 50; }

        /* RARE: Silver Shine */
        .rarity-rare { border: 3px solid #b0c4de; background: linear-gradient(135deg, #fff, #f0f8ff); }
        .rarity-rare::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.8), transparent);
            transform: rotate(45deg); animation: shine-sweep 3s infinite; pointer-events: none;
        }

        /* EPIC: Purple Pulse */
        .rarity-epic { border: 3px solid #9b59b6; background: #f3e5f5; box-shadow: 0 0 10px #9b59b6; animation: pulse-purple 2s infinite; }
        
        /* LEGENDARY: Gold Glow & Float */
        .rarity-legendary { 
            border: 4px solid #ffd700; background: radial-gradient(circle, #fffae0, #ffd700); 
            box-shadow: 0 0 20px #ffd700; animation: legendary-float 3s ease-in-out infinite; 
        }

        @keyframes shine-sweep { 0% { left: -100%; top: -100%; } 100% { left: 100%; top: 100%; } }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 5px #9b59b6; } 50% { box-shadow: 0 0 20px #9b59b6; } 100% { box-shadow: 0 0 5px #9b59b6; } }
        @keyframes legendary-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

/* This creates the moving shine */
.rare::after {
  content: "";
  position: absolute;
  top: 0; 
  left: 0;
  width: 200%; 
  height: 200%;
  background: linear-gradient(
    135deg, 
    rgba(255,255,255,0) 30%, 
    rgba(255,255,255,0.6) 50%, 
    rgba(255,255,255,0) 70%
  );
  animation: shine-effect 3s infinite linear;
  pointer-events: none;
}

/* The animation settings */
@keyframes shine-effect {
  0% { transform: translate(-50%, -50%); }
  100% { transform: translate(10%, 10%); }
}

/* --- END OF RARE STICKER EFFECT --- */
    </style>
</head>

<div id="welcome-screen" class="screen flex flex-col items-center justify-start text-center px-4 md:px-8 pb-8 pt-8 min-h-[60vh] relative">

    <div class="w-full max-w-5xl mx-auto flex flex-col md:flex-row justify-center items-center gap-12 bg-white/60 dark:bg-gray-800/60 backdrop-blur-lg border border-white/40 p-4 rounded-3xl shadow-lg mb-12">
        
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="relative group">
                <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg border-2 border-white dark:border-gray-700 transform transition group-hover:scale-110">
                    <span id="main-level-display">1</span>
                </div>
                <div class="absolute -bottom-2 -right-2 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-2 py-0.5 rounded-full border border-white shadow-sm">LVL</div>
            </div>

            <div class="flex flex-col items-start flex-grow">
                <div class="flex justify-between w-full text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wider">
                    <span>Experience</span>
                    <span id="main-xp-current-display"><span id="main-xp-current">0</span> / 100 XP</span>
                </div>
                <div class="w-48 h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner border border-black/5">
                    <div id="main-xp-bar" class="bg-gradient-to-r from-blue-400 to-indigo-500 h-full rounded-full transition-all duration-500 relative" style="width: 0%">
                        <div class="absolute top-0 left-0 w-full h-full bg-white/20 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 bg-yellow-100 dark:bg-yellow-900/40 px-4 py-2 rounded-xl border border-yellow-200 dark:border-yellow-700/50 shadow-sm">
                <span class="text-xl">ğŸª™</span> 
                <div class="flex flex-col items-start leading-none">
                    <span id="main-token-display" class="font-bold text-yellow-800 dark:text-yellow-100 text-lg">0</span>
                    <span class="text-[10px] font-bold text-yellow-600 dark:text-yellow-400 uppercase">Tokens</span>
                </div>
            </div>

            <button id="theme-toggle-header" onclick="document.getElementById('theme-toggle').click()" class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </div>

    <h1 class="text-5xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-400 dark:via-purple-400 dark:to-pink-400 mb-2 drop-shadow-sm tracking-tight">ELA LEGENDS</h1>
        
        <div class="bg-white/60 dark:bg-black/40 backdrop-blur-md py-3 px-8 rounded-full shadow-sm mb-10 border border-white/20">
            <p class="text-xl md:text-2xl text-slate-900 dark:text-white font-bold">Master reading, writing, and logic to defeat the Glitch.</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl mb-8">
            <button id="start-calibration-button" class="button bg-gradient-to-br from-blue-500 to-blue-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-blue-400/20">
                <span class="text-3xl block mb-2">ğŸ§™â€â™‚ï¸</span>Calibration Quest
            </button>
            <button onclick="startSurvival()" class="button bg-gradient-to-br from-red-600 to-orange-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-red-400/20 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-1 bg-black/20 rounded-bl-lg text-xs font-mono">HARDCORE</div>
                <span class="text-3xl block mb-2">ğŸ’€</span>The Gauntlet
            </button>
            <button id="missions-button" class="button bg-gradient-to-br from-emerald-500 to-emerald-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-emerald-400/20">
                <span class="text-3xl block mb-2">ğŸ“œ</span>Daily Missions
            </button>
            <button id="shop-button" class="button bg-gradient-to-br from-amber-400 to-orange-600 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-amber-400/20">
                <span class="text-3xl block mb-2">ğŸ›ï¸</span>The Shop
            </button>
            <button id="progress-button" class="button bg-gradient-to-br from-violet-500 to-purple-700 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-violet-400/20">
                <span class="text-3xl block mb-2">ğŸ“’</span>My Sticker Book
            </button>
            <button onclick="generateReport()" class="button bg-gradient-to-br from-slate-600 to-slate-800 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-slate-500/20">
                <span class="text-3xl block mb-2">ğŸ–¨ï¸</span>Teacher Report
            </button>
            <button id="archive-button" onclick="openArchive()" class="col-span-1 md:col-span-2 button bg-gradient-to-r from-red-600 to-rose-600 text-white font-bold py-6 px-6 rounded-2xl text-xl shadow-lg border border-red-400/20 flex flex-col md:flex-row items-center justify-center gap-4 relative overflow-hidden group">
                 <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                 <span class="text-4xl animate-pulse">âš ï¸</span> 
                 <span>Glitch Archive (Fix Mistakes & Study)</span>
            </button>
        </div>
        
<button id="reset-button" onclick="if(confirm('Are you sure? This deletes all progress!')) resetGame()" class="mt-8 text-gray-500 hover:text-red-500 text-sm font-semibold transition-colors bg-white/50 px-4 py-2 rounded-lg">Reset Save Data</button>    </div>

<div id="calibration-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-white shadow-md hover:bg-gray-100 transition-colors z-50">
                <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>

            <h2 class="text-3xl md:text-4xl font-bold mb-4 relative z-10">Calibration Quest</h2>

            <div class="inline-block bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm border border-white/40 rounded-lg px-4 py-2 mb-6 shadow-sm">
                <p class="text-slate-900 dark:text-gray-100 font-semibold text-lg">
                    Answer these questions to determine your starting level.
                </p>
            </div>

            <div id="calibration-content" class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-inner">
                <div id="question-area"></div>
                <div id="message-box" class="mt-4 p-4 rounded-lg hidden"></div>
                <div class="flex justify-end mt-6">
                    <button id="submit-answer-button" class="button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Submit Answer</button>
                </div>
            </div>
            <div id="calibration-results" class="hidden text-center mt-8">
                <h3 class="text-3xl font-bold text-green-600 dark:text-green-400 mb-4">Quest Complete!</h3>
                <p class="text-xl text-gray-700 dark:text-gray-300 mb-4">Your calibrated ELA level is: <span id="ela-level-display" class="font-extrabold text-blue-600 dark:text-blue-400"></span></p>
                <button id="start-missions-button" class="button bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Start Daily Missions ğŸš€</button>
            </div>
        </div>



        <div id="missions-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Daily Missions Hub</h2>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Your current ELA proficiency level: <span id="proficiency-display" class="font-bold text-indigo-500"></span></p>
            <div id="missions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
        
<div id="game-play-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute z-10 p-3 rounded-full transition-transform hover:rotate-90">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 pl-12">
                <h2 id="game-title" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white drop-shadow-sm">Mission Title</h2>
                <div class="mt-4 md:mt-0 bg-white dark:bg-gray-800 px-6 py-2 rounded-full shadow-lg border border-gray-100 dark:border-gray-700">
<div class="flex items-center gap-6">
    <div class="flex items-center gap-2 text-amber-600 dark:text-amber-400 font-mono text-xl font-bold bg-amber-100 dark:bg-amber-900/50 px-3 py-1 rounded-lg border border-amber-200 dark:border-amber-700">
        <span>â±ï¸</span>
        <span id="game-timer">00:00</span>
    </div>

    <p class="text-lg font-bold text-indigo-600 dark:text-indigo-400">
        Score: <span id="mission-score-display" class="text-2xl">0</span>
        <span class="text-gray-400 mx-2">/</span>
        <span id="mission-total-questions">0</span>
    </p>
</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="game-passage" class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-md rounded-2xl p-8 shadow-xl border border-white/20 text-lg leading-relaxed font-serif text-gray-800 dark:text-gray-200 h-fit">
                    </div>

                <div class="flex flex-col">
                    <div id="game-questions-area" class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-2xl border-t-8 border-indigo-500 flex-grow">
                        </div>
                    
                    <div class="mt-6 flex justify-end gap-4">
                        </div>
                </div>
            </div>
            <div id="game-feedback-area" class="mt-6"></div>
        </div>

        <div id="shop-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">The Shop</h2>
            <div class="flex justify-between items-center mb-6 p-4 rounded-lg bg-yellow-100 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-700">
                <p class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">Your Tokens: <span id="token-display" class="font-extrabold text-yellow-900 dark:text-yellow-100">0</span> ğŸ’°</p>
            </div>
            <div id="shop-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="progress-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">My Progress</h2>

<div class="mt-8">
                <h3 class="text-2xl font-bold mb-4">Mission History</h3>
                <table id="mission-history-table" class="w-full text-left table-auto">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-700">
                            <th class="p-4 rounded-tl-lg">Mission</th>
                            <th class="p-4">Score</th>
                            <th class="p-4">Date</th>
                            <th class="p-4">Tokens</th>
                            <th class="p-4 rounded-tr-lg">XP</th>
                        </tr>
                    </thead>
                    <tbody id="mission-history-body"></tbody>
                </table>
            </div>
        </div>

        <div id="review-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10"><svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg></button>
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Mission Review</h2>
            <div id="review-content" class="space-y-8"></div>
        </div>

        <div id="boss-round-screen" class="screen hidden p-4 md:p-8 relative">
            <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors z-10">
                <svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
            </button>
            <div class="flex flex-col items-center mb-6">
                <h2 class="text-4xl font-extrabold text-red-600 dark:text-red-500 mb-2">BOSS BATTLE: The Glitch</h2>
                <p class="text-gray-600 dark:text-gray-300">Fix the errors to defeat the Boss!</p>
                
                <div class="w-full max-w-3xl grid grid-cols-2 gap-8 mt-4">
                    <div class="text-center">
                        <p class="font-bold text-blue-600 dark:text-blue-400">YOU (Editor)</p>
                        <div class="w-full bg-gray-300 h-6 rounded-full overflow-hidden border-2 border-gray-400">
                            <div id="player-hp-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="font-bold text-red-600 dark:text-red-400">THE GLITCH</p>
                        <div class="w-full bg-gray-300 h-6 rounded-full overflow-hidden border-2 border-gray-400">
                            <div id="boss-hp-bar" class="bg-red-500 h-full transition-all duration-500" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="boss-battle-area" class="bg-white dark:bg-gray-800 rounded-xl p-8 shadow-2xl border-4 border-red-500 relative max-w-4xl mx-auto">
                <div id="boss-text-display" class="text-lg md:text-xl leading-relaxed font-serif">
                    </div>
            </div>

            <div id="editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full transform scale-100 transition-transform">
                    <h3 class="text-xl font-bold mb-4">How should this be written?</h3>
                    <div id="editor-options" class="space-y-3">
                        </div>
                    <button id="close-editor-modal" class="mt-4 text-gray-500 hover:text-gray-700 underline text-sm w-full text-center">Cancel</button>
                </div>
            </div>
        </div>
        
    </div>

<div id="archive-screen" class="screen hidden p-4 md:p-8 relative">
        <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-white shadow-md hover:bg-gray-100 transition-colors z-50">
            <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
        </button>
        <h2 class="text-3xl md:text-4xl font-bold mb-2 relative z-10 text-red-600 dark:text-red-400">âš ï¸ Glitch Archive</h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6 bg-white/50 dark:bg-gray-800/50 p-2 rounded inline-block">Study the skills and fix the corrupted files to earn XP!</p>
        
        <div id="archive-list" class="grid grid-cols-1 gap-6 max-w-3xl mx-auto"></div>
        
        <div id="archive-empty-msg" class="hidden text-center mt-12 bg-white/40 dark:bg-black/20 p-8 rounded-2xl border border-white/50">
            <div class="text-6xl mb-4">âœ¨</div>
            <h3 class="text-2xl font-bold text-gray-700 dark:text-gray-300">System Clean!</h3>
            <p class="text-gray-500">No glitches detected. You've mastered everything!</p>
            <button onclick="navigate('welcome-screen')" class="mt-4 bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-indigo-600">Return to Base</button>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-box" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center relative transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modal-title" class="text-2xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-4"></p>
            <button id="modal-ok-btn" class="button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

   <script>
// --- AUDIO SYSTEM (DISABLED) ---
        function playSound(type) { /* Sound removed by user request */ }

// --- Game State ---
        let gameState = {
            currentScreen: 'welcome',
            currentMission: null,
            currentQuestionIndex: 0,
            missionScore: 0,
            missionHistoryData: [], 
            streak: 0,
            // --- NEW: AI Classmates to compete against ---
            rivals: [
                { name: "Hermione G.", xp: 450, avatar: "ğŸ“š" },
                { name: "Percy J.", xp: 320, avatar: "ğŸŒŠ" },
                { name: "Katniss E.", xp: 600, avatar: "ğŸ¹" },
                { name: "Miles M.", xp: 150, avatar: "ğŸ•·ï¸" }
            ],
            user: {
                xp: 0,
                level: 1,
                elaLevel: 0,
                tokens: 0,
                badges: [],
                history: [],
                purchasedItems: [],
                stickers: []
            }
        };
// --- NEW: TIMER LOGIC ---
let missionTimerInterval;
let missionSeconds = 0;

function startTimer() {
    missionSeconds = 0;
    const display = document.getElementById('game-timer');
    clearInterval(missionTimerInterval);

    missionTimerInterval = setInterval(() => {
        missionSeconds++;
        const mins = Math.floor(missionSeconds / 60).toString().padStart(2, '0');
        const secs = (missionSeconds % 60).toString().padStart(2, '0');
        if(display) display.textContent = `${mins}:${secs}`;
    }, 1000);
}

function stopTimer() {
    clearInterval(missionTimerInterval);
    return missionSeconds;
}
        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalBox = document.getElementById('modal-box');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        // Calibration
        const calibrationContent = document.getElementById('calibration-content');
        const questionArea = document.getElementById('question-area');
        const messageBox = document.getElementById('message-box');
        const submitButton = document.getElementById('submit-answer-button');
        const calibrationResults = document.getElementById('calibration-results');
        const elaLevelDisplay = document.getElementById('ela-level-display');
        
        // Missions
        const missionsList = document.getElementById('missions-list');
        const gamePlayScreen = document.getElementById('game-play-screen');
        const gameTitle = document.getElementById('game-title');
        const gamePassage = document.getElementById('game-passage');
        const gameQuestionsArea = document.getElementById('game-questions-area');
        const nextQuestionButton = document.getElementById('next-question-button');
        const finishMissionButton = document.getElementById('finish-mission-button');
        const gameFeedbackArea = document.getElementById('game-feedback-area');
        const missionScoreDisplay = document.getElementById('mission-score-display');
        const missionTotalQuestions = document.getElementById('mission-total-questions');
        const proficiencyDisplay = document.getElementById('proficiency-display');
        
        // Progress & Shop
        const levelDisplay = document.getElementById('level-display');
        const xpDisplay = document.getElementById('xp-display');
        const xpBar = document.getElementById('xp-bar');
        const badgesDisplay = document.getElementById('badges-display');
        const missionHistoryBody = document.getElementById('mission-history-body');
        const tokenDisplay = document.getElementById('token-display');
        const shopItemsList = document.getElementById('shop-items-list');
        const reviewContent = document.getElementById('review-content');


// --- Game Data (Item Bank) ---
// --- STICKER COLLECTIONS DATA ---

const stickerCollections = {
    mythic: {
        name: "Mythic Set",
        items: ['ğŸ‰','ğŸ§™â€â™‚ï¸','ğŸ°','ğŸ¦„','âš”ï¸','ğŸ›¡ï¸','ğŸ”®','ğŸ‘‘']
    },
    space: {
        name: "Cosmic Set",
        items: ['ğŸš€','ğŸ‘½','ğŸª','â˜„ï¸','ğŸ‘¨â€ğŸš€','ğŸ”­','ğŸ›¸','â­']
    },
    literature: {
        name: "Lit Legends",
        items: ['ğŸ“–','ğŸ–‹ï¸','ğŸ“œ','ğŸ•¯ï¸','ğŸ‘“','ğŸ­','ğŸ§›','ğŸ•µï¸â€â™‚ï¸']
    },
    animals: {
        name: "Wild Kingdom",
        items: ['ğŸ¦','ğŸ˜','ğŸ¸','ğŸ¦‹','ğŸ¦ˆ','ğŸ¼','ğŸ¦‰','ğŸ¦Š']
    },
    // --- NEW COLLECTIONS ---
    foodie: {
        name: "Snack Attack",
        items: ['ğŸ•','ğŸ”','ğŸŸ','ğŸ£','ğŸ©','ğŸ¦','ğŸ¥‘','ğŸŒ®']
    },
    sports: {
        name: "MVP Sports",
        items: ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¾','ğŸ','ğŸ¥Š','ğŸ†']
    },
    music: {
        name: "Rock Star",
        items: ['ğŸ¸','ğŸ¹','ğŸ¥','ğŸ·','ğŸº','ğŸ¤','ğŸ§','ğŸ¼']
    },
    travel: {
        name: "World Traveler",
        items: ['âœˆï¸','ğŸ—½','ğŸ—¼','ğŸï¸','â›°ï¸','â›º','ğŸ—ºï¸','ğŸ—¿']
    }
};

// --- UPDATED: RETEACH MINI-LESSONS (The Tutor) ---
const skillLessons = {
    // --- VOCABULARY ---
    'L.8.4.b': "<b>Greek & Latin Roots:</b> 'Bene' means Good (benefit). 'Mal' means Bad (malfunction). 'Spect' means Look (inspect). Memorize these to decode unknown words.",
    'L.8.5.b': "<b>Analogies:</b> Look for the relationship! Is it Part-to-Whole (Chapter : Book)? Tool-to-User (Microscope : Biologist)? Synonym/Antonym? Match that exact relationship.",
    
    // --- GRAMMAR ---
    'L.8.1.c': "<b>Verb Moods:</b> <br>â€¢ <i>Indicative:</i> A fact (The sky is blue).<br>â€¢ <i>Imperative:</i> A command (Go away).<br>â€¢ <i>Subjunctive:</i> A wish or 'what if' (If I were you...).<br>â€¢ <i>Interrogative:</i> A question.",
    'L.8.3.a': "<b>Active vs. Passive Voice:</b> <br>â€¢ <i>Active:</i> The subject DOES the action (The boy kicked the ball).<br>â€¢ <i>Passive:</i> The action happens TO the subject (The ball was kicked by the boy). Active is usually stronger!",
    'SAT.Convention.1': "<b>Sentence Boundaries:</b> Watch out for Run-Ons! You cannot connect two complete sentences with just a comma. Use a period, a semicolon (;), or a comma + conjunction (FANBOYS).",

'L.8.2.a': "<b>Punctuation (Ellipses & Dashes):</b> <br>â€¢ Use an <b>Ellipsis (...)</b> to show a pause or omitted words.<br>â€¢ Use a <b>Dash (â€”)</b> to show a sudden break, interruption, or to emphasize extra info.",
    'L.8.2.c': "<b>Confused Words:</b> <br>â€¢ <i>Effect</i> is usually a Noun (The result).<br>â€¢ <i>Affect</i> is usually a Verb (To change).<br>â€¢ <i>Principal</i> is your pal (Person). <i>Principle</i> is a rule.",
    'RI.8.6': "<b>Point of View:</b> Does the author agree or disagree with the topic? Look for 'charged' words (e.g., 'disastrous' vs. 'innovative') to find their true opinion.",
    // --- READING LITERATURE ---
    'RL.8.6': "<b>Irony & Suspense:</b> <br>â€¢ <i>Situational Irony:</i> The opposite of what you expect happens (e.g., a fire station burns down).<br>â€¢ <i>Suspense:</i> Authors use short sentences, silence, and sensory details (heartbeat, creaking) to build tension.",
    'RL.9.3': "<b>Character Motivation:</b> Why did they do that? Look for the internal desire (revenge, love, fear) that drives the external action.",
    'RL.8.4': "<b>Metaphor & Simile:</b> A Simile uses 'like' or 'as' (Fast as a cheetah). A Metaphor says one thing IS another (Life is a highway).",

    // --- READING INFORMATIONAL ---
    'RI.8.8': "<b>Evaluating Arguments:</b> Does the author have PROOF? Look for statistics, studies, and expert quotes. Beware of 'Anecdotal Evidence' (just one person's story).",
    'RI.8.2': "<b>Central Idea:</b> What is the 'Big Picture'? Read the first and last sentence of the passage. The title is also a huge clue!",
    'RI.8.5': "<b>Text Structure:</b> How is it built?<br>â€¢ <i>Compare/Contrast:</i> similarities/differences.<br>â€¢ <i>Problem/Solution:</i> Explains an issue and how to fix it.<br>â€¢ <i>Chronological:</i> Time order.",
    'W.8.8': "<b>Research Credibility:</b> Trust experts (.edu, .gov, organizations), not random blogs. Check the date: is the info current?",

    'RL.8.4.sound': "<b>Sound Devices:</b> <br>â€¢ <i>Alliteration:</i> Repeated beginning sounds (Peter Piper picked).<br>â€¢ <i>Assonance:</i> Repeated VOWEL sounds inside words (The r<b>ai</b>n in Sp<b>ai</b>n).",
    'RI.8.8.eval': "<b>Evidence Strength:</b> <br>â€¢ <i>Relevant:</i> Directly supports the claim.<br>â€¢ <i>Irrelevant:</i> Off-topic.<br>â€¢ <i>Sufficient:</i> Is there ENOUGH proof, or just one example?",

    'W.8.2.c': "<b>Sentence Placement:</b> Good writing flows logically. <br>â€¢ Look for <i>transition words</i> (However, Therefore).<br>â€¢ Look for <i>pronouns</i> (It, He, They) referring to a previous noun.<br>â€¢ Keep 'Time' and 'Action' in order.",
    'RL.8.9': "<b>Modern vs. Traditional:</b> Authors often retell old myths in modern settings.<br>â€¢ Look for matching <i>character traits</i> (e.g., a strong warrior becomes a quarterback).<br>â€¢ Look for similar <i>conflicts</i> or <i>themes</i>.",
    'L.8.4.a': "<b>Context Clues (Academic):</b> When you see a tough 'Science' or 'History' word, look at the sentences <i>around</i> it. Is there a definition, an example, or a contrast word (unlike, but) nearby?",
};

// ======================================================
// ğŸš€ MASTER CONTENT DATABASE (NWEA + SAT + STORY)
// ======================================================

const itemBank = [
    // --- CALIBRATION / DIAGNOSTIC (IAR Standard RI.8.1) ---
    {
        id: 'cal-1', type: 'MC', standard: 'RI.8.1', difficulty: 5, type_tag: 'calibration',
        passage: "The proliferation of digital interfaces has fundamentally altered human attention spans. While some argue that this 'hyper-connectivity' fosters multitasking, studies suggest it actually degrades deep-cognitive processing.",
        stem: 'Which statement best summarizes the central idea regarding digital interfaces?',
        options: ['They help humans learn to multitask better.', 'They are essential for modern cognitive development.', 'They may negatively impact the ability to think deeply.', 'They have had no measurable effect on attention.'],
        correct_answer: 'They may negatively impact the ability to think deeply.',
        rationale: 'The text states it "degrades deep-cognitive processing," which directly supports the idea of a negative impact on deep thought.'
    },

    // --- VOCABULARY MASTERY (NWEA Standard L.8.4.b) ---
    {
        id: 'voc-roots-1', type: 'MC', standard: 'L.8.4.b', difficulty: 4,
        passage: "The benevolent king granted a pardon to the prisoner, a gesture that surprised his malevolent advisor.",
        stem: 'Based on the root "bene" and "mal", what is the relationship between "benevolent" and "malevolent"?',
        options: ['They are synonyms.', 'They are antonyms.', 'They both mean "evil".', 'They both mean "kingly".'],
        correct_answer: 'They are antonyms.',
        rationale: 'The root "bene" means good and "mal" means bad; therefore, the words are opposites (antonyms).'
    },

    // --- COMPLEX LITERARY ANALYSIS (IAR Standard RL.8.6) ---
    {
        id: 'lit-irony-1', type: 'MC', standard: 'RL.8.6', difficulty: 7,
        passage: "Mr. Graves was the most feared dentist in town. Ironically, his own teeth were crooked and yellow, and he was terrified of letting anyone else work on them.",
        stem: 'Which type of irony is present in this passage?',
        options: ['Verbal Irony', 'Situational Irony', 'Dramatic Irony', 'Socratic Irony'],
        correct_answer: 'Situational Irony',
        rationale: 'Situational irony occurs when the outcome is the opposite of what is expected (e.g., a dentist fearing dental work).'
    },

    // --- ARGUMENT SYNTHESIS (High Rigor Mastery RI.8.8) ---
    {
        id: 'mast-arg-1', type: 'MC', standard: 'RI.8.8', difficulty: 9,
        passage: "Proponents of renewable energy cite its low environmental impact. Conversely, critics point to the 'intermittency problem'â€”the fact that solar and wind power are not constant. However, recent breakthroughs in battery storage technology are beginning to mitigate these concerns.",
        stem: "How does the author use the concept of 'battery storage' to strengthen the overall argument?",
        options: [
            'By acknowledging a valid criticism and providing a technological solution.',
            'By proving that renewable energy is more expensive than fossil fuels.',
            'By dismissing the critics as being uninformed about modern science.',
            'By suggesting that renewable energy is not yet ready for public use.'
        ],
        correct_answer: 'By acknowledging a valid criticism and providing a technological solution.',
        rationale: "The author uses 'Counter-argument/Rebuttal' structure: acknowledging a flaw (intermittency) and providing evidence (batteries) that the flaw is being addressed."
    }
    // YOU CAN PASTE ALL 20+ PREVIOUS ITEMS HERE USING THIS SAME FORMAT (ID, TYPE, STANDARD, DIFFICULTY, PASSAGE, STEM, OPTIONS, CORRECT_ANSWER, RATIONALE)
];

        const allBadges = {
            'first_mission': { name: 'First Quest', icon: 'ğŸŒŸ' },
            'perfect_score': { name: 'Flawless Victory', icon: 'ğŸ¯' },
            'hot_text_master': { name: 'Text Alchemist', icon: 'ğŸ“' },
            'boss_slayer': { name: 'Glitch Hunter', icon: 'ğŸ‘¾' }
        };

const shopItems = [
    { 
        id: 'mystery-box', 
        name: 'ğŸ° High Roller Box', 
        description: 'High Risk (100 Tokens). Win Stickers, XP, or JACKPOT.', 
        cost: 100, 
        type: 'consumable',
        color: 'bg-gradient-to-r from-fuchsia-600 to-purple-600 border-2 border-yellow-400',
        action: async () => {
            // ALL possible stickers (Old + New)
            const possibleStickers = [
                'ğŸ‰','ğŸ§™â€â™‚ï¸','ğŸ°','ğŸ¦„','âš”ï¸','ğŸ›¡ï¸','ğŸ”®','ğŸ‘‘', // Mythic
                'ğŸš€','ğŸ‘½','ğŸª','â˜„ï¸','ğŸ‘¨â€ğŸš€','ğŸ”­','ğŸ›¸','â­', // Space
                'ğŸ¦','ğŸ˜','ğŸ¸','ğŸ¦‹','ğŸ¦ˆ','ğŸ¼','ğŸ¦‰','ğŸ¦Š', // Animals
                'ğŸ“–','ğŸ–‹ï¸','ğŸ“œ','ğŸ•¯ï¸','ğŸ‘“','ğŸ­','ğŸ§›','ğŸ•µï¸â€â™‚ï¸', // Lit
                'ğŸ•','ğŸ”','ğŸŸ','ğŸ£','ğŸ©','ğŸ¦','ğŸ¥‘','ğŸŒ®', // Food
                'âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¾','ğŸ','ğŸ¥Š','ğŸ†', // Sports
                'ğŸ¸','ğŸ¹','ğŸ¥','ğŸ·','ğŸº','ğŸ¤','ğŸ§','ğŸ¼', // Music
                'âœˆï¸','ğŸ—½','ğŸ—¼','ğŸï¸','â›°ï¸','â›º','ğŸ—ºï¸','ğŸ—¿'  // Travel
            ];
            const roll = Math.random();
            let msg = ""; 
            let type = "info";
            if (roll < 0.25) { 
                msg = "ğŸ’¨ Dust and cobwebs... The box was empty.";
                type = "error"; 
                playSound('incorrect'); 
            } 
            else if (roll < 0.50) { 
                const xp = 200;
                addXp(xp); 
                msg = `âœ¨ Not bad! You found <b>${xp} XP</b>!`; 
                type = "success"; 
                playSound('correct');
            } 
            else if (roll < 0.80) { 
                const newSticker = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                if(!gameState.user.stickers.includes(newSticker)) {
                    gameState.user.stickers.push(newSticker);
                    msg = `ğŸ‰ You found a Sticker!<br><span class="text-6xl block mt-4">${newSticker}</span>`;
                    type = "success";
                    triggerConfetti();
                } else {
                    gameState.user.tokens += 25;
                    msg = `You found a Sticker (${newSticker}), but you owned it. Refunded 25 Tokens.`;
                }
                playSound('win');
            }
            else if (roll < 0.95) {
                const tk = 150;
                gameState.user.tokens += tk;
                msg = `ğŸ’° Money Bags! You found <b>${tk} Tokens</b>!`;
                type = "success";
                playSound('buy');
            }
            else { 
                // JACKPOT
                const s1 = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                const s2 = possibleStickers[Math.floor(Math.random() * possibleStickers.length)];
                if(!gameState.user.stickers.includes(s1)) gameState.user.stickers.push(s1);
                if(!gameState.user.stickers.includes(s2)) gameState.user.stickers.push(s2);
                addXp(500);
                msg = `ğŸš¨ <b>MEGA JACKPOT!!</b> ğŸš¨<br>You found 500 XP and TWO Stickers!<br><div class="flex justify-center gap-4 mt-4 text-6xl"><span>${s1}</span><span>${s2}</span></div>`;
                type = "success";
                playSound('win'); 
                triggerConfetti();
            }
            saveProgress(); updateUI();
            await showModal('Mystery Box Result', msg, type);
        }
    },
    // --- EXISTING PACKS ---
    { 
        id: 'sticker-pack-myth', name: 'ğŸ‰ Mythic Pack', description: 'Fantasy Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-emerald-500 to-teal-600',
        action: () => buyStickerPack(stickerCollections.mythic.items, 'Mythic')
    },
    { 
        id: 'sticker-pack-space', name: 'ğŸš€ Cosmic Pack', description: 'Space Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-blue-600 to-indigo-800',
        action: () => buyStickerPack(stickerCollections.space.items, 'Cosmic')
    },
    { 
        id: 'sticker-pack-lit', name: 'ğŸ“– Lit Pack', description: 'Book Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-amber-600 to-orange-700',
        action: () => buyStickerPack(stickerCollections.literature.items, 'Literature')
    },
    { 
        id: 'sticker-pack-zoo', name: 'ğŸ¦ Animal Pack', description: 'Wild Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-green-600 to-lime-700',
        action: () => buyStickerPack(stickerCollections.animals.items, 'Animal')
    },
    // --- NEW PACKS ---
    { 
        id: 'sticker-pack-food', name: 'ğŸ• Snack Pack', description: 'Yummy Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-yellow-400 to-orange-500',
        action: () => buyStickerPack(stickerCollections.foodie.items, 'Snack')
    },
    { 
        id: 'sticker-pack-sport', name: 'ğŸ† Sports Pack', description: 'Athletic Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-blue-500 to-cyan-500',
        action: () => buyStickerPack(stickerCollections.sports.items, 'Sports')
    },
    { 
        id: 'sticker-pack-music', name: 'ğŸ¸ Rock Pack', description: 'Music Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-purple-500 to-pink-500',
        action: () => buyStickerPack(stickerCollections.music.items, 'Music')
    },
    { 
        id: 'sticker-pack-travel', name: 'âœˆï¸ Travel Pack', description: 'World Stickers.', cost: 50, type: 'consumable', color: 'bg-gradient-to-br from-indigo-400 to-blue-600',
        action: () => buyStickerPack(stickerCollections.travel.items, 'Travel')
    },
    // --- POWER UPS ---
    { 
        id: 'skip-ticket', name: 'â© Skip Ticket', description: 'Auto-Corrects a hard question.', cost: 75, type: 'consumable', color: 'bg-gradient-to-br from-cyan-400 to-blue-500',
        action: () => { gameState.user.purchasedItems.push({ id: 'skip-ticket' }); playSound('buy'); }
    },
    { 
        id: 'lifeline-5050', name: 'ğŸ’£ 50/50 Bomb', description: 'Removes 2 wrong answers.', cost: 30, type: 'consumable', color: 'bg-gradient-to-br from-red-500 to-orange-500',
        action: () => { gameState.user.purchasedItems.push({ id: 'lifeline-5050' }); playSound('buy'); }
    }
];

// Helper for buying packs (Keep code clean)
async function buyStickerPack(pool, packName) {
    const newSticker = pool[Math.floor(Math.random() * pool.length)];
    if(!gameState.user.stickers.includes(newSticker)) {
        gameState.user.stickers.push(newSticker);
        playSound('win'); triggerConfetti();
        await showModal(`${packName} Pack!`, `You got: <span class="text-6xl block mt-2">${newSticker}</span>`, 'success');
    } else {
        gameState.user.tokens += 15; // Increased refund slightly
        playSound('buy');
        await showModal('Duplicate!', `You already have ${newSticker}. Refunded 15 Tokens.`, 'info');
    }
    saveProgress();
}

        // --- CORE FUNCTIONS ---
function showModal(title, message, type = 'info') {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // <--- UPDATED: Allows bold/italic text in explanations
            
            modalBox.className = `bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center relative transform transition-all duration-300`;
            if(type === 'success') { modalBox.classList.add('border-t-4', 'border-green-500'); modalTitle.className='text-2xl font-bold mb-2 text-green-600'; }
            else if(type === 'error') { modalBox.classList.add('border-t-4', 'border-red-500'); modalTitle.className='text-2xl font-bold mb-2 text-red-600'; }
            else { modalBox.classList.add('border-t-4', 'border-blue-500'); modalTitle.className='text-2xl font-bold mb-2 text-blue-600'; }
            
            modalBackdrop.classList.remove('hidden');
            setTimeout(() => { modalBox.classList.remove('scale-95', 'opacity-0'); }, 10);
            return new Promise(resolve => {
                modalOkBtn.onclick = () => {
                    modalBox.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => { modalBackdrop.classList.add('hidden'); resolve(); }, 300);
                };
            });
        }

        function navigate(screenId) {
            screens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            gameState.currentScreen = screenId;
        }

        // --- Calibration Logic ---
        let calibrationProgress = { questions: [], currentQuestion: 0, elaLevel: 0 };
function startCalibrationQuest() {
    // This finds items that have the 'calibration' tag in our database
    calibrationProgress.questions = itemBank.filter(item => item.type_tag === 'calibration' || item.type === 'calibration');
    calibrationProgress.currentQuestion = 0;
    calibrationProgress.elaLevel = 0;
    
    if(calibrationProgress.questions.length === 0) {
        showModal("Error", "No calibration items found!", "error");
        return;
    }
    navigate('calibration-screen');
    renderCalibrationQuestion();
}

function renderCalibrationQuestion() {
    const currentItem = calibrationProgress.questions[calibrationProgress.currentQuestion];
    if (!currentItem) { endCalibrationQuest(); return; }

    questionArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-lg mb-2 text-blue-600 uppercase">Diagnostic Question ${calibrationProgress.currentQuestion + 1}</p>
            <div class="p-6 bg-white dark:bg-gray-700 rounded-xl shadow-inner border-l-4 border-blue-500 mb-4">
                <p class="italic text-gray-800 dark:text-gray-100 font-serif leading-relaxed">${currentItem.passage}</p>
            </div>
        </div>
        <div>
            <p class="font-bold mb-4 text-xl">${currentItem.items[0].stem}</p>
            <div id="options-container" class="grid grid-cols-1 gap-3">
                ${currentItem.items[0].options.map(option => `
                    <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all">
                        <input type="radio" name="calibration-q" value="${option}" class="mr-3 w-5 h-5">
                        <span class="text-lg font-medium">${option}</span>
                    </label>`).join('')}
            </div>
        </div>`;
    submitButton.onclick = submitCalibrationAnswer;
}

        async function submitCalibrationAnswer() {
            const selectedOption = document.querySelector('input[name="calibration-q"]:checked');
            if (!selectedOption) { await showModal('Oops!', 'Please select an answer.', 'error'); return; }

            const currentItem = calibrationProgress.questions[calibrationProgress.currentQuestion];
            const isCorrect = selectedOption.value === currentItem.items[0].correct_answer;

            if (isCorrect) {
                calibrationProgress.elaLevel += currentItem.items[0].difficulty;
                playSound('correct');
                await showModal('Correct!', 'Nice job! ' + currentItem.items[0].rationale, 'success');
            } else {
                playSound('incorrect');
                await showModal('Incorrect.', 'The correct answer was ' + currentItem.items[0].correct_answer, 'error');
            }
            
            calibrationProgress.currentQuestion++;
            renderCalibrationQuestion();
        }

function endCalibrationQuest() {
    const score = calibrationProgress.elaLevel;
    let rank = "";
    
    // NWEA Parallelism: Sorting students into tiers based on diagnostic performance
    if (score >= 8) {
        gameState.user.elaLevel = 3; // Tier 3: Mastery/Elite
        rank = "Elite Scholar";
    } else if (score >= 4) {
        gameState.user.elaLevel = 2; // Tier 2: Proficient
        rank = "Skill Seeker";
    } else {
        gameState.user.elaLevel = 1; // Tier 1: Foundation
        rank = "Novice Adventurer";
    }

    calibrationContent.classList.add('hidden');
    elaLevelDisplay.innerHTML = `<span class="text-indigo-600 font-black tracking-tighter underline">${rank}</span>`;
    calibrationResults.classList.remove('hidden');
    saveProgress();
}

// --- Missions Logic ---
function renderMissions() {
    missionsList.innerHTML = '';
    proficiencyDisplay.textContent = gameState.user.elaLevel >= 4 ? 'Proficient' : 'Rookie';
    
    allMissions.forEach(mission => {
        const isLocked = gameState.user.level < mission.minLevel;
        const missionCard = document.createElement('div');
        
        // Define styling for difficulty colors
        const diffColor = mission.difficulty > 7 ? 'text-red-500' : (mission.difficulty > 4 ? 'text-orange-500' : 'text-green-500');

        if (isLocked) {
            missionCard.className = `bg-gray-100 dark:bg-gray-800 rounded-2xl p-6 shadow border-2 border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center text-center opacity-60`;
            missionCard.innerHTML = `
                <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ”’</div>
                <h3 class="text-lg font-bold text-gray-400">Level ${mission.minLevel} Required</h3>
                <p class="text-sm text-gray-400 mb-4">${mission.title}</p>
                <div class="w-full h-2 bg-gray-200 rounded-full"></div>
            `;
        } else {
            missionCard.className = `bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl border border-indigo-100 dark:border-indigo-900 flex flex-col hover:border-indigo-500 transition-all transform hover:-translate-y-1 cursor-pointer`;
            missionCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-tighter">LVL ${mission.minLevel}+</span>
                    <span class="${diffColor} text-xs font-bold">Difficulty: ${mission.difficulty}/10</span>
                </div>
                <h3 class="text-xl font-bold mb-1 text-gray-800 dark:text-gray-100">${mission.title}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-6 leading-relaxed">${mission.description}</p>
                <button class="start-mission-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-colors" data-mission-id="${mission.id}">
                    BEGIN QUEST âš”ï¸
                </button>
            `;
        }
        missionsList.appendChild(missionCard);
    });

    // Handle Boss Logic separately at the bottom
    appendBossCardToMissions();

    // Attach Listeners
    document.querySelectorAll('.start-mission-btn').forEach(btn => {
        btn.onclick = (e) => startMission(e.target.dataset.missionId);
    });

    navigate('missions-screen');
}

function appendBossCardToMissions() {
    const glitches = gameState.user.missedQuestions || [];
    const isClean = glitches.length === 0;
    
    const bossCard = document.createElement('div');
    bossCard.className = `col-span-1 md:col-span-2 lg:col-span-3 bg-gradient-to-br from-red-600 to-black text-white rounded-3xl p-8 shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6 border-4 border-red-500/50 relative overflow-hidden group mt-8`;
    
    bossCard.innerHTML = `
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
        <div class="relative z-10 text-center md:text-left">
            <h3 class="text-4xl font-black uppercase tracking-tighter mb-2 italic">ğŸ‘¾ THE GLITCH</h3>
            <p class="text-red-200 font-medium max-w-md">
                ${isClean ? "The system is fully operational. Face the Final Exam to prove your mastery!" : `SYSTEM CORRUPTION DETECTED: You must purge <b>${glitches.length} glitches</b> in the Archive to unlock the Boss.`}
            </p>
        </div>
        <div class="relative z-10 flex flex-col items-center">
            <button id="mission-boss-btn" class="${isClean ? 'bg-white text-red-600 hover:scale-110 active:scale-95' : 'bg-gray-700 text-gray-500 cursor-not-allowed'} font-black py-4 px-10 rounded-2xl shadow-xl transition-all uppercase italic tracking-widest border-b-4 border-gray-300" ${isClean ? '' : 'disabled'}>
                ${isClean ? 'FIGHT BOSS âš”ï¸' : 'LOCKED ğŸ”’'}
            </button>
            ${!isClean ? `<button onclick="openArchive()" class="mt-4 text-sm text-red-400 underline hover:text-white font-bold transition-colors">Open Glitch Archive</button>` : ''}
        </div>
    `;
    
    missionsList.appendChild(bossCard);
    
    // Wire up the button if it's unlocked
    const btn = document.getElementById('mission-boss-btn');
    if (btn && isClean) {
        btn.onclick = startBossRound;
    }
}

function startMission(missionId) {
    gameState.currentMission = allMissions.find(m => m.id === missionId);
    gameState.currentQuestionIndex = 0;
    gameState.missionScore = 0;
    gameState.streak = 0;
    gameState.missionHistoryData = [];

    navigate('game-play-screen');
    startTimer(); // <--- NEW: START THE CLOCK
    renderMissionQuestion();
}

// --- UPDATED: RENDER MISSION (Supports Multi-Source Tabs) ---
function renderMissionQuestion() {
    const missionItem = itemBank.find(item => item.items.some(i => i.id.startsWith(gameState.currentMission.passageId)));
    const currentItem = missionItem.items[gameState.currentQuestionIndex];
    
    if (!currentItem) { endMission(missionItem.items.length); return; }
    
    // Header Stats
    gameTitle.textContent = gameState.currentMission.title;
    const streakDisplay = gameState.streak > 1 ? `<span class="text-orange-500 ml-2">ğŸ”¥ x${gameState.streak}</span>` : '';
    missionScoreDisplay.innerHTML = `${gameState.missionScore} ${streakDisplay}`;
    missionTotalQuestions.textContent = missionItem.items.length;

    // --- NEW: TAB SYSTEM FOR MULTI-SOURCE ---
    if (missionItem.sources) {
        // 1. Build Tab Buttons
        let tabsHTML = `<div class="flex flex-wrap gap-2 mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">`;
        missionItem.sources.forEach((src, idx) => {
            tabsHTML += `<button onclick="switchTab(${idx})" id="tab-btn-${idx}" class="tab-btn px-3 py-1 text-sm font-bold rounded-t-lg transition-colors ${idx === 0 ? 'bg-indigo-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300'}">
                ${src.title}
            </button>`;
        });
        tabsHTML += `</div>`;

        // 2. Build Tab Content Areas
        let contentHTML = `<div class="relative min-h-[300px]">`;
        missionItem.sources.forEach((src, idx) => {
            const hiddenClass = idx === 0 ? '' : 'hidden';
            const imgHTML = src.image ? `<img src="${src.image}" class="w-full rounded-lg shadow-md mb-4 border border-gray-200">` : '';
            contentHTML += `<div id="tab-content-${idx}" class="tab-content ${hiddenClass} animate-fade">
                <h4 class="font-bold text-lg mb-2 text-indigo-600 dark:text-indigo-400">${src.title}</h4>
                ${imgHTML}
                <div class="prose dark:prose-invert max-w-none text-sm md:text-base">${src.text}</div>
            </div>`;
        });
        contentHTML += `</div>`;

        gamePassage.innerHTML = tabsHTML + contentHTML;
    } else {
        // Fallback for Standard Single Passage
        gamePassage.innerHTML = `<p class="font-bold mb-2 text-lg text-indigo-600 dark:text-indigo-400">Passage</p><div class="prose dark:prose-invert max-w-none">${missionItem.passage}</div>`;
    }

    // Question Area (Standard)
    let qImageHTML = currentItem.image ? `<div class="mb-4 text-center"><img src="${currentItem.image}" class="rounded-lg shadow-md max-w-full h-auto mx-auto border border-gray-200"></div>` : '';
    
    gameQuestionsArea.innerHTML = `
        <div class="mb-4">
            <div class="flex justify-between items-end mb-2">
                <p class="font-bold text-lg">Question ${gameState.currentQuestionIndex + 1}</p>
                <span class="text-xs font-mono text-gray-400">${currentItem.standard || ''}</span>
            </div>
            ${qImageHTML} 
            <p class="mb-4 text-lg font-medium">${currentItem.stem}</p>
            <div id="options-container" class="space-y-3"></div>
        </div>`;

    // Hints
    if (currentItem.hint) {
        const hintBtn = document.createElement('button');
        hintBtn.className = "mb-4 text-xs bg-yellow-100 text-yellow-800 px-3 py-1 rounded border border-yellow-300 hover:bg-yellow-200 flex items-center shadow-sm";
        hintBtn.innerHTML = `ğŸ’¡ Get Hint (10 Tokens)`;
        hintBtn.onclick = () => {
            if(gameState.user.tokens >= 10) {
                gameState.user.tokens -= 10;
                hintBtn.innerHTML = `ğŸ’¡ <b>Hint:</b> ${currentItem.hint}`;
                hintBtn.className = "mb-4 text-xs bg-yellow-50 text-yellow-900 px-3 py-2 rounded border border-yellow-200 italic";
                hintBtn.onclick = null;
                updateUI();
                playSound('buy');
            } else {
                showModal('Not enough tokens', 'You need 10 tokens to buy a hint.', 'error');
            }
        };
        gameQuestionsArea.querySelector('.mb-4').appendChild(hintBtn);
    }

    // Options Rendering
    const optionsContainer = document.getElementById('options-container');
    
    // Add Eliminator Toggle
    const toolBar = document.createElement('div');
    toolBar.className = "flex justify-end mb-2";
    toolBar.innerHTML = `
        <label class="flex items-center space-x-2 cursor-pointer text-xs font-bold text-gray-500 hover:text-red-500 transition-colors">
            <input type="checkbox" id="eliminator-toggle" class="form-checkbox h-3 w-3 text-red-500 rounded">
            <span>âœï¸ Eliminator Mode</span>
        </label>
    `;
    optionsContainer.parentElement.insertBefore(toolBar, optionsContainer);

    if (currentItem.type === 'MC') {
        optionsContainer.innerHTML = currentItem.options.map((option, index) => `
            <div class="option-wrapper relative group">
                <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all shadow-sm" id="opt-label-${index}">
                    <input type="radio" name="mission-q" value="${option}" class="mt-1 mr-3 w-5 h-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    <span class="flex-1 text-base text-gray-800 dark:text-gray-200 leading-snug">${option}</span>
                </label>
                <div class="absolute inset-0 z-20 cursor-crosshair hidden" onclick="toggleEliminate(${index})">
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 bg-red-500/10 rounded-xl transition-opacity">
                        <span class="text-red-500 font-bold text-xl">âŒ CROSS OUT</span>
                    </div>
                </div>
            </div>`).join('');

        document.getElementById('eliminator-toggle').addEventListener('change', (e) => {
            const isModeOn = e.target.checked;
            document.querySelectorAll('.option-wrapper .absolute.z-20').forEach(overlay => {
                if(isModeOn) overlay.classList.remove('hidden');
                else overlay.classList.add('hidden');
            });
        });
    } 
    else if (currentItem.type === 'hot-text') {
        // Check if passage content or source content
        const textToUse = missionItem.sources ? missionItem.sources[0].text : missionItem.passage;
        const words = textToUse.split(/\s+/);
        optionsContainer.innerHTML = `<div id="hot-text-container" class="text-lg leading-relaxed p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700"></div>`;
        const container = document.getElementById('hot-text-container');
        words.forEach(word => {
            const span = document.createElement('span');
            span.className = 'hot-text-word';
            span.textContent = word + ' ';
            span.onclick = () => span.classList.toggle('selected');
            container.appendChild(span);
        });
    }

    renderSubmitButton(currentItem, missionItem.items.length);
}

// Helper to Switch Tabs
window.switchTab = function(tabIndex) {
    // 1. Hide all content
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    // 2. Show selected
    document.getElementById(`tab-content-${tabIndex}`).classList.remove('hidden');
    
    // 3. Update Buttons
    document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
        if(idx === tabIndex) {
            btn.classList.remove('bg-gray-200', 'text-gray-600', 'dark:bg-gray-700', 'dark:text-gray-300');
            btn.classList.add('bg-indigo-500', 'text-white');
        } else {
            btn.classList.add('bg-gray-200', 'text-gray-600', 'dark:bg-gray-700', 'dark:text-gray-300');
            btn.classList.remove('bg-indigo-500', 'text-white');
        }
    });
};

function toggleEliminate(index) {
    const label = document.getElementById(`opt-label-${index}`);
    if (label.classList.contains('opacity-40')) {
        label.classList.remove('opacity-40', 'line-through', 'grayscale');
    } else {
        label.classList.add('opacity-40', 'line-through', 'grayscale');
        const radio = label.querySelector('input');
        if(radio) radio.checked = false;
    }
}
        // Helper to separate logic
        function renderLifeline(currentItem, container) {
            const btnId = 'lifeline-btn';
            const existing = document.getElementById(btnId);
            if(existing) existing.remove();

            if (gameState.user.purchasedItems.some(i => i.id === 'lifeline-5050') && currentItem.type === 'MC') {
                const btn = document.createElement('button');
                btn.id = btnId;
                btn.className = "mb-4 text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded border border-purple-300 hover:bg-purple-200";
                btn.innerHTML = "ğŸ’£ Use 50/50 Bomb";
                btn.onclick = () => {
                    const inputs = Array.from(document.querySelectorAll('input[name="mission-q"]'));
                    const wrong = inputs.filter(i => i.value !== currentItem.correct_answer);
                    wrong.sort(() => Math.random() - 0.5).slice(0, 2).forEach(i => i.closest('label').classList.add('hidden'));
                    const idx = gameState.user.purchasedItems.findIndex(i => i.id === 'lifeline-5050');
                    if (idx > -1) gameState.user.purchasedItems.splice(idx, 1);
                    btn.remove();
                    playSound('buy'); saveProgress(); updateUI();
                };
                container.parentElement.insertBefore(btn, container);
            }
        }

function renderSubmitButton(currentItem, total) {
            const existing = document.getElementById("submit-mission-btn");
            if(existing) existing.remove();
            
            const btn = document.createElement('button');
            btn.id = "submit-mission-btn";
            btn.className = 'button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg';
            btn.textContent = 'Submit Answer';
            btn.onclick = () => checkMissionAnswer(currentItem, total, btn);
            
            // FIX: Select the container specifically inside the Game Play Screen
            const container = document.querySelector('#game-play-screen .flex.justify-end');
            if (container) {
                container.prepend(btn);
            } else {
                console.error("Game container not found!");
            }

            document.getElementById('next-question-button').classList.add('hidden');
            document.getElementById('finish-mission-button').classList.add('hidden');
        }

async function checkMissionAnswer(currentItem, total, btn) {
            let isCorrect = false;
            let userAnswer = null;

            if (currentItem.type === 'MC') {
                const selected = document.querySelector('input[name="mission-q"]:checked');
                if(!selected) { await showModal('Oops', 'Select an answer', 'error'); return; }
                userAnswer = selected.value;
                isCorrect = userAnswer === currentItem.correct_answer;
            } else if (currentItem.type === 'hot-text') {
                const selected = Array.from(document.querySelectorAll('.hot-text-word.selected')).map(e => e.textContent.trim());
                userAnswer = selected;
                isCorrect = JSON.stringify(selected.sort()) === JSON.stringify(currentItem.correct_answer.sort());
            }

            // --- TRACK STATS ---
            if (!gameState.user.standardsReport) gameState.user.standardsReport = {};
            const std = currentItem.standard || "General";
            if (!gameState.user.standardsReport[std]) {
                gameState.user.standardsReport[std] = { correct: 0, total: 0, desc: getStandardDesc(std) };
            }
            gameState.user.standardsReport[std].total++;
            if (isCorrect) gameState.user.standardsReport[std].correct++;
            
            // --- NEW: CAPTURE GLITCHES (Save Missed Qs) ---
            if (!isCorrect) {
                if(!gameState.user.missedQuestions) gameState.user.missedQuestions = [];
                // Prevent duplicates
                if(!gameState.user.missedQuestions.some(q => q.id === currentItem.id)) {
                    gameState.user.missedQuestions.push(currentItem);
                    saveProgress();
                }
            }

            // Feedback Logic
            let feedbackMsg = currentItem.rationale;
            if (!isCorrect && currentItem.feedback && currentItem.feedback[userAnswer]) {
                feedbackMsg = `<b>${currentItem.feedback[userAnswer]}</b><br><br>Right Answer: ${currentItem.rationale}`;
            }

            gameState.missionHistoryData.push({ 
                question: currentItem.stem, standard: currentItem.standard || 'General', 
                userAnswer, isCorrect, rationale: currentItem.rationale 
            });

            if (isCorrect) {
                gameState.missionScore++;
                gameState.streak++;
                playSound('correct');
                const streakMsg = gameState.streak > 1 ? ` (Streak x${gameState.streak}!)` : '';
                await showModal('Correct!' + streakMsg, feedbackMsg, 'success');
            } else {
                gameState.streak = 0;
                playSound('incorrect');
                // Updated Message: Directs them to the Archive
                await showModal('Glitch Detected!', `<b>Incorrect.</b><br>This question has been saved to the <b>Glitch Archive</b>. Go there to study the skill and fix the glitch!<br><br>${feedbackMsg}`, 'error');
            }
            
            btn.remove();
            if (gameState.currentQuestionIndex < total - 1) {
                const nextBtn = document.getElementById('next-question-button');
                nextBtn.classList.remove('hidden');
                nextBtn.onclick = () => { gameState.currentQuestionIndex++; renderMissionQuestion(); };
            } else {
                const finBtn = document.getElementById('finish-mission-button');
                finBtn.classList.remove('hidden');
                finBtn.onclick = () => endMission(total);
            }
        }

        // Helper to name standards (Paste this right below checkMissionAnswer)
        function getStandardDesc(std) {
            const map = {
                'RI.8.1': 'Citing Evidence',
                'RL.8.4': 'Figurative Language',
                'RL.8.2': 'Theme Analysis',
                'RI.9-10.9': 'Comparing Texts',
                'RI.8.8': 'Evaluating Arguments',
                'RL.9.3': 'Character Development',
                'RI.9.6': 'Rhetoric & Purpose',
                'RI.12.2': 'Complex Text Analysis',
                'RL.12.6': 'Satire & Tone'
            };
            return map[std] || 'General Comprehension';
        }

function endMission(total) {
    const timeTaken = stopTimer(); // <--- NEW: STOP CLOCK

    const xpEarned = Math.round((gameState.missionScore / total) * 100);
    const accuracy = gameState.missionScore / total;

    // SPEED BONUS LOGIC:
    // If they average under 30 seconds per question, they get a bonus.
    const avgTimePerQ = timeTaken / total;
    let speedBonus = 0;
    if(avgTimePerQ < 20) speedBonus = 20;      // Super fast
    else if(avgTimePerQ < 40) speedBonus = 10; // Decent pace

    // Calculate Tokens (Base + Accuracy + Speed)
    let tokensEarned = Math.round((gameState.missionScore * 10) * (1 + accuracy)) + speedBonus;

    gameState.user.tokens += tokensEarned;
    addXp(xpEarned);

    // ... (Keep your Rivals Logic here) ...

    // ... (Keep your Badge Logic here) ...

    // ... (Keep History Save here) ...

    // Pass the speed bonus to the review screen so they see it
    renderReview(total, xpEarned, tokensEarned, null, speedBonus, timeTaken);
}

        // --- REVIEW SCREEN LOGIC ---
        function renderReview(total, xp, tokens, badge) {
            const reviewContent = document.getElementById('review-content');
            reviewContent.innerHTML = ''; // Clear previous data

            // 1. Summary Header
            const summaryCard = document.createElement('div');
            summaryCard.className = "bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg border-t-4 border-indigo-500 text-center mb-8";
// Calculate formatted time
const mins = Math.floor(timeTaken / 60);
const secs = (timeTaken % 60).toString().padStart(2, '0');

summaryCard.innerHTML = `
    <h2 class="text-3xl font-bold mb-2 text-indigo-600 dark:text-indigo-400">Mission Complete!</h2>
    <div class="flex justify-center gap-6 text-lg font-bold mb-4">
        <span class="text-blue-500">Score: ${gameState.missionScore}/${total}</span>
        <span class="text-amber-500">â±ï¸ ${mins}:${secs}</span>
        <span class="text-green-500">+${xp} XP</span>
        <span class="text-yellow-500">+${tokens} Tokens</span>
    </div>
    ${speedBonus > 0 ? `<div class="text-sm font-bold text-green-600 mb-2">âš¡ Speed Bonus: +${speedBonus} Tokens!</div>` : ''}
    ${badge ? `<div class="bg-yellow-100 text-yellow-800 p-2 rounded-lg inline-block animate-bounce">ğŸ† Badge Unlocked: ${badge.name}</div>` : ''}
`;
            reviewContent.appendChild(summaryCard);

// 2. Question Breakdown
            gameState.missionHistoryData.forEach((data, index) => {
                const card = document.createElement('div');
                const isCorrect = data.isCorrect;
                card.className = `p-6 rounded-lg shadow-md border-l-8 ${isCorrect ? 'bg-green-50 border-green-500 dark:bg-gray-800' : 'bg-red-50 border-red-500 dark:bg-gray-800'}`;
                
                // Determine Video Link (You can customize this per standard)
                let videoLink = '';
                if (!isCorrect) {
                     // Search YouTube for the Standard (e.g., "RI.8.1 help")
                     const searchUrl = `https://www.youtube.com/results?search_query=ELA+Standard+${data.standard}+explanation`;
                     videoLink = `<div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <a href="${searchUrl}" target="_blank" class="flex items-center gap-2 text-red-600 hover:text-red-800 font-bold text-sm">
                            <span>ğŸ“º</span> Watch a Video Explanation for ${data.standard}
                        </a>
                     </div>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-gray-500 text-sm">Question ${index + 1} (${data.standard})</span>
                        <span class="${isCorrect ? 'text-green-600' : 'text-red-600'} font-bold">${isCorrect ? 'Correct' : 'Incorrect'}</span>
                    </div>
                    <p class="font-semibold text-lg mb-4 text-gray-800 dark:text-gray-200">${data.question}</p>
                    
                    <div class="mb-3">
                        <p class="text-sm text-gray-500">Your Answer:</p>
                        <p class="${isCorrect ? 'text-green-700' : 'text-red-600 line-through'} font-medium">
                            ${Array.isArray(data.userAnswer) ? data.userAnswer.join(' ') : data.userAnswer}
                        </p>
                    </div>

                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-sm text-gray-700 dark:text-gray-300">
                        <span class="font-bold">ğŸ’¡ Feedback:</span> ${data.rationale}
                    </div>
                    ${videoLink}
                `;
                reviewContent.appendChild(card);
            });

            // 3. Continue Button
            const btnContainer = document.createElement('div');
            btnContainer.className = "text-center mt-8";
            btnContainer.innerHTML = `<button id="review-continue-btn" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-xl transition-transform transform hover:scale-105">Continue Adventure â¡</button>`;
            reviewContent.appendChild(btnContainer);

            document.getElementById('review-continue-btn').onclick = () => {
                navigate('welcome-screen');
            };

            navigate('review-screen');
        }

        // --- BOSS BATTLE LOGIC (The Glitch) ---
        let currentBossState = { activeBattle: null, playerHP: 3, bossHP: 3, fixedErrors: [] };
        const bossTextDisplay = document.getElementById('boss-text-display');
        const playerHpBar = document.getElementById('player-hp-bar');
        const bossHpBar = document.getElementById('boss-hp-bar');
        const editorModal = document.getElementById('editor-modal');
        const editorOptions = document.getElementById('editor-options');
        const closeEditorModal = document.getElementById('close-editor-modal');

function startBossRound() {
    // ANALYZE: What standard is the student weakest in?
    const stats = gameState.user.standardsReport || {};
    let weakestStandard = 'L.8.1'; // Default
    let lowestAccuracy = 1;

    for (const [std, data] of Object.entries(stats)) {
        const accuracy = data.correct / data.total;
        if (accuracy < lowestAccuracy) {
            lowestAccuracy = accuracy;
            weakestStandard = std;
        }
    }

    // Select a battle that matches that standard, or fallback to random
    const targetedBattle = bossBattles.find(b => b.id.includes(weakestStandard)) || bossBattles[Math.floor(Math.random() * bossBattles.length)];
    
    currentBossState.activeBattle = targetedBattle;
    currentBossState.playerHP = 3;
    currentBossState.bossHP = currentBossState.activeBattle.bossMaxHP;
    currentBossState.fixedErrors = [];
    updateHealthUI();
    renderBossPassage();
    navigate('boss-round-screen');
}

        function updateHealthUI() {
            const playerPct = (currentBossState.playerHP / 3) * 100;
            const bossPct = (currentBossState.bossHP / currentBossState.activeBattle.bossMaxHP) * 100;
            playerHpBar.style.width = `${playerPct}%`;
            bossHpBar.style.width = `${bossPct}%`;
            playerHpBar.className = playerPct < 40 ? 'bg-red-500 h-full transition-all' : 'bg-blue-500 h-full transition-all';
        }

        function renderBossPassage() {
            bossTextDisplay.innerHTML = '';
            currentBossState.activeBattle.passageParts.forEach(part => {
                const span = document.createElement('span');
                if (part.type === 'error') {
                    if (currentBossState.fixedErrors.includes(part.id)) {
                        span.textContent = part.options[part.correctIndex];
                        span.className = "boss-fixed px-1";
                    } else {
                        span.textContent = part.original;
                        span.className = "boss-error hover:bg-red-100 px-1";
                        span.onclick = () => openEditorModal(part);
                    }
                } else {
                    span.textContent = part.text;
                }
                bossTextDisplay.appendChild(span);
            });
        }
function openEditorModal(part) {
            editorOptions.innerHTML = '';
            part.options.forEach((option, index) => {
                const btn = document.createElement('button');
                // FIX: Added 'dark:hover:bg-gray-700' and 'hover:text-indigo-900' to manage contrast
                btn.className = "w-full text-left p-3 rounded border border-gray-300 dark:border-gray-600 hover:bg-indigo-50 hover:text-indigo-900 hover:border-indigo-500 dark:hover:bg-gray-700 dark:hover:text-white transition-all font-medium mb-2";
                btn.textContent = option;
                btn.onclick = () => resolveBattleAction(part, index);
                editorOptions.appendChild(btn);
            });
            editorModal.classList.remove('hidden');
        }

        closeEditorModal.onclick = () => editorModal.classList.add('hidden');

        async function resolveBattleAction(part, selectedIndex) {
            editorModal.classList.add('hidden');
            if (selectedIndex === part.correctIndex) {
                currentBossState.bossHP--;
                currentBossState.fixedErrors.push(part.id);
                playSound('correct');
                await showModal('Hit!', 'Direct hit on the Glitch! ' + part.rationale, 'success');
            } else {
                currentBossState.playerHP--;
                playSound('incorrect');
                await showModal('Ouch!', 'The Glitch counter-attacked! Wrong fix.', 'error');
            }
            updateHealthUI();
            renderBossPassage();
            checkBattleStatus();
        }

function checkBattleStatus() {
            if (currentBossState.bossHP <= 0) {
                setTimeout(async () => {
                    triggerConfetti();
                    playSound('win');
                    
                    // --- FIX: AWARD BADGE ---
                    if (!gameState.user.badges.includes('boss_slayer')) {
                        gameState.user.badges.push('boss_slayer');
                        await showModal('ğŸ† BADGE UNLOCKED!', 'You earned the <b>Glitch Hunter</b> Badge!', 'success');
                    }
                    
                    showModal('Victory!', 'You purged the Glitch! +100 XP', 'success').then(() => {
                        addXp(100);
                        navigate('welcome-screen');
                    });
                }, 500);
            } else if (currentBossState.playerHP <= 0) {
                setTimeout(() => {
                    playSound('incorrect');
                    showModal('Defeat', 'The Glitch overwhelmed you.', 'error').then(() => navigate('welcome-screen'));
                }, 500);
            }
        }

        // --- Helpers ---
        function addXp(amount) {
            gameState.user.xp += amount;
            while (gameState.user.xp >= 100) { gameState.user.xp -= 100; gameState.user.level++; }
            updateUI();
            saveProgress();
        }

function updateUI() {
            // 1. Update Standard Elements
            if(levelDisplay) levelDisplay.textContent = gameState.user.level;
            if(xpDisplay) xpDisplay.textContent = gameState.user.xp;
            if(xpBar) xpBar.style.width = `${gameState.user.xp}%`;
            if(tokenDisplay) tokenDisplay.textContent = gameState.user.tokens;
            
            // 2. Re-render badges
            if(badgesDisplay) {
                badgesDisplay.innerHTML = '';
                gameState.user.badges.forEach(bid => {
                    if(allBadges[bid]) {
                        const s = document.createElement('span'); s.className='text-3xl'; s.textContent=allBadges[bid].icon; badgesDisplay.appendChild(s);
                    }
                });
            }

            // 3. Re-render history
            if(missionHistoryBody) {
                missionHistoryBody.innerHTML = '';
                gameState.user.history.forEach(h => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="p-4">${h.missionTitle}</td><td class="p-4">${h.score}</td><td class="p-4">${h.date}</td><td class="p-4">${h.tokensEarned || 0}</td><td class="p-4">${h.xpEarned}</td>`;
                    missionHistoryBody.appendChild(tr);
                });
            }

            // 4. UPDATE CORNER STATS (The New Part)
            const mainLevel = document.getElementById('main-level-display');
            const mainXpCur = document.getElementById('main-xp-current');
            const mainXpBar = document.getElementById('main-xp-bar');
            const mainTokens = document.getElementById('main-token-display');

            if(mainLevel) mainLevel.textContent = gameState.user.level;
            if(mainXpCur) mainXpCur.textContent = gameState.user.xp;
            if(mainXpBar) mainXpBar.style.width = `${gameState.user.xp}%`; 
            if(mainTokens) mainTokens.textContent = gameState.user.tokens;
        }

        function saveProgress() { localStorage.setItem('elaGameProgress', JSON.stringify(gameState.user)); }
        function loadProgress() { 
            const saved = localStorage.getItem('elaGameProgress'); 
            if(saved) gameState.user = JSON.parse(saved); 
        }

        function resetGame() {
            localStorage.removeItem('elaGameProgress');
            gameState.user = { xp: 0, level: 1, elaLevel: 0, tokens: 0, badges: [], history: [], purchasedItems: [] };
            updateUI();
            navigate('welcome-screen');
        }

        function triggerConfetti() { if(typeof confetti !== 'undefined') confetti({ particleCount: 150, spread: 90 }); }

// --- Event Listeners ---
        document.getElementById('start-calibration-button').addEventListener('click', startCalibrationQuest);
        document.getElementById('missions-button').addEventListener('click', renderMissions);
        // Boss button listener removed (moved to renderMissions)
        
        document.getElementById('shop-button').addEventListener('click', () => { 
            // ... shop logic ...
            shopItemsList.innerHTML = '';
            shopItems.forEach(item => {
                // Check if user owns this (for permanent items)
                const isOwned = item.type === 'permanent' && gameState.user.purchasedItems.some(i => i.id === item.id);
                
                // Inventory Count (for consumables)
                const count = gameState.user.purchasedItems.filter(i => i.id === item.id).length;
                const countBadge = item.type === 'consumable' && count > 0 ? `<div class="absolute top-2 right-2 bg-white text-black font-bold px-2 py-1 rounded-full text-xs shadow">x${count} Owned</div>` : '';

                const itemDiv = document.createElement('div');
                // Make the card look cool
                itemDiv.className = `relative rounded-xl p-6 shadow-xl text-white transform transition hover:scale-105 ${item.color || 'bg-gray-500'}`;
                
                itemDiv.innerHTML = `
                    ${countBadge}
                    <h3 class="font-extrabold text-2xl mb-2 drop-shadow-md">${item.name}</h3>
                    <p class="mb-6 text-sm opacity-90 font-medium">${item.description}</p>
                    <button class="buy-btn w-full py-3 rounded-lg font-bold shadow-lg transition-colors 
                        ${isOwned ? 'bg-gray-400 cursor-not-allowed text-gray-700' : 'bg-white text-gray-900 hover:bg-gray-100'}">
                        ${isOwned ? 'OWNED' : `Buy for ${item.cost} ğŸ’°`}
                    </button>
                `;
                
                const btn = itemDiv.querySelector('.buy-btn');
                if (isOwned) {
                    btn.disabled = true;
                } else {
                    btn.onclick = () => {
                        if (gameState.user.tokens >= item.cost) {
                            // Deduct Logic
                            gameState.user.tokens -= item.cost;
                            // Add to inventory if permanent, or execute immediate action
                            if (item.type === 'permanent') {
                                gameState.user.purchasedItems.push({ id: item.id });
                            }
                            
                            // Execute Action
                            item.action();
                            
                            saveProgress();
                            updateUI();
                            
                            // Visual Feedback
                            if (item.id !== 'mystery-box') {
                                showModal('Purchase Successful!', `You bought: ${item.name}`, 'success');
                                // Refresh shop to show "Owned" or new count
                                document.getElementById('shop-button').click();
                            }
                        } else {
                            playSound('incorrect');
                            showModal('Insufficient Funds', `You need ${item.cost - gameState.user.tokens} more tokens!`, 'error');
                        }
                    };
                }
                shopItemsList.appendChild(itemDiv);
            });
            navigate('shop-screen'); 
        });

document.getElementById('progress-button').addEventListener('click', () => {
    updateUI();
    if(!gameState.user.stickers) gameState.user.stickers = [];

    const rarityMap = {
        legendary: ['ğŸ‘‘', 'ğŸ¦„', 'ğŸ²', 'ğŸ¦', 'ğŸ§›', 'ğŸ›¸'], 
        epic: ['ğŸ‰', 'ğŸ‘½', 'ğŸ°', 'âš”ï¸', 'ğŸ˜', 'ğŸ¦ˆ', 'ğŸ­'], 
        rare: ['ğŸš€', 'ğŸ›¡ï¸', 'ğŸ”®', 'ğŸ¤–', 'ğŸ¦–', 'ğŸ’', 'ğŸ”­', 'ğŸ¦Š', 'ğŸ•µï¸â€â™‚ï¸'] 
    };

    let albumHTML = '';
    for (const [key, collection] of Object.entries(stickerCollections)) {
        const ownedCount = collection.items.filter(i => gameState.user.stickers.includes(i)).length;
        const totalCount = collection.items.length;
        let grid = '';
        collection.items.forEach(s => {
            const isOwned = gameState.user.stickers.includes(s);
            if (isOwned) {
                let rarityClass = 'bg-white dark:bg-gray-700 border-2 border-gray-200';
                if (rarityMap.legendary.includes(s)) rarityClass = 'rarity-legendary';
                else if (rarityMap.epic.includes(s)) rarityClass = 'rarity-epic';
                else if (rarityMap.rare.includes(s)) rarityClass = 'rarity-rare';
                
                grid += `<div class="${rarityClass} sticker-item rounded-xl shadow-lg flex items-center justify-center h-20 w-20 mx-auto cursor-pointer transform hover:scale-110 transition" title="Sticker"><span class="text-4xl drop-shadow-md">${s}</span></div>`;
            } else {
                grid += `<div class="bg-gray-200 dark:bg-gray-800 border-2 border-dashed border-gray-400 rounded-xl flex items-center justify-center h-20 w-20 mx-auto opacity-50"><span class="text-2xl text-gray-400">?</span></div>`;
            }
        });
        albumHTML += `
            <div class="mb-8">
                <div class="flex justify-between items-end mb-3 border-b border-indigo-200 dark:border-indigo-800 pb-2">
                    <h4 class="text-lg font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">${collection.name}</h4>
                    <span class="text-sm font-mono ${ownedCount === totalCount ? 'text-green-500 font-bold' : 'text-gray-500'}">${ownedCount}/${totalCount}</span>
                </div>
                <div class="grid grid-cols-4 md:grid-cols-8 gap-4">${grid}</div>
            </div>`;
    }

    const totalXP = gameState.user.xp + ((gameState.user.level - 1) * 100);
    const allPlayers = [ ...gameState.rivals, { name: "YOU", xp: totalXP, avatar: "ğŸ˜", isPlayer: true } ];
    allPlayers.sort((a, b) => b.xp - a.xp);

    let leaderboardHTML = allPlayers.map((p, index) => {
        const rank = index + 1;
        const isMe = p.isPlayer ? "bg-indigo-100 dark:bg-indigo-900 border-indigo-500 transform scale-105" : "bg-white dark:bg-gray-700 border-transparent";
        const medal = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : `#${rank}`));
        return `
            <div class="flex items-center justify-between p-3 rounded-lg border-l-4 shadow-sm ${isMe} mb-2">
                <div class="flex items-center gap-3">
                    <span class="font-bold text-xl w-8">${medal}</span>
                    <span class="text-2xl">${p.avatar}</span>
                    <span class="font-bold ${p.isPlayer ? 'text-indigo-600 dark:text-indigo-300' : ''}">${p.name}</span>
                </div>
                <span class="font-mono font-bold text-gray-500 dark:text-gray-400">${p.xp} XP</span>
            </div>`;
    }).join('');

    const progressScreen = document.getElementById('progress-screen');
    progressScreen.innerHTML = `
        <button class="home-button absolute top-4 left-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 transition z-10">
            <svg class="w-6 h-6 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 20v-5m0 0H8m4 0h4"></path></svg>
        </button>
        <h2 class="text-3xl md:text-4xl font-bold mb-6 pl-16">My Profile & Rankings</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl border border-purple-200 dark:border-purple-900">
                <h3 class="text-xl font-bold text-purple-600 dark:text-purple-400 mb-4">ğŸ† Class Leaderboard</h3>
                <div class="max-h-60 overflow-y-auto pr-2">${leaderboardHTML}</div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl border border-yellow-200 dark:border-yellow-900">
                <h3 class="text-xl font-bold text-yellow-600 dark:text-yellow-400 mb-4">Badges & Stats</h3>
                <p class="mb-2">Total Tokens: <span class="font-bold text-yellow-500">${gameState.user.tokens} ğŸ’°</span></p>
                <div class="flex flex-wrap gap-2 mt-4">
                    ${gameState.user.badges.map(b => `<span class="text-3xl" title="${b}">${allBadges[b] ? allBadges[b].icon : 'ğŸ…'}</span>`).join('') || '<span class="text-gray-400 italic">No badges yet.</span>'}
                </div>
            </div>
        </div>

        <div class="bg-indigo-50 dark:bg-gray-900/50 rounded-3xl p-8 border-4 border-indigo-200 dark:border-indigo-800 border-dashed">
            <h3 class="text-2xl font-bold text-indigo-600 dark:text-indigo-300 mb-6 flex items-center">
                <span class="mr-2">ğŸ“’</span> Ultimate Sticker Album
            </h3>
            ${albumHTML}
        </div>
    `;
    
    // Updated: Only the Home button is attached here. The Report button is gone.
    progressScreen.querySelector('.home-button').addEventListener('click', () => navigate('welcome-screen'));
    
    navigate('progress-screen');
});

        // Helper for the report (moved out for cleaner code)
// Helper for the report (Updated with Standards Breakdown & Reteach Info)
        function generateReport() {
            const date = new Date().toLocaleDateString();
            const totalXP = gameState.user.xp + ((gameState.user.level - 1) * 100);
            
            // 1. Calculate Aggregate Stats
            const stats = gameState.user.standardsReport || {};
            let totalQ = 0;
            let totalCorrect = 0;
            let standardsRows = '';
            let reteachRows = '';

            for (const [std, data] of Object.entries(stats)) {
                totalQ += data.total;
                totalCorrect += data.correct;
                const percent = Math.round((data.correct / data.total) * 100);
                const status = percent >= 80 ? 'Mastered' : (percent >= 60 ? 'Developing' : 'Needs Focus');
                const statusColor = percent >= 80 ? '#059669' : (percent >= 60 ? '#d97706' : '#dc2626');
                
                // Add to breakdown table
                standardsRows += `
                    <tr>
                        <td><strong>${std}</strong><br><span style="font-size:11px; color:#666;">${data.desc}</span></td>
                        <td style="text-align:center;">${data.correct}/${data.total}</td>
                        <td style="text-align:center; font-weight:bold; color:${statusColor}">${percent}%</td>
                        <td style="text-align:center;"><span style="background:${statusColor}20; color:${statusColor}; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">${status.toUpperCase()}</span></td>
                    </tr>
                `;

                // Add to Reteach Section if needed
                if (percent < 70) {
                    reteachRows += `
                        <div style="background:#fef2f2; border-left:4px solid #ef4444; padding:10px; margin-bottom:10px; font-size:13px;">
                            <strong style="color:#b91c1c;">${std} - ${data.desc} (${percent}%)</strong>
                            <p style="margin:5px 0 0 0; color:#7f1d1d;">Student struggled with this concept. Recommendation: Review foundations of ${data.desc.toLowerCase()} and provide scaffolded practice examples.</p>
                        </div>
                    `;
                }
            }
            
            const overallAccuracy = totalQ > 0 ? Math.round((totalCorrect / totalQ) * 100) : 0;

            // 2. Build the Professional HTML Report
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ELA Legends - Official Student Report</title>
                    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: portrait; margin: 0.5in; }
                        body { font-family: 'Outfit', sans-serif; background: white; padding: 20px; color: #1f2937; -webkit-print-color-adjust: exact; }
                        .report-container { max-width: 800px; margin: 0 auto; border: 2px solid #3730a3; border-radius: 12px; overflow: hidden; }
                        .header { background: #3730a3; color: white; padding: 30px; text-align: center; }
                        h1 { margin: 0; font-size: 32px; text-transform: uppercase; letter-spacing: 2px; }
                        .subtitle { opacity: 0.9; font-size: 14px; margin-top: 5px; font-weight: 300; }
                        .content { padding: 30px; }
                        
                        /* Stats Grid */
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px; }
                        .stat-card { background: #f3f4f6; border-left: 4px solid #4f46e5; padding: 10px; border-radius: 0 6px 6px 0; }
                        .stat-value { font-size: 20px; font-weight: 800; color: #111827; display: block; }
                        .stat-label { font-size: 10px; text-transform: uppercase; color: #6b7280; font-weight: 600; letter-spacing: 0.5px; }

                        h3 { color: #3730a3; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; margin-top: 30px; margin-bottom: 15px; font-size: 18px; }

                        /* Tables */
                        table { width: 100%; border-collapse: collapse; font-size: 13px; }
                        th { background: #e0e7ff; color: #3730a3; padding: 8px; text-align: left; text-transform: uppercase; font-size: 11px; }
                        td { padding: 8px; border-bottom: 1px solid #e5e7eb; }
                        tr:nth-child(even) { background-color: #f9fafb; }

                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px dashed #d1d5db; display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; }
                        .signature-line { width: 200px; border-top: 1px solid #000; text-align: center; padding-top: 5px; margin-top: 30px; font-weight: bold; color: #000; }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <div class="header">
                            <h1>Student Progress Report</h1>
                            <div class="subtitle">ELA Legends Assessment Data â€¢ ${date}</div>
                        </div>

                        <div class="content">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-value">Level ${gameState.user.level}</span>
                                    <span class="stat-label">Current Rank</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-value">${overallAccuracy}%</span>
                                    <span class="stat-label">Overall Accuracy</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-value">${totalQ}</span>
                                    <span class="stat-label">Questions Answered</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-value">${gameState.user.tokens}</span>
                                    <span class="stat-label">Tokens Earned</span>
                                </div>
                            </div>

                            <h3>Performance by Standard</h3>
                            ${standardsRows ? `
                            <table>
                                <thead>
                                    <tr>
                                        <th width="40%">Standard / Category</th>
                                        <th width="20%" style="text-align:center;">Score</th>
                                        <th width="20%" style="text-align:center;">Accuracy</th>
                                        <th width="20%" style="text-align:center;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>${standardsRows}</tbody>
                            </table>` : '<p style="color:#666; font-style:italic;">No data recorded yet. Play missions to generate standards data.</p>'}

                            ${reteachRows ? `
                                <h3>Recommended Focus Areas (Reteach)</h3>
                                <div>${reteachRows}</div>
                            ` : ''}

                            <h3>Recent Mission Log</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Mission Title</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${gameState.user.history.length > 0 ? gameState.user.history.slice(-5).map(h => `
                                        <tr>
                                            <td>${h.date}</td>
                                            <td><strong>${h.missionTitle}</strong></td>
                                            <td>${h.score}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="3" style="text-align:center; padding: 10px; color: #999;">No missions completed yet.</td></tr>'}
                                </tbody>
                            </table>

                            <div class="footer">
                                <div>Generated by <strong>ELA Legends</strong></div>
                                <div><div class="signature-line">Teacher Signature</div></div>
                            </div>
                        </div>
                    </div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank', 'width=850,height=1100');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
        }
// --- NEW: GLITCH ARCHIVE & RETEACH SYSTEM ---
        function openArchive() {
            const list = document.getElementById('archive-list');
            const emptyMsg = document.getElementById('archive-empty-msg');
            list.innerHTML = '';
            
            if (!gameState.user.missedQuestions || gameState.user.missedQuestions.length === 0) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                gameState.user.missedQuestions.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border-l-8 border-red-500 relative overflow-hidden";
                    
                    // Render Options
                    let optionsHTML = '';
                    if (item.type === 'MC') {
                        optionsHTML = item.options.map(opt => 
                            `<button class="archive-opt w-full text-left p-3 mt-2 rounded border border-gray-200 dark:border-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors" onclick="checkArchiveAnswer('${item.id}', '${opt.replace(/'/g, "\\'")}', this)">${opt}</button>`
                        ).join('');
                    } else {
                        optionsHTML = `<p class="italic text-gray-400 mt-4">Hot Text questions must be re-taken inside the mission.</p>`;
                    }

                    // RETEACH BUTTON LOGIC
                    const standardKey = item.standard; // e.g., 'RI.8.1'

                    // ... inside openArchive loop ...
                    
                    // AUTO-SHOW LESSON BUTTON
                    const lessonText = skillLessons[standardKey] || "Review the text carefully.";
                    
                    // Add a "Learning" Banner
                    const lessonBanner = `
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg mb-4 border border-blue-100 dark:border-blue-800">
                            <p class="text-xs font-bold text-blue-500 uppercase mb-1">RETEACH LESSON:</p>
                            <p class="text-sm text-gray-700 dark:text-gray-300">${lessonText}</p>
                        </div>
                    `;

                    card.innerHTML = `
                        <div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg flex items-center gap-2">
                             <span>âš ï¸ CORRUPTED</span>
                        </div>
                        
                        <div class="mb-2">
                             <p class="font-bold text-gray-500 text-xs uppercase">Standard: ${item.standard || 'General'}</p>
                        </div>

                        ${lessonBanner} <p class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">${item.stem}</p>
                        <div>${optionsHTML}</div>
                    `;
                    
                    card.innerHTML = `
                        <div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg flex items-center gap-2">
                            <span>âš ï¸ CORRUPTED</span>
                        </div>
                        
                        <div class="flex justify-between items-end mb-2">
                             <p class="font-bold text-gray-500 text-xs uppercase">Standard: ${item.standard || 'General'}</p>
                             <button onclick="showLesson('${standardKey}')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200 border border-blue-300">
                                ğŸ“– Study Skill
                             </button>
                        </div>

                        <p class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">${item.stem}</p>
                        <div>${optionsHTML}</div>
                    `;
                    list.appendChild(card);
                });
            }
            navigate('archive-screen');
        }

        function showLesson(std) {
            const lesson = skillLessons[std] || "<b>General Comprehension:</b> Read the text carefully and look for evidence that directly supports your answer.";
            showModal(`Study Guide: ${std}`, lesson, 'info');
        }

        async function checkArchiveAnswer(itemId, answer, btnElement) {
            const itemIndex = gameState.user.missedQuestions.findIndex(q => q.id === itemId);
            if (itemIndex === -1) return;
            const item = gameState.user.missedQuestions[itemIndex];
            
            if (answer === item.correct_answer) {
                // SUCCESS
                playSound('correct');
                await showModal('Glitch Purged! ğŸ›¡ï¸', `Excellent work! You applied the skill correctly.<br><br><b>Why:</b> ${item.rationale}`, 'success');
                
                gameState.user.missedQuestions.splice(itemIndex, 1);
                gameState.user.tokens += 5; // Reward
                addXp(10);
                saveProgress();
                triggerConfetti();
                openArchive(); // Refresh list
            } else {
                // FAIL
                playSound('incorrect');
                btnElement.classList.add('bg-red-200', 'border-red-500', 'text-red-800');
                btnElement.disabled = true;
                btnElement.innerHTML += " âŒ";
            }
        }

// --- NEW: SURVIVAL MODE (THE GAUNTLET) ---
function startSurvival() {
            // 1. Gather ALL questions into one giant pool
            const allItems = itemBank.flatMap(zone => zone.items.map(item => ({ ...item, passage: zone.passage, sources: zone.sources })));
            // 2. Shuffle them
            gameState.survivalQueue = allItems.sort(() => Math.random() - 0.5);
            
            gameState.mode = 'survival';
            gameState.missionScore = 0;
            gameState.currentQuestionIndex = 0;
            
            // 3. Start
            navigate('game-play-screen');
            startTimer(); // <--- FIX: This starts the clock!
            renderSurvivalQuestion();
        }

function renderSurvivalQuestion() {
    if (gameState.currentQuestionIndex >= gameState.survivalQueue.length) {
        showModal('IMPOSSIBLE!', 'You have answered every single question in the database correctly. You are a Legend.', 'success');
        navigate('welcome-screen');
        return;
    }

    const currentItem = gameState.survivalQueue[gameState.currentQuestionIndex];
    
    // Header Stats
    gameTitle.innerHTML = `<span class="text-red-600">ğŸ’€ SURVIVAL MODE</span>`;
    missionScoreDisplay.innerHTML = `${gameState.missionScore} <span class="text-xs">Streak</span>`;
    missionTotalQuestions.innerHTML = "âˆ";

    // Text-to-Speech Setup
    const speakerBtn = `<button onclick="speakText('${currentItem.id}')" class="mb-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 flex items-center gap-1">ğŸ”Š Read Aloud</button>`;
    let textSource = currentItem.passage;
    const ttsContent = `<div id="tts-content-${currentItem.id}" class="hidden">${textSource.replace(/<[^>]*>/g, '')}</div>`;

    // Render Passage
    gamePassage.innerHTML = `${speakerBtn}${ttsContent}<div class="prose dark:prose-invert max-w-none">${textSource}</div>`;

    // Render Question and Options
    const options = currentItem.options;
    
    gameQuestionsArea.innerHTML = `
        <div class="mb-4">
            <p class="font-bold text-lg mb-2 text-red-500 uppercase tracking-widest">Diagnostic Level: ${currentItem.difficulty}</p>
            <p class="mb-4 text-lg font-medium">${currentItem.stem}</p>
            <div id="options-container" class="space-y-3">
                ${options.map(option => `
                    <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 cursor-pointer hover:bg-red-50 dark:hover:bg-red-900/10 transition-all">
                        <input type="radio" name="survival-q" value="${option}" class="mt-1 mr-3 w-5 h-5 text-red-600">
                        <span class="flex-1 text-base text-gray-800 dark:text-gray-200">${option}</span>
                    </label>`).join('')}
            </div>
        </div>`;

    const btnContainer = document.querySelector('#game-play-screen .flex.justify-end');
    btnContainer.innerHTML = `<button onclick="checkSurvivalAnswer('${currentItem.id}')" class="button bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg">Submit Answer</button>`;
}

async function checkSurvivalAnswer(itemId) {
    const currentItem = gameState.survivalQueue[gameState.currentQuestionIndex];
    const selected = document.querySelector('input[name="survival-q"]:checked');
    const correctAns = currentItem.correct_answer;
    
    if(!selected) return;

    if (selected.value === correctAns) {
        playSound('correct');
        gameState.missionScore++;
        gameState.currentQuestionIndex++;
        await showModal('âœ… MASTERY DEMONSTRATED', `<b>Correct!</b><br>${currentItem.rationale}`, 'success');
        renderSurvivalQuestion();
    } else {
        stopTimer();
        playSound('incorrect');
        // HIGH-LEVEL TUTORING: Providing standard-aligned feedback before game over
        await showModal('âŒ SYSTEM ERROR', `
            <div class="text-left">
                <p class="text-red-500 font-bold mb-2 uppercase tracking-tight">Incorrect Response Detected.</p>
                <p class="mb-4">The correct fix was: <b>${correctAns}</b></p>
                <div class="p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded text-xs text-indigo-900 leading-relaxed shadow-inner">
                    <p class="font-bold mb-1 underline uppercase">Standard Analysis (${currentItem.standard}):</p>
                    ${currentItem.rationale}
                </div>
                <p class="mt-4 text-[10px] text-gray-400 font-bold italic text-center uppercase">Corruption logged in Archive for required study session.</p>
            </div>
        `, 'error');
        
        gameState.user.tokens += (gameState.missionScore * 5);
        saveProgress();
        navigate('welcome-screen');
    }
}

        // --- ACCESSIBILITY: TEXT TO SPEECH ---
        function speakText(id) {
            const text = document.getElementById(`tts-content-${id}`).innerText;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9; // Slightly slower for students
            window.speechSynthesis.cancel(); // Stop previous
            window.speechSynthesis.speak(utterance);
        }

// --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProgress();
            updateUI();

            // FIX: Activate ALL Hardcoded Home Buttons
            document.querySelectorAll('.home-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigate('welcome-screen');
                });
            });

            // Activate Report Button
            const reportBtn = document.getElementById('export-report-btn');
            if(reportBtn) reportBtn.addEventListener('click', generateReport);
        });

    </script>
</body>
</html>